<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Data Explorer - NWT Government</title>
    <!-- üõ°Ô∏è COMPLETE FAVICON SET -->
    <!-- Primary shield icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <!-- Apple devices -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <!-- Windows 8/10 -->
    <meta name="msapplication-TileColor" content="#0a3b9c">
    <meta name="theme-color" content="#0a3b9c">
    <style>
        /* Windows XP/2000 Theme Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', Arial, sans-serif;
            background-color: #ece9d8;
            color: #000;
            line-height: 1.4;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #ece9d8;
            border: 2px outset #d4d0c8;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: linear-gradient(to bottom, #245edc, #424d63);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid #424d63;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            background-color: #d4d0c8;
            border-bottom: 2px solid #ffffff;
            padding: 5px 5px 0;
        }

        .tab-button {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            border: 1px solid #808080;
            border-bottom: none;
            padding: 8px 20px;
            margin-right: 5px;
            cursor: pointer;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
            color: #000;
            border-radius: 4px 4px 0 0;
            position: relative;
            top: 2px;
        }

        .tab-button:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }

        .tab-button.active {
            background: linear-gradient(to bottom, #ffffff, #d4d0c8);
            border-bottom: 2px solid #ece9d8;
            z-index: 1;
        }

        .tab-content {
            background-color: #ffffff;
            border: 1px solid #808080;
            border-top: none;
            padding: 20px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-container {
            background-color: #ffffff;
            border: 2px inset #d4d0c8;
            margin-bottom: 20px;
            padding: 20px;
        }

        .form-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            padding: 10px 15px;
            border-bottom: 1px solid #d4d0c8;
            margin-bottom: 20px;
        }

        .form-header h2 {
            font-size: 18px;
            color: #000;
        }

        .form-columns {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-column {
            background-color: #f8f8f8;
            border: 1px solid #d4d0c8;
            padding: 15px;
            border-radius: 3px;
        }

        .form-column h3 {
            background-color: #e8e8e8;
            padding: 8px 10px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid #d4d0c8;
            font-size: 16px;
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #808080;
            background-color: #ffffff;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
        }

        .form-control:focus {
            outline: 2px solid #245edc;
            border-color: #245edc;
        }

        .textarea-small {
            min-height: 80px;
            resize: vertical;
        }

        .textarea-medium {
            min-height: 100px;
            resize: vertical;
        }

        .textarea-large {
            min-height: 150px;
            resize: vertical;
        }

        .checkbox-group, .radio-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .checkbox-label, .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            cursor: pointer;
            font-size: 14px;
        }

        .small-input {
            width: 120px;
            padding: 4px 6px;
            border: 1px solid #808080;
            margin-left: 5px;
        }

        .date-input {
            width: 100px;
            padding: 4px 6px;
            border: 1px solid #808080;
            margin-left: 5px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #d4d0c8;
        }

        .btn {
            padding: 8px 20px;
            border: 1px solid #808080;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(to bottom, #245edc, #0a3b9c);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(to bottom, #3a7afc, #1a5bbc);
        }

        .btn-secondary {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            color: #000;
        }

        .btn-secondary:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }

        .table-container {
            background-color: #ffffff;
            border: 2px inset #d4d0c8;
            padding: 20px;
        }

        .table-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            padding: 10px 15px;
            border-bottom: 1px solid #d4d0c8;
            margin-bottom: 15px;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid #d4d0c8;
        }

        #requests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #requests-table thead {
            background: linear-gradient(to bottom, #245edc, #0a3b9c);
            color: white;
        }

        #requests-table th {
            padding: 10px;
            text-align: left;
            border: 1px solid #0a3b9c;
            font-weight: bold;
        }

        #requests-table tbody tr {
            border-bottom: 1px solid #d4d0c8;
        }

        #requests-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        #requests-table tbody tr:hover {
            background-color: #e8f0ff;
        }

        #requests-table td {
            padding: 8px 10px;
            border: 1px solid #d4d0c8;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .footer {
            background-color: #d4d0c8;
            padding: 10px 20px;
            text-align: center;
            border-top: 2px solid #ffffff;
            font-size: 12px;
            color: #000;
        }

        /* VBA-style validation messages */
        .validation-error {
            border: 2px solid red !important;
            background-color: #fff0f0 !important;
        }

        .validation-message {
            color: red;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }

        /* NEW: EMR Explorer Styles */
        .emr-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .emr-section {
            flex: 1;
            min-width: 300px;
            background-color: #f8f8f8;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .emr-section-header {
            background-color: #e8e8e8;
            padding: 8px 10px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid #d4d0c8;
            font-size: 16px;
            color: #000;
        }

        .schema-diagram {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 300px;
            overflow: auto;
        }

        .table-node {
            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
            border: 1px solid #808080;
            border-radius: 3px;
            padding: 8px;
            margin: 10px;
            display: inline-block;
            min-width: 150px;
            box-shadow: 2px 2px 3px rgba(0,0,0,0.1);
        }

        .table-name {
            font-weight: bold;
            color: #0a3b9c;
            border-bottom: 1px solid #d4d0c8;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .table-field {
            font-size: 12px;
            padding: 2px 0;
            font-family: 'Courier New', monospace;
        }

        .relationship-line {
            margin: 0 10px;
            color: #666;
            font-size: 12px;
        }

        .query-builder {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 200px;
        }

        .query-input {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #808080;
            padding: 8px;
            background-color: #f8f8f8;
        }

        .query-results {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .scenario-box {
            background-color: #e8f0ff;
            border: 1px solid #a0c0ff;
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .scenario-box:hover {
            background-color: #d0e0ff;
        }

        .scenario-title {
            font-weight: bold;
            color: #0a3b9c;
            margin-bottom: 5px;
        }

        .scenario-desc {
            font-size: 12px;
            color: #333;
        }

        .sql-preview {
            background-color: #2b2b2b;
            color: #f8f8f8;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .highlight {
            background-color: #ffff88;
            padding: 2px;
        }

        .table-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d4d0c8;
            padding: 10px;
        }

        .table-item {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
        }

        .table-item:hover {
            background-color: #e8f0ff;
        }

        .table-item.selected {
            background-color: #d0e0ff;
            border-left: 3px solid #0a3b9c;
        }

        @media (max-width: 1200px) {
            .form-columns {
                grid-template-columns: repeat(2, 1fr);
            }
            .emr-container {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .form-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Accordion Styles */
        .accordion {
            margin-bottom: 10px;
        }
        
        .accordion-header {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            border: 1px solid #808080;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 3px;
        }
        
        .accordion-header:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }
        
        .accordion-header.active {
            background: linear-gradient(to bottom, #ffffff, #d4d0c8);
            border-bottom: 1px solid #ffffff;
        }
        
        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(45deg); /* Plus to X */
        }
        
        .accordion-content {
            border: 1px solid #808080;
            border-top: none;
            padding: 15px;
            background-color: #ffffff;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        /* Scrollable sections */
        .scrollable-section {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #d4d0c8;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* Fixed height for query results */
        .fixed-height-results {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Compact layout */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .compact-section {
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            background: #f8f8f8;
        }

                /* Intelligence Accordion Styles */
        .intelligence-container {
            padding: 20px;
            background: #f8faff;
            border: 1px solid #a0c0ff;
            border-radius: 3px;
        }

        .intelligence-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0a3b9c;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .intelligence-section {
            background: white;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .intelligence-section h4 {
            margin-top: 0;
            color: #0a3b9c;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .request-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .request-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-item:hover {
            background: #f0f8ff;
        }

        .request-id {
            font-weight: bold;
            color: #0a3b9c;
        }

        .request-purpose {
            flex-grow: 1;
            margin: 0 15px;
            font-size: 13px;
        }

        .request-match {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: #fff8e1;
            border-left: 4px solid #FF9800;
            margin-bottom: 8px;
            border-radius: 2px;
        }

        .rec-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .rec-content {
            flex-grow: 1;
            font-size: 13px;
        }

        .intelligence-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .intelligence-container {
            padding: 20px;
            background: #f8faff;
            border: 1px solid #a0c0ff;
            border-radius: 3px;
        }

        .intelligence-section {
            background: white;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .intelligence-section h4 {
            margin-top: 0;
            color: #0a3b9c;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .request-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .request-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-item:hover {
            background: #f0f8ff;
        }

        .request-id {
            font-weight: bold;
            color: #0a3b9c;
            min-width: 100px;
        }

        .request-purpose {
            flex-grow: 1;
            margin: 0 15px;
            font-size: 13px;
        }

        .request-date {
            font-size: 12px;
            color: #666;
            min-width: 80px;
            text-align: right;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: #fff8e1;
            border-left: 4px solid #FF9800;
            margin-bottom: 8px;
            border-radius: 2px;
        }

        .rec-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .rec-content {
            flex-grow: 1;
            font-size: 13px;
        }

        .intelligence-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

    </style>
    <!-- SQL.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        // Define rebuildApiDropdown BEFORE it's used in onclick
        function rebuildApiDropdown() {
            console.log('rebuildApiDropdown function called');
            
            const select = document.getElementById('api-provider');
            if (!select) {
                console.error('‚ùå api-provider select element not found');
                alert('Error: Could not find API dropdown element');
                return;
            }
            
            const currentValue = select.value;
            console.log('üìä Current dropdown value:', currentValue);
            
            // Debug: Check character codes
            console.log('üî§ Character codes:', Array.from(currentValue).map(c => c.charCodeAt(0)));
            
            // Save all existing attributes
            const className = select.className;
            const style = select.getAttribute('style');
            const id = select.id;
            
            // Create new select element
            const newSelect = document.createElement('select');
            newSelect.id = id;
            newSelect.className = className;
            newSelect.setAttribute('style', style);
            
            // Add fresh options
            const options = [
                { value: 'DEMO', text: 'Demo Mode (Sample Data)' },
                { value: 'INFOWAY', text: 'Infoway Canada (Live SNOMED CA) üá®üá¶' },
                { value: 'SNOWSTORM', text: 'Snowstorm (Live SNOMED)' }
            ];
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                newSelect.appendChild(option);
            });
            
            // Replace old select with new one
            select.parentNode.replaceChild(newSelect, select);
            
            // Set value on new select
            if (options.some(opt => opt.value === currentValue)) {
                newSelect.value = currentValue;
            } else {
                newSelect.value = 'DEMO';
            }
            
            // Re-attach event listeners if needed
            newSelect.addEventListener('change', handleApiSelection);
            
            console.log('‚úÖ Dropdown rebuilt! New value:', newSelect.value);
            alert('Dropdown rebuilt successfully! Check console for details.');
        }

        // Also define the other functions that might be called
        function handleApiSelection() {
            const select = document.getElementById('api-provider');
            if (!select) return;
            
            const provider = select.value.trim();
            console.log('API Selected:', provider);
            
            switch(provider) {
                case 'INFOWAY':
                    console.log('Initializing Infoway API...');
                    break;
                case 'SNOWSTORM':
                    console.log('Initializing Snowstorm API...');
                    break;
                case 'DEMO':
                    console.log('Initializing Demo mode...');
                    break;
                default:
                    console.warn('Unknown provider:', provider);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - API dropdown system ready');
        });

// ================= MISSING FUNCTION DEFINITIONS =================

// 1. Fix for createDemoDatabase (called when database fails to load)
function createDemoDatabase() {
    console.log('Creating demo database...');
    
    // Create a simple in-memory database structure
    const demoData = {
        patients: [],
        observations: [],
        conditions: [],
        medications: []
    };
    
    // Store in localStorage for persistence
    localStorage.setItem('demoDatabase', JSON.stringify(demoData));
    
    console.log('‚úÖ Demo database created in localStorage');
    alert('Demo database created successfully.');
    
    return demoData;
}

// 2. Fix for setupInfowayAPI (called from API Settings button)
function setupInfowayAPI() {
    console.log('Setting up Infoway API...');
    
    const apiKeyInput = document.getElementById('infoway-api-key-input');
    if (!apiKeyInput) {
        alert('Error: API key input not found');
        return;
    }
    
    const apiKey = apiKeyInput.value.trim();
    
    if (!apiKey) {
        alert('Please enter your Infoway API key');
        return;
    }
    
    // Save to localStorage
    localStorage.setItem('infoway_api_key', apiKey);
    
    // Mask for security display
    const maskedKey = apiKey.substring(0, 6) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + apiKey.substring(apiKey.length - 4);
    
    // Show success
    const resultDiv = document.getElementById('api-test-result');
    if (resultDiv) {
        resultDiv.innerHTML = `
            <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px;">
                ‚úÖ API Key Saved! (${maskedKey})
                <div style="font-size: 11px; margin-top: 5px;">
                    Key stored in browser's localStorage. Test connection below.
                </div>
            </div>
        `;
    }
    
    // Enable test buttons
    document.querySelectorAll('button[onclick*="testAPIconnection"]').forEach(btn => {
        btn.disabled = false;
    });
    
    alert(`API key saved locally (${maskedKey})`);
}

// 3. Fix for openApiSettings (toggle the API settings panel)
function openApiSettings() {
    const panel = document.getElementById('api-setup-panel');
    if (!panel) {
        alert('API settings panel not found');
        return;
    }
    
    // Toggle visibility
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        
        // Pre-fill with saved key if exists
        const savedKey = localStorage.getItem('infoway_api_key');
        const keyInput = document.getElementById('infoway-api-key-input');
        
        if (savedKey && keyInput) {
            // Show masked version
            const maskedKey = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + savedKey.substring(savedKey.length - 4);
            keyInput.value = maskedKey;
            keyInput.type = 'text';
        }
    } else {
        panel.style.display = 'none';
    }
}

// 4. Fix for testAPIconnection
function testAPIconnection(provider) {
    console.log(`Testing ${provider} connection...`);
    
    const resultDiv = document.getElementById('api-test-result');
    if (!resultDiv) {
        alert('Result display not found');
        return;
    }
    
    // Show loading
    resultDiv.innerHTML = `
        <div style="color: #666; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px;">
            ‚è≥ Testing ${provider} connection...
        </div>
    `;
    
    // Simulate API test (replace with actual API calls)
    setTimeout(() => {
        if (provider === 'INFOWAY') {
            const apiKey = localStorage.getItem('infoway_api_key');
            if (!apiKey) {
                resultDiv.innerHTML = `
                    <div style="color: #d32f2f; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 3px;">
                        ‚ùå No API key found. Please enter your Infoway API key.
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px;">
                        ‚úÖ INFOWAY: API key configured (test successful)
                        <div style="font-size: 11px; margin-top: 5px;">
                            Note: Actual API connectivity depends on network and permissions.
                        </div>
                    </div>
                `;
            }
        } else if (provider === 'SNOWSTORM') {
            resultDiv.innerHTML = `
                <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px;">
                    ‚úÖ SNOWSTORM: Connection test passed
                    <div style="font-size: 11px; margin-top: 5px;">
                        Public Snowstorm API is accessible.
                    </div>
                </div>
            `;
        } else if (provider === 'ONTOSERVER') {
            resultDiv.innerHTML = `
                <div style="color: orange; padding: 10px; background: #fff3e0; border: 1px solid #ffe0b2; border-radius: 3px;">
                    ‚ö†Ô∏è ONTOSERVER: May require CORS proxy
                    <div style="font-size: 11px; margin-top: 5px;">
                        Direct browser access may be blocked by CORS.
                    </div>
                </div>
            `;
        }
    }, 1500);
}

// ================= DATABASE LOADER FIX =================

// Update your loadDatabase function to handle errors gracefully
async function loadDatabase() {
    console.log('Loading database...');
    
    try {
        // Try to fetch the database file
        const response = await fetch('OpenEMR_Sim.db');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        // Process the database
        const data = await response.arrayBuffer();
        console.log('Database loaded successfully:', data.byteLength, 'bytes');
        
        // Initialize your database here
        // ... existing database initialization code ...
        
    } catch (error) {
        console.error('Database load error:', error);
        
        // Fallback to demo database
        console.log('Falling back to demo database...');
        return createDemoDatabase();
    }
}

// ================= INITIALIZATION =================

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing functions...');
    
    // Check if we're running from file:// protocol
    if (window.location.protocol === 'file:') {
        console.warn('‚ö†Ô∏è Running from file:// protocol - CORS restrictions apply');
        
        // Show warning to user
        const warning = document.createElement('div');
        warning.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #fff3cd; border: 1px solid #ffecb5; color: #856404; padding: 10px; border-radius: 5px; z-index: 10000; font-size: 12px; max-width: 300px;';
        warning.innerHTML = `
            <strong>‚ö†Ô∏è Local File Warning</strong>
            <div style="margin-top: 5px;">
                For full functionality, run from a web server:<br>
                <code>python -m http.server</code>
            </div>
        `;
        document.body.appendChild(warning);
    }
    
    // Load database with error handling
    setTimeout(async () => {
        try {
            await loadDatabase();
        } catch (error) {
            console.error('Failed to load database:', error);
        }
    }, 1000);
});


        // ================= INFOWAY API KEY MANAGER =================
        const InfowayKeyManager = {
            // Check if key is saved
            hasKey: function() {
                const key = localStorage.getItem('infoway_api_key');
                return key && key.trim().length > 0;
            },
            
            // Save key from input
            saveKey: function() {
                const keyInput = document.getElementById('infoway-api-key-input');
                if (!keyInput) {
                    console.error('Key input not found');
                    alert('Error: API key input field not found');
                    return false;
                }
                
                const key = keyInput.value.trim();
                
                // Validate key
                if (!key) {
                    alert('Please enter your Infoway API key');
                    keyInput.focus();
                    return false;
                }
                
                if (key.length < 10) {
                    alert('API key appears too short. Please check and try again.');
                    keyInput.focus();
                    return false;
                }
                
                // Save to localStorage
                localStorage.setItem('infoway_api_key', key);
                console.log('API key saved to localStorage');
                
                // Update UI
                this.updateUI();
                
                // Show success message
                const maskedKey = key.substring(0, 6) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.substring(key.length - 4);
                const resultDiv = document.getElementById('api-test-result');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px; margin-top: 10px;">
                            ‚úÖ API Key Saved Successfully! (${maskedKey})
                            <div style="font-size: 11px; margin-top: 5px;">
                                Key stored in browser's localStorage. You can now use Infoway.
                            </div>
                        </div>
                    `;
                }
                
                // Clear input field for security
                keyInput.value = '';
                keyInput.type = 'password';
                
                alert('‚úÖ API key saved successfully! Infoway option is now enabled.');
                return true;
            },
            
            // Clear key
            clearKey: function() {
                if (confirm('Are you sure you want to remove your Infoway API key?')) {
                    localStorage.removeItem('infoway_api_key');
                    this.updateUI();
                    alert('API key removed.');
                }
            },
            
            // Update UI based on key status
            updateUI: function() {
                const hasKey = this.hasKey();
                
                // 1. Update Infoway dropdown option
                const infowayOption = document.querySelector('option[value="INFOWAY"]');
                if (infowayOption) {
                    if (hasKey) {
                        infowayOption.disabled = false;
                        infowayOption.style.color = '';
                        infowayOption.style.backgroundColor = '';
                        infowayOption.textContent = 'Infoway Canada (Live SNOMED CA) üá®üá¶';
                    } else {
                        infowayOption.disabled = true;
                        infowayOption.style.color = '#999';
                        infowayOption.style.backgroundColor = '#f5f5f5';
                        infowayOption.textContent = 'Infoway Canada (API Key Required) üá®üá¶';
                    }
                }
                
                // 2. Update API Settings button text
                const apiSettingsBtn = document.querySelector('button[onclick*="openApiSettings"], #api-settings-btn');
                if (apiSettingsBtn) {
                    if (hasKey) {
                        apiSettingsBtn.innerHTML = 'üîê API Settings (Configured)';
                        apiSettingsBtn.style.background = '#4CAF50';
                        apiSettingsBtn.style.color = 'white';
                    } else {
                        apiSettingsBtn.innerHTML = 'üîì API Settings';
                        apiSettingsBtn.style.background = '';
                        apiSettingsBtn.style.color = '';
                    }
                }
                
                // 3. Update input field in settings panel
                const keyInput = document.getElementById('infoway-api-key-input');
                if (keyInput) {
                    if (hasKey) {
                        const savedKey = localStorage.getItem('infoway_api_key');
                        const maskedKey = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + savedKey.substring(savedKey.length - 4);
                        keyInput.value = maskedKey;
                        keyInput.type = 'text';
                        keyInput.disabled = true;
                        keyInput.placeholder = 'API key already saved';
                    } else {
                        keyInput.value = '';
                        keyInput.type = 'password';
                        keyInput.disabled = false;
                        keyInput.placeholder = 'Enter your Infoway API key';
                    }
                }
            },
            
            // Initialize on page load
            init: function() {
                console.log('InfowayKeyManager initialized');
                this.updateUI();
                
                // Add event listener to dropdown
                const providerSelect = document.getElementById('api-provider');
                if (providerSelect) {
                    providerSelect.addEventListener('change', (e) => {
                        if (e.target.value === 'INFOWAY' && !this.hasKey()) {
                            setTimeout(() => {
                                alert('‚ö†Ô∏è Infoway API key required!\n\nPlease click "API Settings" to enter your key.');
                                e.target.value = 'DEMO'; // Revert to DEMO
                                openApiSettings(); // Open settings panel
                            }, 100);
                        }
                    });
                }
                
                // Add click handler to Save button
                const saveBtn = document.querySelector('button[onclick*="setupInfowayAPI"]');
                if (saveBtn) {
                    saveBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.saveKey();
                    });
                }
                
                // Also add direct event listener
                document.addEventListener('click', (e) => {
                    if (e.target.matches('button[onclick*="setupInfowayAPI"]')) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.saveKey();
                    }
                });
            }
        };

        // ================= SETUP INFOWAY API FUNCTION =================
        function setupInfowayAPI() {
            console.log('setupInfowayAPI called');
            return InfowayKeyManager.saveKey();
        }

        // ================= OPEN API SETTINGS FUNCTION =================
        function openApiSettings() {
            console.log('openApiSettings called');
            
            const panel = document.getElementById('api-setup-panel');
            if (!panel) {
                alert('API settings panel not found');
                return;
            }
            
            // Toggle visibility
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            // Update UI when panel opens
            if (!isVisible) {
                InfowayKeyManager.updateUI();
            }
        }

        // ================= TEST API CONNECTION =================
        function testAPIconnection(provider) {
            console.log(`Testing ${provider} connection...`);
            
            const resultDiv = document.getElementById('api-test-result');
            if (!resultDiv) {
                alert('Result display not found');
                return;
            }
            
            resultDiv.innerHTML = `
                <div style="color: #666; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; margin-top: 10px;">
                    ‚è≥ Testing ${provider} connection...
                </div>
            `;
            
            setTimeout(() => {
                if (provider === 'INFOWAY') {
                    if (!InfowayKeyManager.hasKey()) {
                        resultDiv.innerHTML = `
                            <div style="color: #d32f2f; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 3px; margin-top: 10px;">
                                ‚ùå No API key found. Please save your Infoway API key first.
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px; margin-top: 10px;">
                                ‚úÖ INFOWAY: API key configured
                                <div style="font-size: 11px; margin-top: 5px;">
                                    Note: Actual API calls will test connectivity when searching.
                                </div>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px; margin-top: 10px;">
                            ‚úÖ ${provider}: Ready to use
                        </div>
                    `;
                }
            }, 1000);
        }

        // ================= INITIALIZE ON PAGE LOAD =================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Infoway key manager...');
            InfowayKeyManager.init();
            
            // Also add manual event listener for the save button
            setTimeout(() => {
                const saveBtn = document.querySelector('button[onclick*="setupInfowayAPI"]');
                if (saveBtn) {
                    console.log('Found save button, adding click listener');
                    saveBtn.addEventListener('click', function(e) {
                        console.log('Save button clicked via event listener');
                        e.preventDefault();
                        InfowayKeyManager.saveKey();
                    });
                }
            }, 500);
        });

        // Expose functions globally
        window.setupInfowayAPI = setupInfowayAPI;
        window.openApiSettings = openApiSettings;
        window.testAPIconnection = testAPIconnection;

// ================= TEMPLATE LOADER FUNCTIONS =================

    // Main template loader function
    function loadTemplate(templateName) {
        console.log('Loading template:', templateName);
        
        // Show loading state
        const contentArea = document.getElementById('template-content-area') || 
                           document.getElementById('main-content') ||
                           document.body;
        
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'template-loading';
        loadingDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 24px;">‚è≥</div>
                <div>Loading ${templateName} template...</div>
            </div>
        `;
        
        // Clear previous content and show loading
        if (contentArea.id === 'template-content-area') {
            contentArea.innerHTML = '';
            contentArea.appendChild(loadingDiv);
        } else {
            // Create a dedicated area if it doesn't exist
            let templateArea = document.getElementById('template-content-area');
            if (!templateArea) {
                templateArea = document.createElement('div');
                templateArea.id = 'template-content-area';
                contentArea.appendChild(templateArea);
            }
            templateArea.innerHTML = '';
            templateArea.appendChild(loadingDiv);
        }
        
        // Load the template based on name
        setTimeout(() => {
            loadTemplateContent(templateName);
        }, 300);
    }

    // Load specific template content
    function loadTemplateContent(templateName) {
        console.log('Loading content for:', templateName);
        
        const templateArea = document.getElementById('template-content-area');
        if (!templateArea) {
            console.error('Template area not found');
            return;
        }
        
        // Define template content
        const templates = {
            'diabetes': {
                title: 'Diabetes Management Template',
                content: `
                    <div style="padding: 20px;">
                        <h2>üìã Diabetes Management Plan</h2>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <h3>üéØ Management Goals</h3>
                            <ul>
                                <li><strong>A1C Target:</strong> < 7.0% for most adults</li>
                                <li><strong>Blood Pressure:</strong> < 130/80 mmHg</li>
                                <li><strong>LDL Cholesterol:</strong> < 100 mg/dL</li>
                                <li><strong>Annual Eye Exam</strong></li>
                                <li><strong>Annual Foot Exam</strong></li>
                            </ul>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3>üíä Common Medications</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>Metformin</strong><br>
                                    <small>First-line therapy</small>
                                </div>
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>Insulin</strong><br>
                                    <small>Various formulations</small>
                                </div>
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>GLP-1 RAs</strong><br>
                                    <small>e.g., Semaglutide</small>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="saveTemplate('diabetes')" 
                                style="padding: 10px 20px; background: #0a3b9c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            üíæ Save This Template
                        </button>
                    </div>
                `
            },
            'hypertension': {
                title: 'Hypertension Management Template',
                content: `
                    <div style="padding: 20px;">
                        <h2>üìã Hypertension Management Plan</h2>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <h3>üéØ Blood Pressure Targets</h3>
                            <ul>
                                <li><strong>General Target:</strong> < 130/80 mmHg</li>
                                <li><strong>Diabetes/CRD:</strong> < 130/80 mmHg</li>
                                <li><strong>Elderly:</strong> < 130/80 mmHg (if tolerated)</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3>üíä First-line Medications</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>ACE Inhibitors</strong><br>
                                    <small>e.g., Lisinopril</small>
                                </div>
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>ARBs</strong><br>
                                    <small>e.g., Losartan</small>
                                </div>
                                <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                                    <strong>CCBs</strong><br>
                                    <small>e.g., Amlodipine</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'medication-review': {
                title: 'Medication Review Template',
                content: `
                    <div style="padding: 20px;">
                        <h2>üìã Comprehensive Medication Review</h2>
                        
                        <div style="background: #fff3e0; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <h3>üîç Review Checklist</h3>
                            <ul>
                                <li>‚úÖ Indication for each medication</li>
                                <li>‚úÖ Effectiveness monitoring</li>
                                <li>‚úÖ Safety (side effects, interactions)</li>
                                <li>‚úÖ Adherence assessment</li>
                                <li>‚úÖ Cost considerations</li>
                                <li>‚úÖ Deprescribing opportunities</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3>üìù Assessment Form</h3>
                            <textarea id="med-review-notes" 
                                      style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 3px;"
                                      placeholder="Enter medication review notes..."></textarea>
                        </div>
                    </div>
                `
            },
            'default': {
                title: 'Clinical Template',
                content: `
                    <div style="padding: 20px; text-align: center;">
                        <h2>üìã Clinical Decision Support</h2>
                        <p>Select a template from the buttons above.</p>
                        <div style="color: #666; margin-top: 20px;">
                            üí° Tip: Templates help standardize clinical documentation and decision-making.
                        </div>
                    </div>
                `
            }
        };
        
        // Get template or use default
        const template = templates[templateName] || templates['default'];
        
        // Display the template
        templateArea.innerHTML = `
            <div style="background: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="background: #0a3b9c; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                    <h3 style="margin: 0;">${template.title}</h3>
                </div>
                ${template.content}
            </div>
        `;
        
        // Log action
        console.log(`Template "${templateName}" loaded successfully`);
    }

    // Save template function
    function saveTemplate(templateName) {
        console.log('Saving template:', templateName);
        
        // Get the current template content
        const templateArea = document.getElementById('template-content-area');
        if (!templateArea) return;
        
        const content = templateArea.innerHTML;
        
        // Save to localStorage
        localStorage.setItem(`template_${templateName}_${Date.now()}`, content);
        
        alert(`‚úÖ Template "${templateName}" saved locally!`);
        
        // Update saved templates list if it exists
        updateSavedTemplatesList();
    }

    // Update saved templates list
    function updateSavedTemplatesList() {
        const savedList = document.getElementById('saved-templates-list');
        if (!savedList) return;
        
        // Clear current list
        savedList.innerHTML = '';
        
        // Get all saved templates from localStorage
        const savedTemplates = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('template_')) {
                savedTemplates.push({
                    key: key,
                    name: key.replace('template_', '').split('_')[0],
                    timestamp: parseInt(key.split('_').pop()) || 0
                });
            }
        }
        
        // Sort by timestamp (newest first)
        savedTemplates.sort((a, b) => b.timestamp - a.timestamp);
        
        // Display list
        if (savedTemplates.length === 0) {
            savedList.innerHTML = '<div style="color: #666; padding: 10px;">No saved templates yet.</div>';
            return;
        }
        
        savedTemplates.forEach(template => {
            const date = new Date(template.timestamp).toLocaleString();
            const item = document.createElement('div');
            item.style.cssText = 'padding: 8px; margin: 5px 0; background: #f9f9f9; border: 1px solid #ddd; border-radius: 3px;';
            item.innerHTML = `
                <strong>${template.name}</strong>
                <div style="font-size: 11px; color: #666;">Saved: ${date}</div>
                <div style="margin-top: 5px;">
                    <button onclick="loadSavedTemplate('${template.key}')" 
                            style="padding: 3px 8px; font-size: 11px; background: #0a3b9c; color: white; border: none; border-radius: 2px; margin-right: 5px;">
                        Load
                    </button>
                    <button onclick="deleteTemplate('${template.key}')" 
                            style="padding: 3px 8px; font-size: 11px; background: #f44336; color: white; border: none; border-radius: 2px;">
                        Delete
                    </button>
                </div>
            `;
            savedList.appendChild(item);
        });
    }

    // Load saved template
    function loadSavedTemplate(templateKey) {
        const content = localStorage.getItem(templateKey);
        if (!content) {
            alert('Template not found');
            return;
        }
        
        const templateArea = document.getElementById('template-content-area');
        if (!templateArea) return;
        
        templateArea.innerHTML = content;
        console.log('Loaded saved template:', templateKey);
    }

    // Delete template
    function deleteTemplate(templateKey) {
        if (confirm('Are you sure you want to delete this template?')) {
            localStorage.removeItem(templateKey);
            updateSavedTemplatesList();
            alert('Template deleted.');
        }
    }

    // Initialize templates on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Template system initialized');
        
        // Update saved templates list if it exists
        setTimeout(updateSavedTemplatesList, 1000);
    });

    // Make functions available globally
    window.loadTemplate = loadTemplate;
    window.saveTemplate = saveTemplate;
    window.loadSavedTemplate = loadSavedTemplate;
    window.deleteTemplate = deleteTemplate;
    
// ================= SQL TEMPLATE LOADER =================

function loadTemplate(templateName) {
    console.log('Loading SQL template:', templateName);
    
    // Find the SQL input/textarea - adjust this selector based on your actual HTML
    const sqlInput = document.getElementById('sqlQuery') || 
                     document.getElementById('queryInput') ||
                     document.querySelector('textarea[name="sql"]') ||
                     document.querySelector('textarea[placeholder*="SQL"]') ||
                     document.querySelector('.sql-editor');
    
    if (!sqlInput) {
        console.error('Could not find SQL input field');
        alert('Error: Could not find SQL editor. Please check the page structure.');
        return;
    }
    
    // Define SQL templates
    const templates = {
        'select_all': {
            name: 'Select All',
            sql: `SELECT * FROM patients\nWHERE discharge_date IS NULL\nORDER BY admission_date DESC\nLIMIT 100;`,
            description: 'Select all records from a table with basic filtering'
        },
        'count': {
            name: 'Count Records',
            sql: `SELECT COUNT(*) as total_count,\n       COUNT(DISTINCT patient_id) as unique_patients\nFROM encounters\nWHERE visit_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY);`,
            description: 'Count records with date filtering'
        },
        'join': {
            name: 'Basic JOIN',
            sql: `SELECT \n    p.patient_id,\n    p.first_name,\n    p.last_name,\n    e.encounter_date,\n    e.diagnosis_code,\n    d.description\nFROM patients p\nJOIN encounters e ON p.patient_id = e.patient_id\nLEFT JOIN diagnoses d ON e.diagnosis_code = d.code\nWHERE e.encounter_date >= '2024-01-01'\nORDER BY e.encounter_date DESC;`,
            description: 'Join patients with encounters and diagnoses'
        },
        'insert': {
            name: 'INSERT Template',
            sql: `INSERT INTO medications (\n    patient_id,\n    medication_name,\n    dosage,\n    frequency,\n    start_date,\n    prescribed_by\n) VALUES (\n    :patient_id,\n    :medication_name,\n    :dosage,\n    :frequency,\n    CURDATE(),\n    :prescriber\n);`,
            description: 'Insert new medication record'
        },
        'update': {
            name: 'UPDATE Template',
            sql: `UPDATE patients\nSET \n    last_visit = CURDATE(),\n    insurance_status = :new_status,\n    updated_at = NOW()\nWHERE patient_id = :patient_id\nAND active = 1;`,
            description: 'Update patient information'
        },
        'aggregate': {
            name: 'Aggregate Query',
            sql: `SELECT \n    diagnosis_code,\n    COUNT(*) as case_count,\n    AVG(length_of_stay) as avg_stay,\n    MIN(admission_date) as first_case,\n    MAX(admission_date) as last_case\nFROM encounters\nWHERE discharge_date IS NOT NULL\nGROUP BY diagnosis_code\nHAVING COUNT(*) > 5\nORDER BY case_count DESC;`,
            description: 'Aggregate statistics with grouping'
        },
        'subquery': {
            name: 'Subquery Example',
            sql: `SELECT \n    p.first_name,\n    p.last_name,\n    p.date_of_birth,\n    (\n        SELECT COUNT(*)\n        FROM encounters e\n        WHERE e.patient_id = p.patient_id\n        AND YEAR(e.encounter_date) = YEAR(CURDATE())\n    ) as visits_this_year\nFROM patients p\nWHERE p.active = 1\nORDER BY visits_this_year DESC;`,
            description: 'Use subquery to count related records'
        }
    };
    
    // Get the template
    const template = templates[templateName];
    
    if (!template) {
        console.error('Template not found:', templateName);
        alert(`Template "${templateName}" not found. Available templates: ${Object.keys(templates).join(', ')}`);
        return;
    }
    
    // Set the SQL value
    if (sqlInput.tagName === 'TEXTAREA' || sqlInput.tagName === 'INPUT') {
        sqlInput.value = template.sql;
        
        // Trigger change event if needed
        sqlInput.dispatchEvent(new Event('input', { bubbles: true }));
        sqlInput.dispatchEvent(new Event('change', { bubbles: true }));
    } else {
        // For contenteditable or other elements
        sqlInput.textContent = template.sql;
    }
    
    // Focus the input
    sqlInput.focus();
    
    // Show success notification
    showTemplateNotification(template);
    
    console.log(`SQL template "${templateName}" loaded successfully`);
}

function showTemplateNotification(template) {
    // Remove any existing notification
    const existingNote = document.getElementById('template-notification');
    if (existingNote) existingNote.remove();
    
    // Create notification
    const notification = document.createElement('div');
    notification.id = 'template-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
        font-family: monospace;
    `;
    
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
            ‚úÖ Loaded: ${template.name}
        </div>
        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
            ${template.description}
        </div>
        <div style="font-size: 11px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 3px; margin-top: 5px; overflow: auto; max-height: 100px;">
            <pre style="margin: 0; white-space: pre-wrap;">${template.sql}</pre>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// ================= ADD MORE TEMPLATE BUTTONS =================

// Optional: Function to add template buttons dynamically
function addTemplateButtons() {
    const templateContainer = document.querySelector('.form-group label:contains("Quick Templates")')?.parentElement;
    
    if (!templateContainer) return;
    
    const templates = [
        { id: 'insert', label: 'INSERT template' },
        { id: 'update', label: 'UPDATE template' },
        { id: 'aggregate', label: 'Aggregate query' },
        { id: 'subquery', label: 'Subquery example' }
    ];
    
    templates.forEach(template => {
        const button = document.createElement('button');
        button.className = 'btn btn-secondary';
        button.style.cssText = 'font-size: 12px; text-align: left; margin-top: 5px;';
        button.textContent = template.label;
        button.onclick = () => loadTemplate(template.id);
        
        // Find the button container
        const buttonContainer = templateContainer.querySelector('div[style*="flex-direction: column"]');
        if (buttonContainer) {
            buttonContainer.appendChild(button);
        }
    });
}

// ================= INITIALIZE =================

document.addEventListener('DOMContentLoaded', function() {
    console.log('SQL Template system initialized');
    
    // Optional: Add more template buttons
    setTimeout(addTemplateButtons, 1000);
    
    // Add keyboard shortcuts for templates
    document.addEventListener('keydown', function(e) {
        // Ctrl+1 for select_all, Ctrl+2 for count, etc.
        if (e.ctrlKey && !e.altKey && !e.shiftKey) {
            const templates = {
                '1': 'select_all',
                '2': 'count',
                '3': 'join',
                '4': 'insert',
                '5': 'update',
                '6': 'aggregate',
                '7': 'subquery'
            };
            
            if (templates[e.key]) {
                e.preventDefault();
                loadTemplate(templates[e.key]);
            }
        }
    });
});

// Make function globally available
window.loadTemplate = loadTemplate;


    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Info Management Task Utility & Decision Support</h1>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-button active" data-tab="form-tab">Data Request Analysis</button>
                <button class="tab-button" data-tab="knowledge-tab">Knowledge Management</button>
                <button class="tab-button" data-tab="dashboard-tab">Dashboard</button>
                <button class="tab-button" data-tab="emr-tab">EMR Data Explorer</button>
            </div>

            <div class="tab-content">
            <!-- FORM TAB -->
            <div id="form-tab" class="tab-pane active">
                
                <!-- ================= ACCORDION 1: DATA REQUEST FORM ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="data-request">
                        <span>üìã Data Request Form</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-data-request">
                        <div class="form-container">
                            <div class="form-header">
                                <h2>Data Request Form</h2>
                            </div>
                            
                            <div class="form-columns">
                                <!-- COLUMN 1 -->
                                <div class="form-column">
                                    <h3>Request Information</h3>
                                    
                                    <div class="form-group">
                                        <label>Data Request Identification:</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="dhss" class="org-checkbox">
                                                DHSS
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="hssa" class="org-checkbox">
                                                HSSA
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="other-org" class="org-checkbox">
                                                Other:
                                            </label>
                                            <input type="text" id="other-org-text" placeholder="Specify" class="small-input">
                                        </div>
                                        <input type="hidden" id="organization" value="">
                                        <div class="validation-message" id="org-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="request-number">Data Request Number:</label>
                                        <input type="text" id="request-number" class="form-control" required>
                                        <div class="validation-message" id="reqnum-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="requestor">Data Requestor's Name/Org:</label>
                                        <input type="text" id="requestor" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="classification">
                                            Data Request Classification:
                                            <span class="help-bubble" onclick="showClassificationHelp()" 
                                                  style="cursor: help; 
                                                         background: #0a3b9c; 
                                                         color: white; 
                                                         width: 18px; 
                                                         height: 18px; 
                                                         border-radius: 50%; 
                                                         display: inline-flex; 
                                                         align-items: center; 
                                                         justify-content: center; 
                                                         margin-left: 8px; 
                                                         font-weight: bold;
                                                         font-size: 12px;
                                                         vertical-align: middle;">?</span>
                                        </label>
                                        <input type="text" id="classification" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label>Data Request History:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="request-history" value="first" checked>
                                                Request is first original
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="request-history" value="recurring">
                                                Request occurred in past submitted on:
                                                <input type="text" id="recurring-date" placeholder="yyyy-mm-dd" class="date-input">
                                            </label>
                                        </div>
                                        <div class="validation-message" id="history-error"></div>
                                    </div>
                                </div>

                                
                                <!-- COLUMN 2 -->
                                <div class="form-column">
                                    <h3>Legal & Conditions</h3>
                                    
                                    <div class="form-group">
                                        <label>Legislative Authority:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="legislative" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="legislative" value="no">
                                                No
                                            </label>
                                        </div>
                                        <div class="validation-message" id="legislative-error"></div>
                                        <label for="legislative-desc">If Yes, describe authority:</label>
                                        <textarea id="legislative-desc" class="form-control textarea-small" rows="4"></textarea>
                                        <div class="validation-message" id="legdesc-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label>Conditions / Client Instructions:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="conditions" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="conditions" value="no">
                                                No
                                            </label>
                                        </div>
                                        <label for="conditions-desc">If Yes, describe conditions:</label>
                                        <input type="text" id="conditions-desc" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label>Location:</label>
                                        <label for="region">Region:</label>
                                        <select id="region" class="form-control">
                                            <option value="">Select Region</option>
                                            <option value="Beaufort Delta Region">Beaufort Delta Region</option>
                                            <option value="Dehcho Region">Dehcho Region</option>
                                            <option value="Sahtu Region">Sahtu Region</option>
                                            <option value="South Slave Region">South Slave Region</option>
                                            <option value="T≈ÇƒØch«´ Region">T≈ÇƒØch«´ Region</option>
                                            <option value="Yellowknife Region">Yellowknife Region</option>
                                        </select>
                                        
                                        <label for="district">District:</label>
                                        <select id="district" class="form-control" disabled>
                                            <option value="">Select District</option>
                                        </select>
                                        <div class="validation-message" id="location-error"></div>
                                    </div>
                                </div>

                                <!-- COLUMN 3 -->
                                <div class="form-column">
                                    <h3>Purpose & Agreements</h3>
                                    
                                    <div class="form-group">
                                        <label for="defined-purpose">
                                            Defined Purpose:
                                            <span class="help-bubble" onclick="showPurposeHelp()" 
                                                  style="cursor: help; 
                                                         background: #0a3b9c; 
                                                         color: white; 
                                                         width: 18px; 
                                                         height: 18px; 
                                                         border-radius: 50%; 
                                                         display: inline-flex; 
                                                         align-items: center; 
                                                         justify-content: center; 
                                                         margin-left: 8px; 
                                                         font-weight: bold;
                                                         font-size: 12px;
                                                         vertical-align: middle;">?</span>
                                        </label>
                                        <textarea id="defined-purpose" class="form-control textarea-medium" rows="5" required></textarea>
                                        <div class="validation-message" id="purpose-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label>Statutory Owner:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="statutory" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="statutory" value="no">
                                                No
                                            </label>
                                        </div>
                                        <div class="validation-message" id="statutory-error"></div>
                                        
                                        <label>If Yes, identify statutory appointment:</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="statutory-option" value="Director, Medical Insurance">
                                                Director, Medical Insurance
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="statutory-option" value="Registrar, Vital Statistics">
                                                Registrar, Vital Statistics
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="statutory-option" value="Registrar, Professional Licensing">
                                                Registrar, Professional Licensing
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="statutory-option" value="Chief Public Health Officer">
                                                Chief Public Health Officer
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="statutory-option" value="Other">
                                                Other
                                            </label>
                                        </div>
                                        
                                        <label for="statutory-other">If Other, describe:</label>
                                        <input type="text" id="statutory-other" class="form-control">
                                    </div>
                                </div>

                                <!-- COLUMN 4 -->
                                <div class="form-column">
                                    <h3>Data & Meetings</h3>
                                    
                                    <div class="form-group">
                                        <label>Agreement Requirement:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="agreement" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="agreement" value="no">
                                                No
                                            </label>
                                        </div>
                                        <div class="validation-message" id="agreement-error"></div>
                                        
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="existing-agreement">
                                            Existing Agreement: Yes
                                        </label>
                                        
                                        <label for="agreement-desc">Agreement Details:</label>
                                        <input type="text" id="agreement-desc" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label>Data Matching:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="matching" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="matching" value="no">
                                                No
                                            </label>
                                        </div>
                                        <div class="validation-message" id="matching-error"></div>
                                        
                                        <label for="matching-desc">Describe Data Matching:</label>
                                        <input type="text" id="matching-desc" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label>Meeting Requirement:</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="meeting" value="yes">
                                                Yes
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="meeting" value="no">
                                                No
                                            </label>
                                        </div>
                                        <div class="validation-message" id="meeting-error"></div>
                                        
                                        <label for="meeting-desc">Meeting Details:</label>
                                        <input type="text" id="meeting-desc" class="form-control">
                                    </div>

                                    <!-- NEW: Data Type Specification Textarea with help -->
                                    <div class="form-group">
                                        <label for="data-type-spec">
                                            Data Type Specification:
                                            <span class="help-bubble" onclick="showDataTypeHelp()" 
                                                  style="cursor: help; 
                                                         background: #0a3b9c; 
                                                         color: white; 
                                                         width: 18px; 
                                                         height: 18px; 
                                                         border-radius: 50%; 
                                                         display: inline-flex; 
                                                         align-items: center; 
                                                         justify-content: center; 
                                                         margin-left: 8px; 
                                                         font-weight: bold;
                                                         font-size: 12px;
                                                         vertical-align: middle;">?</span>
                                        </label>
                                        <textarea id="data-type-spec" class="form-control textarea-small" rows="4" 
                                                  placeholder="Specify data elements, formats, and technical requirements..."></textarea>
                                    </div>

                                    <!-- NEW: Data Request Frequency Textarea with help -->
                                    <div class="form-group">
                                        <label for="data-request-frequency">
                                            Data Request Frequency:
                                            <span class="help-bubble" onclick="showFrequencyHelp()" 
                                                  style="cursor: help; 
                                                         background: #0a3b9c; 
                                                         color: white; 
                                                         width: 18px; 
                                                         height: 18px; 
                                                         border-radius: 50%; 
                                                         display: inline-flex; 
                                                         align-items: center; 
                                                         justify-content: center; 
                                                         margin-left: 8px; 
                                                         font-weight: bold;
                                                         font-size: 12px;
                                                         vertical-align: middle;">?</span>
                                        </label>
                                        <textarea id="data-request-frequency" class="form-control textarea-small" rows="4"
                                                  placeholder="Specify frequency: One-time, Daily, Weekly, Monthly, Quarterly, Annually..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="comments">Additional Comments:</label>
                                        <textarea id="comments" class="form-control textarea-small" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-buttons">
                                <button id="save-btn" class="btn btn-primary">Save Request</button>
                                <button id="clear-btn" class="btn btn-secondary">Clear Form</button>
                                <button id="refresh-btn" class="btn btn-secondary">Refresh Table</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================= ACCORDION 2: REQUEST INTELLIGENCE ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="request-intelligence">
                        <span>üí° Request Intelligence & Recommendations</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-request-intelligence">
                        <div class="intelligence-container">
                            
                            <!-- Real-time Analysis Status -->
                            <div class="intelligence-status">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <strong>Analysis Status:</strong>
                                        <span id="analysis-status" style="margin-left: 10px; color: #666;">Ready to analyze</span>
                                    </div>
                                    <button onclick="analyzeCurrentForm()" class="btn btn-primary btn-sm">
                                        üîç Analyze This Request
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Row 1: Similarity Results -->
                            <div class="intelligence-section">
                                <h4>üìö Similar Historical Requests</h4>
                                <div id="similar-requests-container" class="request-list">
                                    <div class="empty-state" id="no-similar-requests">
                                        <div style="text-align: center; padding: 20px; color: #999;">
                                            <div style="font-size: 36px;">üîç</div>
                                            <div>No similar requests found yet</div>
                                            <div style="font-size: 12px; margin-top: 10px;">
                                                Start typing in the form above, then click "Analyze This Request"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 2: Data Source Recommendations -->
                            <div class="intelligence-section">
                                <h4>üóÉÔ∏è Data Source Recommendations</h4>
                                <div id="data-source-recommendations">
                                    <div class="empty-state" style="text-align: center; padding: 10px; color: #999; font-size: 13px;">
                                        Based on your request purpose, recommended data sources will appear here
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 3: Compliance Guidance -->
                            <div class="intelligence-section">
                                <h4>‚öñÔ∏è Compliance Guidance</h4>
                                <div id="compliance-guidance">
                                    <div class="empty-state" style="text-align: center; padding: 10px; color: #999; font-size: 13px;">
                                        Legislative and compliance recommendations based on similar requests
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 4: Quick Actions -->
                            <div class="intelligence-actions">
                                <button onclick="findSimilarRequests()" class="btn btn-secondary">
                                    üîÑ Find Similar Requests
                                </button>
                                <button onclick="generateRequestReport()" class="btn btn-secondary">
                                    üìã Generate Request Report
                                </button>
                                <button onclick="clearIntelligence()" class="btn btn-secondary">
                                    üóëÔ∏è Clear Analysis
                                </button>
                            </div>
                            
                            <!-- Intelligence Footer -->
                            <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Powered by your actual request database</span>
                                    <span id="intelligence-last-run">Never run</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================= ACCORDION 3: REQUEST SUMMARY TABLE ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="request-results">
                        <span>üìä Request Summary Table</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-request-results">
                        <div class="table-container">
                            <div class="table-header">
                                <h2>Request Summary Table</h2>
                            </div>
                            <div class="table-wrapper">
                                <table id="requests-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Request Number</th>
                                            <th>Organization</th>
                                            <th>Legislative Authority</th>
                                            <th>Defined Purpose</th>
                                            <th>Timestamp</th>
                                            <th>Location</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-body">
                                        <!-- Table rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================= ACCORDION 4: DASHBOARD TRACKING ================= -->
            <div class="accordion">
                <div class="accordion-header" data-accordion="dashboard-tracking">
                    <span>üìä Dashboard Tracking (Optional)</span>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content" id="accordion-dashboard-tracking">
                    <div style="padding: 15px; background: #f8f8f8; border-radius: 3px;">
                        <p style="margin-top: 0; color: #666; font-size: 14px;">
                            <strong>Optional:</strong> Fill these only if you want dashboard analytics.
                            These fields are hidden from the main table.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="form-group">
                                <label for="date-received">Date Received:</label>
                                <input type="date" id="date-received" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="date-completed">Date Completed:</label>
                                <input type="date" id="date-completed" class="form-control">
                            </div>

                            <div class="form-group">
                                <label>Request Status:</label>
                                <select id="request-status" class="form-control">
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            </div> <!-- End form-tab -->

            <!-- KNOWLEDGE TAB -->
            <div id="knowledge-tab" class="tab-pane">
                <!-- ================= ACCORDION 1: TERMINOLOGY MAPPER ================= -->
                <div class="accordion">
                    <div class="accordion-header active" data-accordion="spec-tool">
                        <span>üìã Data Specification Tool (FHIR/SNOMED Mapper)</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content active" id="accordion-spec-tool">
                        <!-- Two-column layout for the spec tool -->
                        <div style="padding: 10px;">
                            <!-- LEFT SIDEBAR - Tree Navigation -->
                            <aside style="width: 350px; background: #e8f0ff; border: 1px solid #a0c0ff; border-radius: 3px; display: flex; flex-direction: column; padding: 15px; float: left; margin-right: 15px;">
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: #0a3b9c; margin-bottom: 10px;">NWT Terminology Navigator</h3>
                                    
                                    <!-- SEARCH BOX WITH BUTTON -->
                                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                        <input type="text" 
                                               id="treeSearch" 
                                               class="form-control" 
                                               placeholder="Search SNOMED/FHIR..."
                                               style="flex-grow: 1; padding: 8px;">
                                        <button onclick="searchTerminology()" 
                                                class="btn btn-primary"
                                                style="padding: 8px 15px; white-space: nowrap;">
                                            Search
                                        </button>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                        Search real terminology servers or use demo data
                                    </div>

                                    <!-- API Key Entry Modal -->
                                    <div id="api-key-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                                        <div style="background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%;">
                                            <h3>üîê Enter Infoway API Key</h3>
                                            <p style="margin: 10px 0 20px 0; color: #666; font-size: 14px;">
                                                Your API key is required to use Infoway Canada services.
                                                <strong style="color: #d32f2f;">This key is stored ONLY in your browser.</strong>
                                            </p>
                                            
                                            <div style="margin-bottom: 20px;">
                                                <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">
                                                    API Key:
                                                </label>
                                                <input type="password" 
                                                       id="infoway-api-key" 
                                                       placeholder="Enter your Infoway API key"
                                                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;">
                                                
                                                <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                                    üí° You should have received this key via email from Infoway Canada
                                                </div>
                                            </div>
                                            
                                            <div style="display: flex; gap: 10px; margin-top: 25px;">
                                                <button onclick="saveApiKey()" 
                                                        style="flex: 1; padding: 12px; background: #0a3b9c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                    Save & Continue
                                                </button>
                                                <button onclick="useDemoMode()" 
                                                        style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                                                    Use Demo Mode
                                                </button>
                                            </div>
                                            
                                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffecb5;">
                                                <strong>‚ö†Ô∏è Security Notice:</strong>
                                                <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px;">
                                                    <li>Your API key is stored locally in your browser only</li>
                                                    <li>Never share your API key with others</li>
                                                    <li>For production use, implement a backend proxy</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- API SELECTOR -->
                                    <!-- API SELECTOR -->
                                    <!-- API SELECTOR SECTION -->
                                    <!-- API SETTINGS PANEL -->
                                    <div id="api-setup-panel" style="display: none; padding: 20px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; margin: 15px 0;">
                                        <h4 style="color: #0a3b9c; margin-bottom: 20px;">
                                            üîê Infoway Terminology Server Setup
                                        </h4>
                                        
                                        <div style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 4px;">
                                            <strong>‚ÑπÔ∏è You will need:</strong>
                                            <ul style="margin: 8px 0 0 20px; font-size: 12px;">
                                                <li>Client ID (from email)</li>
                                                <li>Client Secret (from encrypted zip)</li>
                                                <li>Phone number (password for zip file)</li>
                                            </ul>
                                        </div>
                                        
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">
                                                Client ID:
                                            </label>
                                            <input type="text" 
                                                   id="infoway-client-id" 
                                                   placeholder="e.g., ihc_client_12345"
                                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 15px;">
                                            
                                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">
                                                Client Secret:
                                            </label>
                                            <input type="password" 
                                                   id="infoway-client-secret" 
                                                   placeholder="Enter your Client Secret"
                                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                            
                                            <div style="font-size: 11px; color: #666; margin-top: 8px;">
                                                üí° Check your email for Client ID and encrypted zip with Client Secret
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button id="save-infoway-btn"
                                                    style="padding: 10px 20px; background: #0a3b9c; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">
                                                üíæ Save Credentials
                                            </button>
                                            
                                            <button id="test-infoway-btn"
                                                    style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">
                                                üîó Test Connection
                                            </button>
                                            
                                            <button id="clear-infoway-btn"
                                                    style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">
                                                üóëÔ∏è Clear
                                            </button>
                                        </div>
                                        
                                        <div id="api-test-result" style="margin-top: 15px;"></div>
                                        
                                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffecb5;">
                                            <strong>üìå Important Notes:</strong>
                                            <ul style="margin: 8px 0 0 20px; font-size: 11px;">
                                                <li>Credentials are stored only in your browser</li>
                                                <li>Access tokens auto-refresh when expired</li>
                                                <li>First setup may take a moment for OAuth2 authentication</li>
                                                <li>Need help? Contact: terminology@infoway-inforoute.ca</li>
                                            </ul>
                                        </div>
                                    </div>

                                    
                                    <!-- QUICK SEARCH BUTTONS -->
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">Quick Searches:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                            <button onclick="quickSearch('diabetes')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Diabetes
                                            </button>
                                            <button onclick="quickSearch('hypertension')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Hypertension
                                            </button>
                                            <button onclick="quickSearch('cancer')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Cancer
                                            </button>
                                            <button onclick="quickSearch('vaccine')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Vaccine
                                            </button>
                                            <button onclick="quickSearch('pregnancy')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Pregnancy
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ACTION BUTTONS -->
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                        <button onclick="loadDemoTerminology()" class="btn btn-secondary" style="font-size: 12px; flex: 1;">
                                            üìÅ Load Demo Tree
                                        </button>
                                        <button onclick="clearTree()" class="btn btn-secondary" style="font-size: 12px; flex: 1;">
                                            üóëÔ∏è Clear
                                        </button>
                                    </div>
                                    
                                    <!-- DEBUG BUTTON (optional) -->
                                    <button onclick="testSpecTool()" 
                                            style="font-size: 11px; padding: 3px 8px; background: #ff9900; color: white; border: none; border-radius: 3px; cursor: pointer; width: 100%;">
                                        üêõ Debug Test
                                    </button>
                                </div>
                                
                                <!-- TREE/RESULTS CONTAINER -->
                                <div id="treeContainer" style="flex-grow: 1; overflow-y: auto; border: 1px solid #d4d0c8; padding: 10px; background: white;">
                                    <div style="color: #666; text-align: center; padding: 20px;">
                                        <p>Enter a search term above to find medical terminology.</p>
                                        <p>Or click "Load Demo Tree" for example data.</p>
                                    </div>
                                </div>
                            </aside>

                            <!-- MAIN WORKSPACE - Specification Board -->
                            <main style="background: #f8f8f8; border: 1px solid #d4d0c8; border-radius: 3px; padding: 15px; overflow: hidden;">
                                <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #d4d0c8;">
                                    <h2 style="color: #0a3b9c;">Specification Board</h2>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="exportSpecToCSV()" class="btn btn-primary">
                                            üíæ Download ETL Spec (CSV)
                                        </button>
                                        <button onclick="clearAllCards()" class="btn btn-secondary">
                                            Clear Board
                                        </button>
                                    </div>
                                </header>
                                
                                <!-- Cards display area -->
                                <div id="spec-board" style="overflow-y: auto; padding: 10px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                    <div id="empty-board-message" style="color: #666; text-align: center; padding: 50px;">
                                        <h3>No Parameters Added</h3>
                                        <p>Click on any item in the terminology tree to add it to the board.</p>
                                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                                    </div>
                                </div>
                                
                                <!-- Stats bar -->
                                <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px; font-size: 12px; display: flex; justify-content: space-between;">
                                    <span id="card-count">0 parameters mapped</span>
                                    <span id="mapped-count">0 with source mapping</span>
                                </div>
                            </main>
                            
                            <!-- Clear float -->
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ================= ACCORDION 2: LEGISLATIVE LIBRARY ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="legislative">
                        <span>üìö Legislative & Policy Reference Library</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-legislative">
                        <div style="padding: 20px; text-align: center;">
                            <h3>Coming Soon: Legislative Repository</h3>
                            <p>Searchable database of NWT health legislation, policies, and compliance requirements.</p>
                        </div>
                    </div>
                </div>
                
                <!-- ================= ACCORDION 3: PRECEDENT DATABASE ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="precedent">
                        <span>‚öñÔ∏è Data Request Precedent Database</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-precedent">
                        <div style="padding: 20px; text-align: center;">
                            <h3>Coming Soon: Precedent Database</h3>
                            <p>Historical data request decisions, approvals, and conditions.</p>
                        </div>
                    </div>
                </div>
            </div> <!-- End knowledge-tab -->

            <!-- DASHBOARD TAB -->
            <div id="dashboard-tab" class="tab-pane">
                <!-- ================= ACCORDION 1: DASHBOARD CONTROLS ================= -->
                <div class="accordion">
                    <div class="accordion-header active" data-accordion="dashboard-controls">
                        <span>‚öôÔ∏è Dashboard Controls & Filters</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content active" id="accordion-dashboard-controls">
                        <div style="padding: 20px; background: #f8f8f8; border: 1px solid #d4d0c8; border-radius: 3px;">
                            <h3 style="margin-top: 0; color: #0a3b9c;">Dashboard Filters</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                <!-- Time Period Filter -->
                                <div class="form-group">
                                    <label for="time-period">Time Period:</label>
                                    <select id="time-period" class="form-control">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                
                                <!-- Region Filter -->
                                <div class="form-group">
                                    <label for="region-filter">Region:</label>
                                    <select id="region-filter" class="form-control">
                                        <option value="all">All Regions</option>
                                        <option value="Beaufort Delta Region">Beaufort Delta</option>
                                        <option value="Dehcho Region">Dehcho</option>
                                        <option value="Sahtu Region">Sahtu</option>
                                        <option value="South Slave Region">South Slave</option>
                                        <option value="T≈ÇƒØch«´ Region">T≈ÇƒØch«´</option>
                                        <option value="Yellowknife Region">Yellowknife</option>
                                    </select>
                                </div>
                                
                                <!-- Organization Filter -->
                                <div class="form-group">
                                    <label for="org-filter">Organization:</label>
                                    <select id="org-filter" class="form-control">
                                        <option value="all">All Organizations</option>
                                        <option value="DHSS">DHSS</option>
                                        <option value="HSSA">HSSA</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="loadDashboardData()" class="btn btn-primary">
                                    üîÑ Apply Filters & Refresh
                                </button>
                                <button onclick="resetDashboardFilters()" class="btn btn-secondary">
                                    üóëÔ∏è Reset Filters
                                </button>
                                <button onclick="exportDashboardData()" class="btn btn-secondary">
                                    üì• Export Data
                                </button>
                            </div>
                            
                            <!-- Status Display -->
                            <div id="dashboard-status" style="padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px; font-size: 12px;">
                                <span>Last Updated: </span>
                                <span id="last-updated">Never</span>
                                <span style="float: right;">
                                    <span id="data-source-status">‚è≥ Loading...</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ================= ACCORDION 2: KEY METRICS ================= -->
                <div class="accordion">
                    <div class="accordion-header active" data-accordion="dashboard-metrics">
                        <span>üìà Key Performance Metrics</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content active" id="accordion-dashboard-metrics">
                        <div style="padding: 20px;">
                            <!-- Key Metrics Grid -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                                <!-- Total Requests -->
                                <div class="metric-card" style="text-align: center; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                    <div id="metric-total-requests" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0</div>
                                    <div style="font-size: 14px; color: #666;">Total Requests</div>
                                    <div id="total-requests-count" style="font-size: 11px; color: #999; margin-top: 5px;">0 requests</div>
                                </div>
                                
                                <!-- Approval Rate -->
                                <div class="metric-card" style="text-align: center; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                    <div id="metric-approval-rate" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0%</div>
                                    <div style="font-size: 14px; color: #666;">Approval Rate</div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Based on status</div>
                                </div>
                                
                                <!-- Average Processing Time -->
                                <div class="metric-card" style="text-align: center; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                    <div id="metric-avg-days" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">--</div>
                                    <div style="font-size: 14px; color: #666;">Avg. Days</div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Processing time</div>
                                </div>
                                
                                <!-- Unique Requestors -->
                                <div class="metric-card" style="text-align: center; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                    <div id="metric-unique-requestors" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0</div>
                                    <div style="font-size: 14px; color: #666;">Unique Requestors</div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Different users</div>
                                </div>
                            </div>
                            
                            <!-- Storage Info -->
                            <div style="padding: 10px; background: #f8f8f8; border: 1px solid #d4d0c8; border-radius: 3px; font-size: 12px;">
                                <span>Data Status: </span>
                                <span id="storage-count">0</span> requests stored in database
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- ================= ACCORDION 3: DATA VISUALIZATIONS ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="dashboard-visualizations">
                        <span>üìä Data Visualizations</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-dashboard-visualizations">
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- Left: Request Distribution -->
                                <div>
                                    <h3 style="margin-top: 0; color: #0a3b9c;">üìä Request Distribution</h3>
                                    <div id="request-distribution" style="min-height: 300px; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div style="font-size: 48px;">üìÅ</div>
                                            <div>No visualization data yet</div>
                                            <div style="font-size: 12px; margin-top: 10px;">
                                                Apply filters to see data distribution
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Regional Breakdown -->
                                <div>
                                    <h3 style="margin-top: 0; color: #0a3b9c;">üó∫Ô∏è Regional Breakdown</h3>
                                    <div id="regional-breakdown" style="min-height: 300px; padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                        <div style="text-align: center; padding: 20px; color: #999;">
                                            <div style="font-size: 36px;">üó∫Ô∏è</div>
                                            <div>No regional data</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bottom: Recent Activity -->
                            <div>
                                <h3 style="margin-top: 0; color: #0a3b9c;">üìÖ Recent Activity</h3>
                                <div id="recent-activity" style="padding: 15px; background: white; border: 1px solid #d4d0c8; border-radius: 3px; min-height: 200px;">
                                    <div style="text-align: center; padding: 30px; color: #999;">
                                        <div style="font-size: 36px;">‚è≥</div>
                                        <div>No recent activity</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EMR DATA EXPLORER TAB -->
            <div id="emr-tab" class="tab-pane">
                <!-- Database Status Bar -->
                <div id="database-status" style="padding: 10px; margin-bottom: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                    Loading database...
                </div>
                
                <!-- DEBUG PANEL (optional) -->
                <div style="margin: 10px 0; padding: 10px; border: 2px solid orange; background: #fff8e1; display: none;" id="debug-panel">
                    <h4>üîß DEBUG PANEL</h4>
                    <button onclick="testDisplayArea()" style="padding: 5px 10px; margin: 2px;">Test Display</button>
                    <button onclick="testFirstTable()" style="padding: 5px 10px; margin: 2px;">Test First Table</button>
                    <button onclick="reloadDatabase()" style="padding: 5px 10px; margin: 2px;">Reload DB</button>
                </div>
                
                <!-- ================= ACCORDION 1: SCHEMA & TABLES ================= -->
                <div class="accordion">
                    <div class="accordion-header active" data-accordion="schema">
                        <span>üìä Schema Visualization & Table Explorer</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content active" id="accordion-schema">
                        <div class="compact-grid">
                            <!-- Left: Schema Diagram -->
                            <div class="compact-section">
                                <div class="emr-section-header">
                                    <h3>Database Schema</h3>
                                </div>
                                <div class="scrollable-section">
                                    <div class="schema-diagram" id="schema-diagram">
                                        <!-- Schema will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right: Table List -->
                            <div class="compact-section">
                                <div class="emr-section-header">
                                    <h3>Table Explorer</h3>
                                </div>
                                <div class="scrollable-section">
                                    <div class="table-list" id="table-list">
                                        Click table names to preview data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ================= ACCORDION 2: CLIENT REQUEST TRANSLATOR ================= -->
                <div class="accordion">
                    <div class="accordion-header active" data-accordion="translator">
                        <span>üîç Client Request Translator</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content active" id="accordion-translator">
                        <div class="form-group">
                            <label for="client-request">Enter Client Request:</label>
                            <textarea id="client-request" class="form-control textarea-large" 
                                      placeholder="Example: 'I need all diabetic patients aged 50+ from Yellowknife with HbA1c > 7% in 2024'"
                                      rows="3"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button id="analyze-request" class="btn btn-primary">Analyze Request</button>
                            <button onclick="clearAnalysis()" class="btn btn-secondary">Clear</button>
                        </div>
                        
                        <div id="analysis-results" style="display: none; background: #f8f8f8; padding: 15px; border: 1px solid #d4d0c8;">
                            <h4>Analysis Results:</h4>
                            <div class="form-group">
                                <label>Tables Required:</label>
                                <div id="tables-required" class="highlight"></div>
                            </div>
                            <div class="form-group">
                                <label>SQL Conditions:</label>
                                <div id="sql-conditions" class="highlight"></div>
                            </div>
                            <div class="form-group">
                                <label>Sample SQL Query:</label>
                                <div id="sample-sql" class="sql-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Quick Scenarios -->
                        <div style="margin-top: 15px;">
                            <h4>Quick Scenarios:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <button onclick="loadScenario('diabetes')" class="btn btn-secondary" style="font-size: 12px;">
                                    ü©∫ Diabetes Patients
                                </button>
                                <button onclick="loadScenario('appointments')" class="btn btn-secondary" style="font-size: 12px;">
                                    üìÖ Appointments
                                </button>
                                <button onclick="loadScenario('medications')" class="btn btn-secondary" style="font-size: 12px;">
                                    üíä Medications
                                </button>
                                <button onclick="loadScenario('admissions')" class="btn btn-secondary" style="font-size: 12px;">
                                    üè• Admissions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ================= ACCORDION 3: SQL PRACTICE ================= -->
                <!-- Example SQL Editor Area -->
<div class="form-group">
    <label for="sqlQuery">SQL Query:</label>
    <textarea id="sqlQuery" 
              class="form-control" 
              rows="6" 
              placeholder="Enter your SQL query here..."
              style="font-family: 'Courier New', monospace; font-size: 14px;">
    </textarea>
</div>

<!-- Quick Templates Section -->
<div class="form-group">
    <label>Quick Templates:</label>
    <div style="display: flex; flex-direction: column; gap: 5px;">
        <button onclick="loadTemplate('select_all')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            SELECT * FROM [table]
        </button>
        <button onclick="loadTemplate('count')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            SELECT COUNT(*) FROM [table]
        </button>
        <button onclick="loadTemplate('join')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            Simple JOIN template
        </button>
        <!-- Add more buttons -->
        <button onclick="loadTemplate('insert')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            INSERT template
        </button>
        <button onclick="loadTemplate('update')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            UPDATE template
        </button>
        <button onclick="loadTemplate('aggregate')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            Aggregate query
        </button>
        <button onclick="loadTemplate('subquery')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
            Subquery example
        </button>
    </div>
</div>
                
                <!-- ================= ACCORDION 4: QUERY RESULTS ================= -->
                <div class="accordion">
                    <div class="accordion-header" data-accordion="results">
                        <span>üìã Query Results</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content" id="accordion-results">
                        <div id="query-results" class="fixed-height-results">
                            Results will appear here when you run a query or click a table...
                        </div>
                        
                        <!-- Results Info -->
                        <div id="results-info" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; display: none;">
                            <strong>Query Info:</strong> <span id="row-count">0</span> rows returned
                        </div>
                    </div>
                </div>
            </div> <!-- End emr-tab -->

        </div> <!-- End tab-content -->

        <footer class="footer">
            <p>NWT Government Data Request Tool ‚Ä¢ Windows XP/2000 Theme</p>
        </footer>

    <script>
        // Configuration
        let db = null;
        let databaseLoaded = false;
        let currentQueryResults = null;
        
        // NWT Location Data
        const locationData = {
            "Beaufort Delta Region": ["Aklavik", "Fort McPherson", "Inuvik", "Paulatuk", "Sachs Harbour", "Tsiigehtchic", "Tuktoyaktuk", "Ulukhaktok"],
            "Dehcho Region": ["Fort Liard", "Fort Providence", "Fort Simpson", "Hay River Dene Reserve", "Jean Marie River", "Kakisa", "Nahanni Butte", "Sambaa K'e", "Wrigley"],
            "Sahtu Region": ["Colville Lake", "D√©lƒ±Ã®nƒô", "Fort Good Hope", "Norman Wells", "Tulita"],
            "South Slave Region": ["Enterprise", "Fort Resolution", "Fort Smith", "Hay River", "≈Åutselk'e"],
            "T≈ÇƒØch«´ Region": ["Behchok«´ÃÄ", "Gam√®tƒ±ÃÄ", "Wekwe√®tƒ±ÃÄ", "Whatƒ±ÃÄ"],
            "Yellowknife Region": ["Dettah", "Yellowknife"]
        };

        // Data storage for form tab
        let requestsData = JSON.parse(localStorage.getItem('dataRequests')) || [];
        let nextId = requestsData.length > 0 ? Math.max(...requestsData.map(r => r.id)) + 1 : 1;
        let savedQueries = JSON.parse(localStorage.getItem('emrSavedQueries')) || [];
        let customScenarios = JSON.parse(localStorage.getItem('customScenarios')) || [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    // Initialize EMR explorer when tab is activated
                    if (this.dataset.tab === 'emr-tab' && !databaseLoaded) {
                        loadDatabase();
                    }
                });
            });


            // Initialize event listeners -->
        
            document.addEventListener('DOMContentLoaded', function() {
                // Button event listeners
                document.getElementById('save-api-key-btn')?.addEventListener('click', setupInfowayAPI);
                document.getElementById('test-infoway-btn')?.addEventListener('click', () => testAPIconnection('INFOWAY'));
                document.getElementById('test-snowstorm-btn')?.addEventListener('click', () => testAPIconnection('SNOWSTORM'));
            });


        // Auto-open intelligence accordion when user starts typing purpose
            document.getElementById('defined-purpose').addEventListener('input', function(e) {
                if (e.target.value.length > 15) {
                    // Open the intelligence accordion
                    const intelAccordion = document.querySelector('[data-accordion="request-intelligence"]');
                    if (intelAccordion) {
                        intelAccordion.click(); // Simulate click to open
                        analyzeRequest(e.target.value);
                    }
                }
            });

            // Region selection
            document.getElementById('region').addEventListener('change', function() {
                const region = this.value;
                const districtSelect = document.getElementById('district');
                districtSelect.innerHTML = '<option value="">Select District</option>';
                
                if (region && locationData[region]) {
                    districtSelect.disabled = false;
                    locationData[region].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                } else {
                    districtSelect.disabled = true;
                }
            });

            // Organization checkboxes
            document.querySelectorAll('.org-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('.org-checkbox').forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                    updateOrganization();
                });
            });

            // Other org text input
            document.getElementById('other-org-text').addEventListener('input', updateOrganization);

            // Clear validation on input
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('input', function() {
                    this.classList.remove('validation-error');
                    const errorId = this.id + '-error';
                    if (document.getElementById(errorId)) {
                        document.getElementById(errorId).style.display = 'none';
                    }
                });
            });

            // Form tab buttons
            document.getElementById('save-btn').addEventListener('click', saveRequest);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('refresh-btn').addEventListener('click', loadTableData);

            // EMR tab buttons (will be set up after database loads)
            
            // Load initial table data for form tab
            loadTableData();
            
            // Pre-load database when page loads
            setTimeout(() => loadDatabase(), 1000);
        });

        // Debug script - add this anywhere
        console.log('=== DEBUG INFO ===');
        console.log('Infoway option element:', document.querySelector('option[value="INFOWAY"]'));
        console.log('Has API key in localStorage?', !!localStorage.getItem('infoway_api_key'));
        console.log('API key value:', localStorage.getItem('infoway_api_key') || 'NOT SET');

        // Check if functions are defined
        console.log('setupInfowayAPI defined?', typeof setupInfowayAPI);
        console.log('openApiSettings defined?', typeof openApiSettings);

// Force enable Infoway option for testing (temporary)
// document.querySelector('option[value="INFOWAY"]').disabled = false;

            function showDataTypeHelp() {
                alert("Data Type Specification Help:\n\n" +
                      "‚Ä¢ List specific data elements needed\n" +
                      "‚Ä¢ Specify data formats (CSV, JSON, Excel)\n" +
                      "‚Ä¢ Include field names, data types, and constraints\n" +
                      "‚Ä¢ Example: 'Patient ID (string), Date of Birth (date), Diagnosis Code (string)'");
            }

            function showFrequencyHelp() {
                alert("Data Request Frequency Help:\n\n" +
                      "‚Ä¢ One-time: Single extract only\n" +
                      "‚Ä¢ Daily: Every day at specified time\n" +
                      "‚Ä¢ Weekly: Every Monday at 9:00 AM\n" +
                      "‚Ä¢ Monthly: 1st day of each month\n" +
                      "‚Ä¢ Quarterly: End of each quarter\n" +
                      "‚Ä¢ Annually: Year-end extract\n" +
                      "‚Ä¢ On-demand: As requested");
            }


            function showClassificationHelp() {
                alert("Data Request Classification Help:\n\n" +
                      "‚Ä¢ Confidential: Contains sensitive personal information\n" +
                      "‚Ä¢ Restricted: Limited access within organization\n" +
                      "‚Ä¢ Internal: For internal use only\n" +
                      "‚Ä¢ Public: Can be shared publicly\n" +
                      "‚Ä¢ Protected: Requires special handling\n" +
                      "‚Ä¢ Examples: 'Confidential - Patient Health Data', 'Public - Aggregate Statistics'");
            }

            function showPurposeHelp() {
                alert("Defined Purpose Help:\n\n" +
                      "‚Ä¢ Be specific about WHY you need the data\n" +
                      "‚Ä¢ Describe the analysis or reporting\n" +
                      "‚Ä¢ Mention the intended audience\n" +
                      "‚Ä¢ Include timeline if applicable\n" +
                      "‚Ä¢ Example: 'To analyze diabetes prevalence among adults 40+ for annual health report to Ministry'");
            }

        // Load SQLite database
        async function loadDatabase() {
            const statusDiv = document.getElementById('database-status') || createStatusDiv();
            
            try {
                statusDiv.innerHTML = 'Loading SQLite engine...';
                
                // Initialize SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                statusDiv.innerHTML = 'Downloading database...';
                
                // Load your database file
                // IMPORTANT: You need to convert your .db file to ArrayBuffer
                // Option 1: Fetch from GitHub (if under 50MB)
                const response = await fetch('OpenEMR_Sim.db');
                if (!response.ok) {
                    throw new Error(`Database not found: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                statusDiv.innerHTML = 'Initializing database...';
                
                // Create database
                db = new SQL.Database(new Uint8Array(arrayBuffer));
                databaseLoaded = true;
                
                // Update UI
                statusDiv.innerHTML = `
                    <span style="color: green;">‚úì Database loaded successfully!</span>
                    <button onclick="showDatabaseInfo()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px;">
                        Show Info
                    </button>
                `;
                
                // Initialize EMR explorer
                initEMRExplorer();
                
                console.log('Database loaded successfully');
                
            } catch (error) {
                console.error('Database load error:', error);
                statusDiv.innerHTML = `
                    <span style="color: red;">‚úó Error loading database: ${error.message}</span><br>
                    <small>Using demo mode with sample data</small>
                `;
                
                // Create demo database
                createDemoDatabase();
            }
        }

        // ================= ACCORDION FUNCTIONALITY =================
            // Use event delegation for ALL accordions (even future ones)
            document.addEventListener('click', function(event) {
                // Check if the clicked element is an accordion header or inside one
                const header = event.target.closest('.accordion-header');
                
                if (header) {
                    const accordionId = header.dataset.accordion;
                    const content = document.getElementById(`accordion-${accordionId}`);
                    const icon = header.querySelector('.accordion-icon');
                    
                    if (content) {
                        // Toggle active state
                        const isActive = header.classList.contains('active');
                        header.classList.toggle('active');
                        content.classList.toggle('active');
                        
                        // Update icon
                        if (header.classList.contains('active')) {
                            icon.textContent = '‚àí';
                        } else {
                            icon.textContent = '+';
                        }
                        
                        // Auto-open results when query runs
                        if (accordionId === 'results' && !isActive) {
                            setTimeout(() => {
                                content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }, 100);
                        }
                    }
                }
            });
            
            // Auto-open results accordion when results are displayed
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const resultsDiv = document.getElementById('query-results');
                        if (resultsDiv && resultsDiv.textContent && 
                            resultsDiv.textContent.trim() !== 'Results will appear here...' &&
                            resultsDiv.textContent.trim() !== '') {
                            
                            // Open results accordion
                            const resultsHeader = document.querySelector('[data-accordion="results"]');
                            const resultsContent = document.getElementById('accordion-results');
                            
                            if (resultsHeader && !resultsHeader.classList.contains('active')) {
                                resultsHeader.classList.add('active');
                                resultsContent.classList.add('active');
                                resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                                
                                // Scroll to results
                                setTimeout(() => {
                                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 300);
                            }
                        }
                    }
                });
            });
            
            // Observe the results div for changes
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                observer.observe(resultsDiv, { 
                    childList: true, 
                    characterData: true, 
                    subtree: true 
                });
            }
            
            console.log("Accordions initialized");

        // Form Intelligence System - Works with YOUR real data

        // Analyze the current form against your database
        async function analyzeCurrentForm() {
            try {
                // Show loading state
                document.getElementById('analysis-status').textContent = 'Analyzing...';
                document.getElementById('analysis-status').style.color = '#FF9800';
                
                // Get current form values
                const purpose = document.getElementById('defined-purpose').value;
                const classification = document.getElementById('classification').value;
                const region = document.getElementById('region').value;
                
                if (!purpose || purpose.length < 10) {
                    alert('Please enter a detailed purpose (at least 10 characters) to analyze');
                    document.getElementById('analysis-status').textContent = 'Need more details';
                    document.getElementById('analysis-status').style.color = '#f44336';
                    return;
                }
                
                // Query YOUR database for similar requests
                const similarRequests = await findSimilarRequestsInDB(purpose, classification, region);
                
                // Display results
                displaySimilarRequests(similarRequests);
                
                // Generate recommendations based on similar requests
                generateRecommendations(similarRequests);
                
                // Update status
                document.getElementById('analysis-status').textContent = `Found ${similarRequests.length} similar requests`;
                document.getElementById('analysis-status').style.color = '#4CAF50';
                document.getElementById('intelligence-last-run').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error analyzing form:', error);
                document.getElementById('analysis-status').textContent = 'Analysis failed';
                document.getElementById('analysis-status').style.color = '#f44336';
            }
        }

        // Query YOUR database for similar requests
        async function findSimilarRequestsInDB(purpose, classification, region) {
            // Connect to YOUR SQLite database
            const db = window.database; // Your database connection
            
            // Simple text similarity search on purpose field
            // This will search for similar words in existing requests
            const query = `
                SELECT request_number, purpose, classification, region, 
                       created_at, legislative_authority
                FROM data_requests 
                WHERE purpose LIKE ? 
                   OR classification LIKE ?
                ORDER BY created_at DESC
                LIMIT 10
            `;
            
            const searchTerm = `%${purpose.split(' ')[0]}%`; // First word of purpose
            const results = await db.query(query, [searchTerm, classification]);
            
            return results || [];
        }

        // Display similar requests from YOUR database
        function displaySimilarRequests(requests) {
            const container = document.getElementById('similar-requests-container');
            const noDataMsg = document.getElementById('no-similar-requests');
            
            if (requests.length === 0) {
                noDataMsg.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            noDataMsg.style.display = 'none';
            
            let html = '';
            requests.forEach(request => {
                html += `
                    <div class="request-item" onclick="loadRequestDetails('${request.request_number}')">
                        <div class="request-id">${request.request_number}</div>
                        <div class="request-purpose">${request.purpose.substring(0, 60)}...</div>
                        <div class="request-date">${new Date(request.created_at).toLocaleDateString()}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Generate recommendations based on similar requests
        function generateRecommendations(similarRequests) {
            if (similarRequests.length === 0) return;
            
            // Data Source Recommendations
            const dataSourcesDiv = document.getElementById('data-source-recommendations');
            dataSourcesDiv.innerHTML = `
                <div class="recommendation-card">
                    <div class="rec-icon">üíæ</div>
                    <div class="rec-content">
                        <strong>Common Data Sources:</strong><br>
                        Based on ${similarRequests.length} similar requests, these systems were commonly used:
                        <ul style="margin: 5px 0 0 15px; font-size: 12px;">
                            <li>EMR Lab Results (used in ${Math.round(similarRequests.length * 0.7)} requests)</li>
                            <li>Diagnosis Codes Database (used in ${Math.round(similarRequests.length * 0.6)} requests)</li>
                            <li>Pharmacy Dispensing System (used in ${Math.round(similarRequests.length * 0.4)} requests)</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Compliance Guidance
            const complianceDiv = document.getElementById('compliance-guidance');
            
            // Count how many similar requests had legislative authority
            const withLegislative = similarRequests.filter(r => r.legislative_authority).length;
            const legislativePercent = Math.round((withLegislative / similarRequests.length) * 100);
            
            complianceDiv.innerHTML = `
                <div class="recommendation-card">
                    <div class="rec-icon">‚öñÔ∏è</div>
                    <div class="rec-content">
                        <strong>Compliance Insights:</strong><br>
                        ${legislativePercent}% of similar requests cited legislative authority.<br>
                        <span style="font-size: 12px; color: #666;">
                            Consider reviewing: Public Health Act, Health Information Act
                        </span>
                    </div>
                </div>
            `;
        }

        // Auto-analyze when user stops typing in purpose field
        let analyzeTimeout;
        document.getElementById('defined-purpose').addEventListener('input', function(e) {
            clearTimeout(analyzeTimeout);
            
            if (e.target.value.length > 30) {
                analyzeTimeout = setTimeout(() => {
                    if (document.getElementById('accordion-request-intelligence').style.display === 'block') {
                        analyzeCurrentForm();
                    }
                }, 1500); // Wait 1.5 seconds after typing stops
            }
        });

        // Clear intelligence results
        function clearIntelligence() {
            document.getElementById('similar-requests-container').innerHTML = `
                <div class="empty-state" id="no-similar-requests">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 36px;">üîç</div>
                        <div>No similar requests found yet</div>
                    </div>
                </div>
            `;
            
            document.getElementById('data-source-recommendations').innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 10px; color: #999; font-size: 13px;">
                    Based on your request purpose, recommended data sources will appear here
                </div>
            `;
            
            document.getElementById('compliance-guidance').innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 10px; color: #999; font-size: 13px;">
                    Legislative and compliance recommendations based on similar requests
                </div>
            `;
            
            document.getElementById('analysis-status').textContent = 'Analysis cleared';
            document.getElementById('analysis-status').style.color = '#666';
        }
        
        // Update previewTableData to auto-open results
        function previewTableData(tableName) {
            console.log('DEBUG: previewTableData called with:', tableName);
            
            // ... [keep all your existing previewTableData code] ...
            
            // At the END of the function, after displaying results, add:
            
            // Auto-open results accordion
            setTimeout(() => {
                const resultsHeader = document.querySelector('[data-accordion="results"]');
                const resultsContent = document.getElementById('accordion-results');
                
                if (resultsHeader && !resultsHeader.classList.contains('active')) {
                    resultsHeader.classList.add('active');
                    resultsContent.classList.add('active');
                    resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                    
                    // Smooth scroll to results
                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }
        
        // Update runSQLQuery to auto-open results
        function runSQLQuery() {
            // ... [keep all your existing runSQLQuery code] ...
            
            // At the END, after displaying results, add same auto-open logic
            
            setTimeout(() => {
                const resultsHeader = document.querySelector('[data-accordion="results"]');
                const resultsContent = document.getElementById('accordion-results');
                
                if (resultsHeader && !resultsHeader.classList.contains('active')) {
                    resultsHeader.classList.add('active');
                    resultsContent.classList.add('active');
                    resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                    
                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }


// =============================  DASHBOARD   =======================================================

        // Dashboard Data Loader - Connects to YOUR real data
        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data from your database...');
                
                // 1. Get filter values
                const timeFilter = document.getElementById('time-period').value;
                const regionFilter = document.getElementById('region-filter').value;
                const orgFilter = document.getElementById('org-filter').value;
                
                // 2. Load data from YOUR database
                // (This assumes you have a function that queries your SQLite database)
                const dashboardData = await getDashboardDataFromDB(timeFilter, regionFilter, orgFilter);
                
                // 3. Update the dashboard with REAL data
                updateDashboardWithRealData(dashboardData);
                
                // 4. Update status
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                document.getElementById('data-source-status').textContent = '‚úÖ Loaded';
                document.getElementById('data-source-status').style.color = '#4CAF50';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('data-source-status').textContent = '‚ùå Error';
                document.getElementById('data-source-status').style.color = '#f44336';
                showError('Could not load dashboard data. Check database connection.');
            }
        }

        // Example function you need to implement based on your database structure
        async function getDashboardDataFromDB(timeFilter, regionFilter, orgFilter) {
            // THIS IS WHERE YOU CONNECT TO YOUR ACTUAL DATABASE
            // For now, we'll use localStorage as fallback
            
            const storedData = localStorage.getItem('dataRequests');
            const requests = storedData ? JSON.parse(storedData) : [];
            
            // Apply filters
            let filteredRequests = [...requests];
            
            if (regionFilter !== 'all') {
                filteredRequests = filteredRequests.filter(req => req.region === regionFilter);
            }
            
            if (orgFilter !== 'all') {
                filteredRequests = filteredRequests.filter(req => req.organization === orgFilter);
            }
            
            // Apply time filter (simplified)
            if (timeFilter !== 'all') {
                const now = new Date();
                filteredRequests = filteredRequests.filter(req => {
                    const reqDate = new Date(req.timestamp);
                    // Simplified time filtering - you'd implement proper date logic
                    return true; // Placeholder
                });
            }
            
            const totalRequests = filteredRequests.length;
            const approvedRequests = filteredRequests.filter(req => req.status === 'Approved' || req.status === 'Completed').length;
            const approvalRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
            
            // Get unique regions
            const regions = [...new Set(filteredRequests
                .filter(req => req.region)
                .map(req => ({ region: req.region, count: 1 }))
            )];
            
            // Get recent requests
            const recent = filteredRequests
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5)
                .map(req => ({
                    request_number: req.request_number,
                    purpose: req.defined_purpose?.substring(0, 50) + '...' || 'No purpose',
                    created_at: req.timestamp ? new Date(req.timestamp).toLocaleDateString() : 'N/A'
                }));
            
            return {
                totalRequests,
                approvalRate,
                regions,
                recent
            };
        }

        // Update dashboard with real data
        function updateDashboardWithRealData(data) {
            // Update metrics
            document.getElementById('metric-total-requests').textContent = data.totalRequests;
            document.getElementById('total-requests-count').textContent = data.totalRequests + ' requests';
            document.getElementById('metric-approval-rate').textContent = data.approvalRate + '%';
            document.getElementById('storage-count').textContent = data.totalRequests;
            
            // Update unique requestors (placeholder)
            document.getElementById('metric-unique-requestors').textContent = Math.min(data.totalRequests, 15);
            
            // Update regional breakdown
            updateRegionalData(data.regions);
            
            // Update recent activity
            updateRecentActivity(data.recent);
        }

        // ==================================  DASHBOARD CALCULATIONS ======================================================

        function calculateProcessingDays(dateReceived, dateCompleted) {
            const received = new Date(dateReceived);
            const completed = new Date(dateCompleted);
            const diffTime = Math.abs(completed - received);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Days


        // ===============Auarterly Average  =======================

            function getQuarterlyAverage(requests) {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const recentRequests = requests.filter(req => 
                    new Date(req.date_completed) >= threeMonthsAgo
                );
                
                const totalDays = recentRequests.reduce((sum, req) => {
                    return sum + calculateProcessingDays(req.date_received, req.date_completed);
                }, 0);
                
                return recentRequests.length > 0 ? Math.round(totalDays / recentRequests.length) : 0;
            }


        //  ==========================   6 MONTHS AVERAGE  =====================================================


            function getSixMonthAverage(requests) {
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                
                const recentRequests = requests.filter(req => 
                    new Date(req.date_completed) >= sixMonthsAgo
                );
                
                const totalDays = recentRequests.reduce((sum, req) => {
                    return sum + calculateProcessingDays(req.date_received, req.date_completed);
                }, 0);
                
                return recentRequests.length > 0 ? Math.round(totalDays / recentRequests.length) : 0;
            }


        //  ===============================  Yearly Average  ==============================================

            function getYearlyAverage(requests) {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                const recentRequests = requests.filter(req => 
                    new Date(req.date_completed) >= oneYearAgo
                );
                
                const totalDays = recentRequests.reduce((sum, req) => {
                    return sum + calculateProcessingDays(req.date_received, req.date_completed);
                }, 0);
                
                return recentRequests.length > 0 ? Math.round(totalDays / recentRequests.length) : 0;
            }



}

        function updateRegionalData(regions) {
            const container = document.getElementById('regional-breakdown');
            if (regions.length > 0) {
                container.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 10px;">
                        <strong>Requests by Region:</strong>
                    </div>
                    <div style="font-size: 12px;">
                        ${regions.map(region => 
                            `<div style="margin-bottom: 5px; padding: 5px; background: #f0f8ff; border-radius: 3px;">
                                ${region.region}: <strong>${region.count}</strong>
                            </div>`
                        ).join('')}
                    </div>
                `;
            }
        }

        function updateRecentActivity(recent) {
            const container = document.getElementById('recent-activity');
            if (recent.length > 0) {
                container.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 10px;">
                        <strong>Recent Requests:</strong>
                    </div>
                    <div style="font-size: 12px;">
                        ${recent.map(req => 
                            `<div style="margin-bottom: 8px; padding: 8px; border-bottom: 1px solid #eee;">
                                <div><strong>${req.request_number}</strong></div>
                                <div style="color: #666;">${req.purpose}</div>
                                <div style="color: #999; font-size: 11px;">${req.created_at}</div>
                            </div>`
                        ).join('')}
                    </div>
                `;
            }
        }

        function showError(message) {
            alert('Dashboard Error: ' + message);
        }

        function resetDashboardFilters() {
            document.getElementById('time-period').value = 'all';
            document.getElementById('region-filter').value = 'all';
            document.getElementById('org-filter').value = 'all';
            loadDashboardData();
        }

        function exportDashboardData() {
            alert('Export feature coming soon!');
        }

        // Initialize dashboard when tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            // Load dashboard when Dashboard tab is clicked
            const dashboardTab = document.querySelector('[data-tab="dashboard-tab"]');
            if (dashboardTab) {
                dashboardTab.addEventListener('click', function() {
                    setTimeout(loadDashboardData, 100);
                });
            }
            
            // Initial load if on dashboard tab
            if (document.getElementById('dashboard-tab').classList.contains('active')) {
                setTimeout(loadDashboardData, 100);
            }
        });
        // Initialize EMR Explorer
        function initEMRExplorer() {
            if (!databaseLoaded) {
                console.log('Database not loaded yet, skipping EMR init');
                return;
            }
            
            try {
                // Load database schema
                loadDatabaseSchema();
                
                // Load table list
                loadTableList();
                
                // Setup event listeners for EMR tab
                const analyzeBtn = document.getElementById('analyze-request');
                const runQueryBtn = document.getElementById('run-query');
                const clearQueryBtn = document.getElementById('clear-query');
                const saveQueryBtn = document.getElementById('save-query');
                const exportBtn = document.getElementById('export-results');
                const savedQueriesSelect = document.getElementById('saved-queries');
                
                if (analyzeBtn) analyzeBtn.addEventListener('click', analyzeClientRequest);
                if (runQueryBtn) runQueryBtn.addEventListener('click', runSQLQuery);
                if (clearQueryBtn) clearQueryBtn.addEventListener('click', clearQuery);
                if (saveQueryBtn) saveQueryBtn.addEventListener('click', saveQuery);
                if (exportBtn) exportBtn.addEventListener('click', exportResults);
                if (savedQueriesSelect) savedQueriesSelect.addEventListener('change', loadSavedQuery);
                
                // Setup scenario click handlers
                document.querySelectorAll('.scenario-box').forEach(box => {
                    box.addEventListener('click', function() {
                        loadScenario(this.dataset.scenario);
                    });
                });
                
                // Load custom scenarios
                updateCustomScenariosDropdown();
                
                console.log('EMR Explorer initialized');
                
            } catch (error) {
                console.error('Error initializing EMR Explorer:', error);
            }
        }

        // Load database schema
        function loadDatabaseSchema() {
            try {
                if (!db) return;
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                window.emrSchema = {};
                
                tables[0]?.values.forEach(table => {
                    const tableName = table[0];
                    const columns = db.exec(`PRAGMA table_info(${tableName})`);
                    
                    window.emrSchema[tableName] = {
                        columns: columns[0]?.values.map(col => ({
                            name: col[1],
                            type: col[2],
                            notnull: col[3],
                            pk: col[5]
                        })) || []
                    };
                });
                
                renderSchemaDiagram();
                renderTableSelector();
                
            } catch (error) {
                console.error('Error loading schema:', error);
            }
        }

        // Load table list
        // ============ WORKING VERSION ============

        // 1. FIXED loadTableList function
        function loadTableList() {
            console.log("loadTableList called");
            
            try {
                if (!db) {
                    console.log("Database not ready");
                    return;
                }
                
                // Get tables
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
                console.log("Tables query result:", result);
                
                if (!result.length) {
                    console.log("No tables found");
                    return;
                }
                
                const tableList = document.getElementById('table-list');
                if (!tableList) {
                    console.error("table-list element not found");
                    return;
                }
                
                // Clear existing
                tableList.innerHTML = '';
                
                // Add each table
                const tables = result[0].values;
                console.log("Found tables:", tables);
                
                for (let i = 0; i < tables.length; i++) {
                    const tableName = tables[i][0];
                    
                    const tableItem = document.createElement('div');
                    tableItem.className = 'table-item';
                    tableItem.dataset.tableName = tableName; // Store table name
                    tableItem.innerHTML = `<strong>${tableName}</strong><br><small>Click to preview</small>`;
                    
                    // Add click handler
                    tableItem.addEventListener('click', function(event) {
                        event.stopPropagation();
                        console.log("Table item clicked:", this.dataset.tableName);
                        
                        // Remove previous selection
                        document.querySelectorAll('.table-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // Select this one
                        this.classList.add('selected');
                        
                        // Preview the table
                        const clickedTableName = this.dataset.tableName;
                        console.log("Calling previewTableData with:", clickedTableName);
                        previewTableData(clickedTableName);
                    });
                    
                    tableList.appendChild(tableItem);
                }
                
                console.log("Table list populated with", tables.length, "tables");
                
            } catch (error) {
                console.error("Error in loadTableList:", error);
            }
        }
        
        // 2. SIMPLE previewTableData function WITH EXPORT STORAGE
        function previewTableData(tableName) {
            console.log("previewTableData called for:", tableName);
            
            // Get results div
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) {
                console.error("query-results div not found!");
                alert("Error: Cannot find results area. Check HTML for id='query-results'");
                return;
            }
            
            // Show loading
            resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: blue;">Loading ${tableName}...</div>`;
            
            try {
                if (!db) {
                    resultsDiv.innerHTML = `<div style="color: red;">Database not loaded</div>`;
                    return;
                }
                
                // ========== FIXED: GET FULL TABLE DATA FIRST ==========
                // Query the ENTIRE table for export
                console.log("Getting full table data for export...");
                const fullQuery = `SELECT * FROM ${tableName}`;
                const fullResult = db.exec(fullQuery);
                
                // Store full table data for export
                window.currentTableData = {
                    tableName: tableName,
                    columns: fullResult[0]?.columns || [],
                    values: fullResult[0]?.values || [],
                    rowCount: fullResult[0]?.values?.length || 0
                };
                
                console.log(`Stored ${window.currentTableData.rowCount} rows for export`);
                
                // ========== THEN GET LIMITED DATA FOR DISPLAY ==========
                // Simple query - no quotes, just table name
                const displayQuery = `SELECT * FROM ${tableName} LIMIT 10`;
                console.log("Executing display query:", displayQuery);
                
                const displayResult = db.exec(displayQuery);
                console.log("Display query result:", displayResult);
                
                if (!displayResult.length || !displayResult[0].values.length) {
                    resultsDiv.innerHTML = `<div style="padding: 20px;">Table "${tableName}" is empty or not found</div>`;
                    return;
                }
                
                // Display the data WITH EXPORT BUTTON
                displayTablePreview(
                    tableName, 
                    displayResult[0].columns, 
                    displayResult[0].values,
                    window.currentTableData.rowCount  // Pass total count for display
                );
                
            } catch (error) {
                console.error("Error in previewTableData:", error);
                resultsDiv.innerHTML = `
                    <div style="color: red; padding: 20px; border: 1px solid red;">
                        <strong>Error loading ${tableName}:</strong><br>
                        ${error.message}<br><br>
                        Try a different table.
                    </div>
                `;
            }
        }
        
        // 3. UPDATED display function with export button and total count
        function displayTablePreview(tableName, columns, rows, totalRows = rows.length) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            console.log(`Displaying ${rows.length} of ${totalRows} rows from ${tableName}`);
            
            // Build HTML
            let html = `<h3 style="color: #0a3b9c;">${tableName}</h3>`;
            html += `<p>Showing ${rows.length} of ${totalRows} total rows</p>`;
            html += `<div style="overflow-x: auto; margin-top: 10px;">`;
            html += `<table border="1" style="border-collapse: collapse; width: 100%;">`;
            
            // Header
            html += `<tr style="background: #245edc; color: white;">`;
            columns.forEach(col => {
                html += `<th style="padding: 8px; text-align: left;">${col}</th>`;
            });
            html += `</tr>`;
            
            // Data rows
            rows.forEach((row, rowIndex) => {
                html += `<tr style="${rowIndex % 2 === 0 ? 'background: #f8f8f8;' : ''}">`;
                row.forEach(cell => {
                    let displayValue;
                    if (cell === null || cell === undefined) {
                        displayValue = '<em style="color: #999;">NULL</em>';
                    } else {
                        const str = String(cell);
                        displayValue = str.length > 30 ? str.substring(0, 30) + '...' : str;
                    }
                    html += `<td style="padding: 6px; border: 1px solid #ddd;">${displayValue}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</table></div>`;
            
            // ADD EXPORT BUTTON - only if we have data
            if (totalRows > 0) {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                        <button onclick="exportCurrentTable()" 
                                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 14px;">
                            üíæ Export Full Table (${totalRows} rows) to CSV
                        </button>
                        <div style="margin-top: 8px; color: #666; font-size: 13px;">
                            Exports all ${totalRows} rows from the ${tableName} table
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            console.log("Table displayed successfully with export button");
        }
        
        // 4. EXPORT FUNCTION for current table
        function exportCurrentTable() {
            if (!window.currentTableData || !window.currentTableData.tableName) {
                alert('No table data available for export. Click a table first.');
                return;
            }
            
            const { tableName, columns, values, rowCount } = window.currentTableData;
            
            console.log(`Exporting: ${tableName} with ${rowCount} rows`);
            
            if (!values || values.length === 0) {
                alert(`Table "${tableName}" is empty.`);
                return;
            }
            
            try {
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        // Wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Create filename
                const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const filename = `${tableName}_${timestamp}.csv`;
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úÖ Exported ${rowCount} rows from "${tableName}" to:\n${filename}`);
                console.log(`Exported ${rowCount} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Error exporting "${tableName}": ${error.message}`);
            }
        }
        
        // 3. SIMPLE display function WITH EXPORT BUTTON
        function displayTablePreview(tableName, columns, rows) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            console.log(`Displaying ${rows.length} rows from ${tableName}`);
            
            // Build HTML
            let html = `<h3 style="color: #0a3b9c;">${tableName}</h3>`;
            html += `<p>Showing ${rows.length} rows</p>`;
            html += `<div style="overflow-x: auto; margin-top: 10px;">`;
            html += `<table border="1" style="border-collapse: collapse; width: 100%;">`;
            
            // Header
            html += `<tr style="background: #245edc; color: white;">`;
            columns.forEach(col => {
                html += `<th style="padding: 8px; text-align: left;">${col}</th>`;
            });
            html += `</tr>`;
            
            // Data rows
            rows.forEach((row, rowIndex) => {
                html += `<tr style="${rowIndex % 2 === 0 ? 'background: #f8f8f8;' : ''}">`;
                row.forEach(cell => {
                    let displayValue;
                    if (cell === null || cell === undefined) {
                        displayValue = '<em style="color: #999;">NULL</em>';
                    } else {
                        const str = String(cell);
                        displayValue = str.length > 30 ? str.substring(0, 30) + '...' : str;
                    }
                    html += `<td style="padding: 6px; border: 1px solid #ddd;">${displayValue}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</table></div>`;
            
            // ADD EXPORT BUTTON
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                    <button onclick="exportTable('${tableName}')" 
                            style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                        üíæ Export Full Table to CSV
                    </button>
                    <span style="margin-left: 10px; color: #666; font-size: 14px;">
                        Export all data from ${tableName} table
                    </span>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            console.log("Table displayed successfully with export button");
        }
        
        // 4. EXPORT TABLE FUNCTION
        function exportTable(tableName) {
            console.log(`Exporting table: ${tableName}`);
            
            if (!db) {
                alert('Database not loaded.');
                return;
            }
            
            try {
                // Query the FULL table (no LIMIT)
                const result = db.exec(`SELECT * FROM ${tableName}`);
                
                if (!result.length || !result[0].values.length) {
                    alert(`Table "${tableName}" is empty.`);
                    return;
                }
                
                const columns = result[0].columns;
                const values = result[0].values;
                
                console.log(`Exporting ${values.length} rows, ${columns.length} columns`);
                
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        // Wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Create filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const filename = `${tableName}_export_${timestamp}.csv`;
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úÖ Exported ${values.length} rows from "${tableName}" to ${filename}`);
                console.log(`Exported ${values.length} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Error exporting "${tableName}": ${error.message}`);
            }
        }
        
        // 4. TEST function - call this from browser console
        function testTablePreview() {
            console.log("=== TEST TABLE PREVIEW ===");
            
            if (!db) {
                console.log("Database not loaded");
                alert("Load database first");
                return;
            }
            
            // Get first table
            const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' LIMIT 1");
            if (result.length && result[0].values.length) {
                const firstTable = result[0].values[0][0];
                console.log("Testing with table:", firstTable);
                previewTableData(firstTable);
            } else {
                console.log("No tables found");
            }
        }

        // Run SQL query
        function runSQLQuery() {
            const queryInput = document.getElementById('sql-query');
            if (!queryInput) return;
            
            const query = queryInput.value.trim();
            if (!query) {
                alert('Please enter a SQL query to run.');
                return;
            }
            
            if (!db) {
                alert('Database not loaded yet. Please wait.');
                return;
            }
            
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div style="color: blue; padding: 20px; text-align: center;">Executing query...</div>';
            }
            
            try {
                // Basic query validation
                const queryLower = query.toLowerCase();
                if (queryLower.includes('drop ') || queryLower.includes('delete ') || 
                    queryLower.includes('update ') || queryLower.includes('insert ') ||
                    queryLower.includes('alter ') || queryLower.includes('create ')) {
                    throw new Error('Only SELECT queries are allowed for safety.');
                }
                
                const result = db.exec(query);
                
                if (result.length === 0) {
                    displayQueryResults({ columns: [], values: [] }, 'Query executed (no results)');
                } else {
                    displayQueryResults(result[0], 'Query Results');
                }
                
                // Store for export
                currentQueryResults = { query, result: result[0] };
                
            } catch (error) {
                const errorDiv = document.getElementById('query-results');
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div style="color: red; font-weight: bold;">SQL Error:</div>
                        <div style="color: #666; margin: 10px 0; padding: 10px; background: #fff0f0; border: 1px solid red;">
                            ${error.message}
                        </div>
                        <div style="margin-top: 10px; color: #666;">Query: ${query.substring(0, 200)}${query.length > 200 ? '...' : ''}</div>
                    `;
                }
                console.error('SQL Error:', error);
            }
        }

        // Display query results
        function displayQueryResults(data, title = 'Results') {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            const columns = data.columns || [];
            const values = data.values || [];
            
            if (values.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="color: green; font-weight: bold;">‚úì ${title}</div>
                    <div style="margin-top: 10px; color: #666;">0 rows returned</div>
                `;
                return;
            }
            
            let html = `
                <div style="color: green; font-weight: bold;">‚úì ${title}</div>
                <div style="margin-top: 5px; color: #666;">
                    Returned ${values.length} rows with ${columns.length} columns
                </div>
                <div style="margin-top: 10px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr style="background-color: #245edc; color: white;">
            `;
            
            // Add headers
            columns.forEach(column => {
                html += `<th style="padding: 8px; border: 1px solid #0a3b9c; text-align: left;">${column}</th>`;
            });
            html += '</tr>';
            
            // Add data rows (limit to 100 for display)
            const displayLimit = Math.min(values.length, 100);
            for (let i = 0; i < displayLimit; i++) {
                const row = values[i];
                html += '<tr style="border-bottom: 1px solid #ddd;' + (i % 2 === 0 ? ' background-color: #f8f8f8;' : '') + '">';
                columns.forEach((column, colIndex) => {
                    const value = row[colIndex];
                    const displayValue = value !== null && value !== undefined ? 
                        String(value).substring(0, 50) + (String(value).length > 50 ? '...' : '') : 
                        '<em style="color: #999;">NULL</em>';
                    html += `<td style="padding: 6px; border: 1px solid #ddd;" title="${value !== null ? String(value).replace(/"/g, '&quot;') : ''}">${displayValue}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table></div>';
            
            if (values.length > 100) {
                html += `
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Showing first 100 of ${values.length} rows
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        // Export results to CSV
        // ================= CSV EXPORT FUNCTION =================

        // Export current query results to CSV
        function exportResults() {
            console.log("Export button clicked");
            
            // Check if we have results to export
            if (!currentQueryResults || !currentQueryResults.query) {
                alert('No query results to export. Please run a query first.');
                return;
            }
            
            const { query, result } = currentQueryResults;
            const columns = result?.columns || [];
            const values = result?.values || [];
            
            console.log("Exporting:", columns.length, "columns,", values.length, "rows");
            
            if (values.length === 0) {
                alert('No data to export.');
                return;
            }
            
            try {
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                let filename = 'query_results.csv';
                
                // Try to extract table name from query for better filename
                const tableMatch = query.match(/FROM\s+(\w+)/i) || query.match(/FROM\s+"(\w+)"/i);
                if (tableMatch && tableMatch[1]) {
                    filename = `${tableMatch[1]}_${timestamp}.csv`;
                } else {
                    filename = `query_${timestamp}.csv`;
                }
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úì Exported ${values.length} rows to ${filename}`);
                console.log(`Exported ${values.length} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }
        
        // Also export table previews to CSV
        function exportTablePreview(tableName) {
            if (!db) {
                alert('Database not loaded.');
                return;
            }
            
            try {
                // Query the table
                const result = db.exec(`SELECT * FROM ${tableName}`);
                
                if (!result.length || !result[0].values.length) {
                    alert(`Table "${tableName}" is empty.`);
                    return;
                }
                
                const columns = result[0].columns;
                const values = result[0].values;
                
                // Create CSV
                let csvContent = columns.join(',') + '\n';
                values.forEach(row => {
                    csvContent += row.map(cell => {
                        if (cell === null || cell === undefined) return '';
                        let str = String(cell);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            str = `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    }).join(',') + '\n';
                });
                
                // Download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}_export.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                alert(`Exported ${values.length} rows from "${tableName}"`);
                
            } catch (error) {
                alert(`Error exporting ${tableName}: ${error.message}`);
            }
        }


        // ================= KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL =================

        /// ================= KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL WITH REAL API =================

        // ================= KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL =================

        // Store for terminology tree and cards
        let specCards = JSON.parse(localStorage.getItem('nwtSpecCards')) || [];
        let terminologyTree = null;

        // Initialize spec tool
        function initSpecTool() {
            console.log('Initializing Specification Tool...');
            
            // Load saved cards
            loadSavedCards();
            
            // Setup event listeners
            const treeSearch = document.getElementById('treeSearch');
            if (treeSearch) {
                treeSearch.addEventListener('input', searchTerminologyTree);
            }
            
            // Load demo terminology if no cards exist
            if (specCards.length === 0) {
                // Don't auto-load - let user click button
            }
            
            updateStats();
        }

                // ================= INFOWAY TERMINOLOGY SERVER API =================

                const InfowayAPI = {
                    // Configuration
                    config: {
                        authUrl: 'https://auth.infoway-inforoute.ca/oauth2/token',
                        apiBaseUrl: 'https://api.infoway-inforoute.ca/terminology',
                        redirectUri: window.location.origin,
                        scope: 'terminology.read'
                    },
                    
                    // Check if credentials are saved
                    hasCredentials: function() {
                        return !!localStorage.getItem('infoway_client_id') && 
                               !!localStorage.getItem('infoway_client_secret');
                    },
                    
                    // Save credentials
                    saveCredentials: function(clientId, clientSecret) {
                        if (!clientId || !clientSecret) {
                            alert('Both Client ID and Client Secret are required');
                            return false;
                        }
                        
                        localStorage.setItem('infoway_client_id', clientId.trim());
                        localStorage.setItem('infoway_client_secret', clientSecret.trim());
                        
                        console.log('Infoway credentials saved');
                        this.updateUI();
                        
                        // Test the connection
                        this.testConnection();
                        
                        return true;
                    },
                    
                    // Clear credentials
                    clearCredentials: function() {
                        if (confirm('Are you sure you want to remove Infoway credentials?')) {
                            localStorage.removeItem('infoway_client_id');
                            localStorage.removeItem('infoway_client_secret');
                            localStorage.removeItem('infoway_access_token');
                            localStorage.removeItem('infoway_token_expiry');
                            this.updateUI();
                            alert('Infoway credentials cleared.');
                        }
                    },
                    
                    // Get OAuth2 access token
                    async getAccessToken() {
                        const clientId = localStorage.getItem('infoway_client_id');
                        const clientSecret = localStorage.getItem('infoway_client_secret');
                        
                        if (!clientId || !clientSecret) {
                            throw new Error('Infoway credentials not configured');
                        }
                        
                        // Check if we have a valid token
                        const savedToken = localStorage.getItem('infoway_access_token');
                        const tokenExpiry = localStorage.getItem('infoway_token_expiry');
                        
                        if (savedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                            console.log('Using cached access token');
                            return savedToken;
                        }
                        
                        console.log('Requesting new access token from Infoway...');
                        
                        // OAuth2 client credentials grant
                        const authHeader = 'Basic ' + btoa(clientId + ':' + clientSecret);
                        
                        const response = await fetch(this.config.authUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'Authorization': authHeader
                            },
                            body: new URLSearchParams({
                                'grant_type': 'client_credentials',
                                'scope': this.config.scope
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`OAuth2 error: ${response.status} - ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.access_token) {
                            throw new Error('No access token in response');
                        }
                        
                        // Save token with expiry (typically expires in 1 hour = 3600 seconds)
                        const expiryTime = Date.now() + ((data.expires_in || 3600) * 1000);
                        
                        localStorage.setItem('infoway_access_token', data.access_token);
                        localStorage.setItem('infoway_token_expiry', expiryTime.toString());
                        
                        console.log('New access token obtained, expires:', new Date(expiryTime).toLocaleTimeString());
                        
                        return data.access_token;
                    },
                    
                    // Search Infoway Terminology Server
                    async search(searchTerm, maxResults = 10) {
                        console.log(`Searching Infoway for: "${searchTerm}"`);
                        
                        try {
                            // Get access token
                            const accessToken = await this.getAccessToken();
                            
                            // FHIR CodeSystem search endpoint
                            const url = `${this.config.apiBaseUrl}/fhir/CodeSystem/$lookup`;
                            
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'Content-Type': 'application/fhir+json',
                                    'Accept': 'application/fhir+json'
                                },
                                body: JSON.stringify({
                                    resourceType: 'Parameters',
                                    parameter: [
                                        {
                                            name: 'system',
                                            valueUri: 'http://snomed.info/sct'
                                        },
                                        {
                                            name: 'code',
                                            valueString: searchTerm
                                        },
                                        {
                                            name: '_count',
                                            valueInteger: maxResults
                                        }
                                    ]
                                })
                            });
                            
                            if (!response.ok) {
                                if (response.status === 401) {
                                    // Token expired, clear it and retry
                                    localStorage.removeItem('infoway_access_token');
                                    localStorage.removeItem('infoway_token_expiry');
                                    return await this.search(searchTerm, maxResults);
                                }
                                throw new Error(`API error: ${response.status} ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            console.log('Infoway search results:', data);
                            
                            return this.parseSearchResults(data, searchTerm);
                            
                        } catch (error) {
                            console.error('Infoway search failed:', error);
                            throw error;
                        }
                    },
                    
                    // Parse FHIR response
                    parseSearchResults(fhirData, searchTerm) {
                        const results = {
                            provider: 'INFOWAY',
                            searchTerm: searchTerm,
                            timestamp: new Date().toISOString(),
                            total: 0,
                            concepts: []
                        };
                        
                        if (fhirData.parameter) {
                            results.concepts = fhirData.parameter
                                .filter(param => param.name === 'display' || param.name === 'name')
                                .map((param, index) => ({
                                    id: `infoway-${Date.now()}-${index}`,
                                    text: param.valueString || param.valueCode || searchTerm,
                                    type: param.name === 'display' ? 'Display Name' : 'Code',
                                    data: param
                                }));
                            
                            results.total = results.concepts.length;
                        }
                        
                        return results;
                    },
                    
                    // Test connection
                    async testConnection() {
                        const resultDiv = document.getElementById('api-test-result');
                        if (!resultDiv) return;
                        
                        resultDiv.innerHTML = `
                            <div style="color: #666; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; margin-top: 10px;">
                                ‚è≥ Testing Infoway connection...
                            </div>
                        `;
                        
                        try {
                            // Try to get an access token (this tests credentials)
                            const token = await this.getAccessToken();
                            
                            // If successful, try a simple search
                            const testResults = await this.search('diabetes', 1);
                            
                            resultDiv.innerHTML = `
                                <div style="color: green; padding: 10px; background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 3px; margin-top: 10px;">
                                    ‚úÖ INFOWAY: Connection Successful!
                                    <div style="font-size: 11px; margin-top: 5px;">
                                        ‚Ä¢ OAuth2 authentication: ‚úì<br>
                                        ‚Ä¢ Terminology API: ‚úì<br>
                                        ‚Ä¢ Search test: Found ${testResults.total} result(s)<br>
                                        ‚Ä¢ Token valid until: ${new Date(parseInt(localStorage.getItem('infoway_token_expiry'))).toLocaleTimeString()}
                                    </div>
                                </div>
                            `;
                            
                        } catch (error) {
                            resultDiv.innerHTML = `
                                <div style="color: #d32f2f; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 3px; margin-top: 10px;">
                                    ‚ùå INFOWAY Connection Failed
                                    <div style="font-size: 11px; margin-top: 5px;">
                                        Error: ${error.message || 'Unknown error'}<br>
                                        <small>Check your Client ID and Client Secret</small>
                                    </div>
                                </div>
                            `;
                            
                            // Clear invalid token if any
                            localStorage.removeItem('infoway_access_token');
                            localStorage.removeItem('infoway_token_expiry');
                        }
                    },
                    
                    // Update UI based on credentials status
                    updateUI: function() {
                        const hasCreds = this.hasCredentials();
                        
                        // Update Infoway dropdown option
                        const infowayOption = document.querySelector('option[value="INFOWAY"]');
                        if (infowayOption) {
                            if (hasCreds) {
                                infowayOption.disabled = false;
                                infowayOption.style.color = '';
                                infowayOption.textContent = 'Infoway Canada (Live SNOMED CT) üá®üá¶';
                            } else {
                                infowayOption.disabled = true;
                                infowayOption.style.color = '#999';
                                infowayOption.textContent = 'Infoway Canada (Credentials Required) üá®üá¶';
                            }
                        }
                        
                        // Update API Settings button
                        const apiSettingsBtn = document.querySelector('button[onclick*="openApiSettings"], #api-settings-btn');
                        if (apiSettingsBtn) {
                            if (hasCreds) {
                                apiSettingsBtn.innerHTML = 'üîê API Settings (Configured)';
                                apiSettingsBtn.style.background = '#4CAF50';
                                apiSettingsBtn.style.color = 'white';
                            } else {
                                apiSettingsBtn.innerHTML = 'üîì API Settings';
                                apiSettingsBtn.style.background = '';
                                apiSettingsBtn.style.color = '';
                            }
                        }
                        
                        // Update input fields in settings panel
                        const clientIdInput = document.getElementById('infoway-client-id');
                        const clientSecretInput = document.getElementById('infoway-client-secret');
                        
                        if (hasCreds) {
                            if (clientIdInput) {
                                const savedId = localStorage.getItem('infoway_client_id');
                                clientIdInput.value = savedId.substring(0, 8) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                                clientIdInput.type = 'text';
                                clientIdInput.disabled = true;
                            }
                            if (clientSecretInput) {
                                clientSecretInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                                clientSecretInput.type = 'text';
                                clientSecretInput.disabled = true;
                            }
                        } else {
                            if (clientIdInput) {
                                clientIdInput.value = '';
                                clientIdInput.type = 'text';
                                clientIdInput.disabled = false;
                                clientIdInput.placeholder = 'Enter Client ID';
                            }
                            if (clientSecretInput) {
                                clientSecretInput.value = '';
                                clientSecretInput.type = 'password';
                                clientSecretInput.disabled = false;
                                clientSecretInput.placeholder = 'Enter Client Secret';
                            }
                        }
                    },
                    
                    // Initialize
                    init: function() {
                        console.log('InfowayAPI initialized');
                        this.updateUI();
                        
                        // Add dropdown change listener
                        const providerSelect = document.getElementById('api-provider');
                        if (providerSelect) {
                            providerSelect.addEventListener('change', (e) => {
                                if (e.target.value === 'INFOWAY' && !this.hasCredentials()) {
                                    setTimeout(() => {
                                        alert('‚ö†Ô∏è Infoway credentials required!\n\nPlease configure your Client ID and Client Secret in API Settings.');
                                        e.target.value = 'DEMO';
                                        openApiSettings();
                                    }, 100);
                                }
                            });
                        }
                    }
                };

                // ================= SETUP FUNCTIONS =================

                function setupInfowayAPI() {
                    console.log('Setting up Infoway API...');
                    
                    const clientId = document.getElementById('infoway-client-id')?.value.trim();
                    const clientSecret = document.getElementById('infoway-client-secret')?.value.trim();
                    
                    if (!clientId || !clientSecret) {
                        alert('Both Client ID and Client Secret are required');
                        return;
                    }
                    
                    // Validate format
                    if (clientId.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                        alert('Please enter a new Client ID (current appears masked)');
                        return;
                    }
                    
                    if (clientSecret.includes('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                        alert('Please enter a new Client Secret (current appears masked)');
                        return;
                    }
                    
                    // Save credentials
                    const success = InfowayAPI.saveCredentials(clientId, clientSecret);
                    
                    if (success) {
                        // Clear input fields
                        document.getElementById('infoway-client-id').value = '';
                        document.getElementById('infoway-client-secret').value = '';
                    }
                }

                function openApiSettings() {
                    const panel = document.getElementById('api-setup-panel');
                    if (!panel) {
                        alert('API settings panel not found');
                        return;
                    }
                    
                    // Toggle visibility
                    const isVisible = panel.style.display === 'block';
                    panel.style.display = isVisible ? 'none' : 'block';
                    
                    // Update UI when panel opens
                    if (!isVisible) {
                        InfowayAPI.updateUI();
                    }
                }

                function testInfowayConnection() {
                    InfowayAPI.testConnection();
                }

                function clearInfowayCredentials() {
                    InfowayAPI.clearCredentials();
                }

                // ================= SEARCH FUNCTION INTEGRATION =================

                // Update your searchInfowayAPI function to use the new system
                async function searchInfowayAPI(searchTerm) {
                    return await InfowayAPI.search(searchTerm);
                }

                // ================= INITIALIZE =================

                document.addEventListener('DOMContentLoaded', function() {
                    InfowayAPI.init();
                    
                    // Add event listeners for buttons
                    document.getElementById('save-infoway-btn')?.addEventListener('click', setupInfowayAPI);
                    document.getElementById('test-infoway-btn')?.addEventListener('click', testInfowayConnection);
                    document.getElementById('clear-infoway-btn')?.addEventListener('click', clearInfowayCredentials);
                });

                // Make functions globally available
                window.setupInfowayAPI = setupInfowayAPI;
                window.openApiSettings = openApiSettings;
                window.testInfowayConnection = testInfowayConnection;
                window.searchInfowayAPI = searchInfowayAPI;

        // Load demo terminology tree
        function loadDemoTerminology() {
            console.log('Loading demo terminology...');
            
            // Sample FHIR/SNOMED terminology tree
            const demoTree = [
                {
                    name: "Clinical Parameters",
                    type: "category",
                    children: [
                        {
                            name: "Diabetes Mellitus",
                            code: "SNOMED:73211009",
                            description: "Diabetes mellitus (disorder)",
                            type: "parameter",
                            children: [
                                {
                                    name: "Type 1 Diabetes",
                                    code: "SNOMED:46635009",
                                    description: "Insulin dependent diabetes mellitus",
                                    type: "parameter"
                                },
                                {
                                    name: "Type 2 Diabetes",
                                    code: "SNOMED:44054006",
                                    description: "Diabetes mellitus type 2",
                                    type: "parameter"
                                }
                            ]
                        },
                        {
                            name: "Hypertension",
                            code: "SNOMED:38341003",
                            description: "Hypertensive disorder",
                            type: "parameter",
                            children: [
                                {
                                    name: "Essential Hypertension",
                                    code: "SNOMED:59621000",
                                    description: "Essential hypertension",
                                    type: "parameter"
                                }
                            ]
                        },
                        {
                            name: "Body Mass Index",
                            code: "LOINC:39156-5",
                            description: "Body mass index (BMI)",
                            type: "parameter"
                        }
                    ]
                },
                {
                    name: "Demographics",
                    type: "category",
                    children: [
                        {
                            name: "Age at Visit",
                            code: "ISO:Age",
                            description: "Patient age at encounter date",
                            type: "parameter"
                        },
                        {
                            name: "Administrative Gender",
                            code: "HL7:Gender",
                            description: "Administrative gender",
                            type: "parameter",
                            children: [
                                { name: "Male", code: "M", type: "value" },
                                { name: "Female", code: "F", type: "value" },
                                { name: "Other", code: "O", type: "value" }
                            ]
                        }
                    ]
                },
                {
                    name: "Laboratory Results",
                    type: "category",
                    children: [
                        {
                            name: "Hemoglobin A1c",
                            code: "LOINC:4548-4",
                            description: "Hemoglobin A1c/Hemoglobin.total in Blood",
                            type: "parameter"
                        },
                        {
                            name: "Cholesterol",
                            code: "LOINC:2093-3",
                            description: "Cholesterol in Serum or Plasma",
                            type: "parameter",
                            children: [
                                { name: "HDL Cholesterol", code: "LOINC:2085-9", type: "parameter" },
                                { name: "LDL Cholesterol", code: "LOINC:13457-7", type: "parameter" }
                            ]
                        }
                    ]
                }
            ];
            
            terminologyTree = demoTree;
            renderTerminologyTree(demoTree);
        }

        // Render terminology tree recursively
        function renderTerminologyTree(data, container = null) {
            const targetContainer = container || document.getElementById('treeContainer');
            if (!targetContainer) {
                console.error('treeContainer not found!');
                return;
            }
            
            targetContainer.innerHTML = '';
            
            const ul = document.createElement('ul');
            ul.style.listStyleType = 'none';
            ul.style.paddingLeft = '10px';
            
            if (!data || data.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="color: #666; padding: 10px;">No data available</div>';
                ul.appendChild(li);
                targetContainer.appendChild(ul);
                return;
            }
            
            data.forEach(item => {
                const li = document.createElement('li');
                li.style.marginBottom = '5px';
                
                if (item.children && item.children.length > 0) {
                    // It's a category/folder - use details/summary
                    const details = document.createElement('details');
                    details.open = true;
                    
                    const summary = document.createElement('summary');
                    summary.style.cursor = 'pointer';
                    summary.style.padding = '5px';
                    summary.style.backgroundColor = '#e0e8ff';
                    summary.style.borderRadius = '3px';
                    summary.style.fontWeight = 'bold';
                    summary.style.color = '#0a3b9c';
                    summary.textContent = item.name;
                    
                    const childContainer = document.createElement('div');
                    childContainer.style.marginLeft = '15px';
                    childContainer.style.marginTop = '5px';
                    
                    details.appendChild(summary);
                    details.appendChild(childContainer);
                    li.appendChild(details);
                    
                    // Recursively render children
                    renderTerminologyTree(item.children, childContainer);
                    
                } else {
                    // It's a leaf node (parameter)
                    const span = document.createElement('span');
                    span.className = 'leaf-node';
                    span.style.display = 'block';
                    span.style.padding = '8px';
                    span.style.margin = '2px 0';
                    span.style.cursor = 'pointer';
                    span.style.backgroundColor = '#f0f0f0';
                    span.style.borderRadius = '3px';
                    span.style.borderLeft = '3px solid #4CAF50';
                    span.style.fontSize = '14px';
                    
                    span.innerHTML = `
                        <strong>${item.name}</strong>
                        ${item.code ? `<br><small style="color: #666;">${item.code}</small>` : ''}
                        ${item.description ? `<br><small style="color: #888;">${item.description}</small>` : ''}
                    `;
                    
                    // Add click handler to add parameter to board
                    span.addEventListener('click', function(e) {
                        e.stopPropagation();
                        addParameterCard(item);
                    });
                    
                    li.appendChild(span);
                }
                
                ul.appendChild(li);
            });
            
            targetContainer.appendChild(ul);
        }

        // Search terminology tree
        async function searchTerminology() {
        const searchTerm = document.getElementById('treeSearch').value.trim();
        const provider = document.getElementById('api-provider').value;
        
        // Get UI elements
        const treeContainer = document.getElementById('treeContainer');
        const statusText = document.getElementById('search-status') || (() => {
            const div = document.createElement('div');
            div.id = 'search-status';
            div.style.padding = '10px';
            treeContainer.parentElement.insertBefore(div, treeContainer);
            return div;
        })();
        
        // Validate input
        if (!searchTerm) {
            alert('Please enter a search term');
            return;
        }
        
        // Show loading state
        statusText.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">
            <div style="font-size: 24px;">‚è≥</div>
            <div>Searching ${provider} for "${searchTerm}"...</div>
        </div>`;
        treeContainer.innerHTML = '';
        
        try {
            let results;
            let usedProvider = provider; // Track which provider actually worked
            
            switch(provider) {
                case 'DEMO':
                    // Use the existing demo tree search
                    searchTerminologyTree({ target: { value: searchTerm } });
                    statusText.innerHTML = '';
                    return;
                    
                case 'SNOWSTORM':
                    results = await searchSnowstormFree(searchTerm);
                    usedProvider = 'SNOWSTORM';
                    break;
                    
                case 'INFOWAY':
                    try {
                        results = await searchInfowayAPI(searchTerm);
                        usedProvider = 'INFOWAY';
                    } catch (infowayError) {
                        console.warn('Infoway failed, falling back to Snowstorm:', infowayError);
                        // Auto-fallback to Snowstorm
                        results = await searchSnowstormFree(searchTerm);
                        usedProvider = 'SNOWSTORM (fallback)';
                        
                        // Update UI to show we're using fallback
                        const fallbackNote = document.createElement('div');
                        fallbackNote.style.cssText = 'background: #fff3cd; border: 1px solid #ffecb5; color: #856404; padding: 8px; margin-bottom: 10px; border-radius: 3px; font-size: 12px;';
                        fallbackNote.innerHTML = '‚ö†Ô∏è Infoway unavailable. Showing Snowstorm results instead.';
                        setTimeout(() => {
                            if (treeContainer.firstChild) {
                                treeContainer.insertBefore(fallbackNote, treeContainer.firstChild);
                            }
                        }, 100);
                    }
                    break;
                    
                case 'ONTOSERVER':
                    // Keep for backward compatibility but force fallback
                    console.warn('Ontoserver selected but CORS blocked. Using Snowstorm.');
                    results = await searchSnowstormFree(searchTerm);
                    usedProvider = 'SNOWSTORM (CORS fallback)';
                    break;
                    
                default:
                    // Ultimate fallback to Snowstorm
                    results = await searchSnowstormFree(searchTerm);
                    usedProvider = 'SNOWSTORM (default)';
            }
            
            // Display the results
            displayAPISearchResults(results, usedProvider, searchTerm);
            statusText.innerHTML = '';
            
        } catch (error) {
            console.error(`${provider} search completely failed:`, error);
            
            // Final fallback to demo data
            statusText.innerHTML = `<div style="color: #f44336; text-align: center; padding: 20px;">
                <div style="font-size: 24px;">‚ùå</div>
                <div>All API searches failed for "${searchTerm}"</div>
                <div style="font-size: 12px; margin-top: 10px; color: #666;">
                    Error: ${error.message || 'Network or API issue'}
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="forceDemoSearch('${searchTerm.replace(/'/g, "\\'")}')" 
                            style="padding: 8px 15px; background: #0a3b9c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                        Use Demo Data Instead
                    </button>
                </div>
            </div>`;
        }
    }

    async function searchInfowayAPI(searchTerm) {
        // Get key from localStorage (not from config.js)
        const apiKey = ApiKeyManager.getKey();
        
        if (!apiKey) {
            // Show modal to enter key
            ApiKeyManager.showModal();
            throw new Error('Infoway API key not configured');
        }
        
        // Use the key (still visible in network tab, but better than config.js)
        const response = await fetch(`https://api.infoway-inforoute.ca/fhir/CodeSystem/$lookup`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/fhir+json',
                'Accept': 'application/fhir+json'
            },
            body: JSON.stringify({
                resourceType: 'Parameters',
                parameter: [
                    {
                        name: 'system',
                        valueUri: 'http://snomed.info/sct'
                    },
                    {
                        name: 'code',
                        valueString: searchTerm
                    }
                ]
            })
        });
        
        if (!response.ok) {
            throw new Error(`Infoway API error: ${response.status}`);
        }
        
        return await response.json();
    }

    // API Key Manager
    const ApiKeyManager = {
        // Check if key exists
        hasKey: function() {
            return !!localStorage.getItem('infoway_api_key');
        },
        
        // Get the key (for API calls)
        getKey: function() {
            return localStorage.getItem('infoway_api_key');
        },
        
        // Save key from input
        saveKey: function() {
            const keyInput = document.getElementById('infoway-api-key');
            const key = keyInput.value.trim();
            
            if (!key) {
                alert('Please enter your API key');
                return false;
            }
            
            // Basic validation
            if (key.length < 10) {
                alert('API key appears too short. Please check and try again.');
                return false;
            }
            
            // Store in localStorage
            localStorage.setItem('infoway_api_key', key);
            
            // Mask for display
            const maskedKey = key.substring(0, 6) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.substring(key.length - 4);
            console.log('API key saved (masked):', maskedKey);
            
            // Hide modal
            this.hideModal();
            
            // Update UI
            this.updateUI();
            
            alert('‚úÖ API key saved locally to your browser.');
            return true;
        },
        
        // Clear key
        clearKey: function() {
            if (confirm('Are you sure you want to remove your API key?')) {
                localStorage.removeItem('infoway_api_key');
                this.updateUI();
                alert('API key removed.');
            }
        },
        
        // Show the modal
        showModal: function() {
            document.getElementById('api-key-modal').style.display = 'flex';
        },
        
        // Hide the modal
        hideModal: function() {
            document.getElementById('api-key-modal').style.display = 'none';
        },
        
        // Update UI based on key status
        updateUI: function() {
            const hasKey = this.hasKey();
            const apiSettingsBtn = document.querySelector('button[onclick*="openApiSettings"]');
            
            if (apiSettingsBtn) {
                apiSettingsBtn.textContent = hasKey ? 
                    'üîê API Settings (Configured)' : 
                    'üîì API Settings (Not Configured)';
                apiSettingsBtn.style.background = hasKey ? '#4CAF50' : '';
                apiSettingsBtn.style.color = hasKey ? 'white' : '';
            }
            
            // Enable/disable INFOWAY option
            const infowayOption = document.querySelector('option[value="INFOWAY"]');
            if (infowayOption) {
                if (!hasKey) {
                    infowayOption.disabled = true;
                    infowayOption.textContent += ' (API Key Required)';
                } else {
                    infowayOption.disabled = false;
                    infowayOption.textContent = 'Infoway Canada (Live SNOMED CA) üá®üá¶';
                }
            }
        },
        
        // Initialize on page load
        init: function() {
            this.updateUI();
            
            // Check if INFOWAY is selected but no key
            const providerSelect = document.getElementById('api-provider');
            if (providerSelect) {
                providerSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'INFOWAY' && !this.hasKey()) {
                        alert('Infoway API key required. Please configure it first.');
                        this.showModal();
                        e.target.value = 'DEMO'; // Revert to DEMO
                    }
                });
            }
        }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        ApiKeyManager.init();
    });

    // Button functions
    function saveApiKey() {
        ApiKeyManager.saveKey();
    }

    function useDemoMode() {
        ApiKeyManager.hideModal();
        document.getElementById('api-provider').value = 'DEMO';
        alert('Using Demo Mode. You can configure Infoway API later.');
    }

    // Helper function for demo fallback button
    function forceDemoSearch(term) {
        document.getElementById('treeSearch').value = term;
        document.getElementById('api-provider').value = 'DEMO';
        searchTerminology();
    }

    // Display function for API results
    function displayAPISearchResults(results, provider, searchTerm) {
        const treeContainer = document.getElementById('treeContainer');
        
        if (!results || results.length === 0) {
            treeContainer.innerHTML = `<div style="color: #666; text-align: center; padding: 40px;">
                <div style="font-size: 36px;">üîç</div>
                <div>No results found for "${searchTerm}"</div>
                <div style="font-size: 12px; margin-top: 10px; color: #999;">
                    Provider: ${provider}<br>
                    Try different search terms or switch to DEMO mode
                </div>
            </div>`;
            return;
        }
        
        // Build results HTML
        let html = `
            <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 3px; font-size: 13px;">
                <strong>${provider} Results:</strong> Found ${results.length} concept(s) for "${searchTerm}"
                ${provider.includes('fallback') ? '<span style="color: #856404; margin-left: 10px;">(Using fallback provider)</span>' : ''}
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
        `;
        
        results.forEach((item, index) => {
            const isCanadian = provider === 'INFOWAY' || item.description?.includes('CA') || item.source?.includes('Canada');
            const flag = isCanadian ? ' üá®üá¶' : '';
            
            html += `
                <div class="api-result-item" 
                     style="margin-bottom: 8px; padding: 10px; border: 1px solid #d4d0c8; border-radius: 3px; cursor: pointer; background: white;"
                     onclick="addAPIParameterCard(${JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, "\\'")})"
                     onmouseover="this.style.background='#f0f8ff'; this.style.borderColor='#0a3b9c'" 
                     onmouseout="this.style.background='white'; this.style.borderColor='#d4d0c8'">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex-grow: 1;">
                            <div style="font-weight: bold; color: #0a3b9c; margin-bottom: 3px;">
                                ${item.display || item.description}${flag}
                            </div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">
                                <span style="background: #e8e8e8; padding: 1px 4px; border-radius: 2px; margin-right: 5px;">
                                    ${item.code || 'No code'}
                                </span>
                                <span>Source: ${item.source || provider}</span>
                                ${item.system ? `<span style="margin-left: 10px;">System: ${item.system.split('/').pop()}</span>` : ''}
                            </div>
                            ${item.description && item.description !== item.display ? 
                                `<div style="font-size: 11px; color: #888; margin-top: 3px; font-style: italic;">${item.description}</div>` : ''}
                        </div>
                        <button style="padding: 4px 10px; font-size: 11px; background: #0a3b9c; color: white; border: none; border-radius: 3px; cursor: pointer; white-space: nowrap;"
                                onclick="event.stopPropagation(); addAPIParameterCard(${JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, "\\'")})">
                            Add +
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        treeContainer.innerHTML = html;
    }

    // Add API result to board (ensure this function exists)
    function addAPIParameterCard(item) {
        // Implementation depends on your existing specCards array
        // This should match your current addParameterCard function logic
        const cardId = `card-${Date.now()}`;
        const card = {
            id: cardId,
            name: item.display || item.description,
            code: item.code || '',
            description: item.description || '',
            source: item.source || 'API',
            system: item.system || '',
            logic: '',
            timestamp: new Date().toISOString()
        };
        
        // Assuming specCards is a global array
        if (window.specCards) {
            const existingCard = window.specCards.find(c => c.code === card.code);
            if (existingCard) {
                alert(`"${card.name}" is already on the board.`);
                return;
            }
            window.specCards.push(card);
            
            // Update UI
            if (window.renderCard) window.renderCard(card);
            if (window.updateStats) window.updateStats();
            if (window.saveCardsToStorage) window.saveCardsToStorage();
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
        } else {
            console.error('specCards array not found');
            alert('Could not add card: Board not initialized');
        }
    }

    // Snowstorm search function (must exist)
    async function searchSnowstormFree(searchTerm) {
        const url = `https://snowstorm.ihtsdotools.org/snowstorm/snomed-ct/browser/MAIN/SNOMEDCT-US/2023-09-01/concepts?term=${encodeURIComponent(searchTerm)}&limit=20`;
        
        const response = await fetch(url, {
            headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`Snowstorm: HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        return data.items.map(item => ({
            code: item.conceptId,
            system: 'http://snomed.info/sct',
            display: item.fsn?.term || item.pt?.term || 'No term',
            source: 'Snowstorm',
            description: item.fsn?.term || '',
            url: `http://snomed.info/id/${item.conceptId}`
        }));
    }

    // Infoway search function (placeholder - add your API key when you get it)
    async function searchInfowayAPI(searchTerm) {
        const INFOWAY_API_KEY = 'YOUR_API_KEY_HERE'; // ‚Üê REPLACE WHEN YOU GET IT
        const INFOWAY_BASE_URL = 'https://terminology.infoway-inforoute.ca/api';
        
        if (!INFOWAY_API_KEY || INFOWAY_API_KEY === 'YOUR_API_KEY_HERE') {
            throw new Error('Infoway API key not configured');
        }
        
        const url = `${INFOWAY_BASE_URL}/ValueSet/$expand?url=http://snomed.info/sct?fhir_vs&filter=${encodeURIComponent(searchTerm)}&count=20`;
        
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/fhir+json',
                'Content-Type': 'application/fhir+json',
                'Authorization': `Bearer ${INFOWAY_API_KEY}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Infoway: HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.expansion?.contains) {
            return data.expansion.contains.map(item => ({
                code: item.code,
                system: item.system,
                display: item.display,
                source: 'Infoway Canada',
                description: `${item.display} üá®üá¶`,
                url: item.system ? `${item.system}/${item.code}` : ''
            }));
        }
        
        return [];
    }

    function openApiSettings() {
        const panel = document.getElementById('api-setup-panel');
        
        // Toggle panel
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        
        // Populate key field if exists
        const key = ApiKeyManager.getKey();
        const keyInput = document.getElementById('infoway-api-key-input');
        
        if (key && keyInput) {
            // Show masked key
            const maskedKey = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.substring(key.length - 4);
            keyInput.value = maskedKey;
            keyInput.type = 'text';
            keyInput.disabled = true;
        } else if (keyInput) {
            keyInput.value = '';
            keyInput.type = 'password';
            keyInput.disabled = false;
        }
    }

    // Optional: Search Canadian-specific code systems
    async function searchCanadianExtensions(searchTerm) {
        // Canadian-specific code systems in Infoway:
        const canadianSystems = {
            'pCLOCD': 'Pan-Canadian Localization of Care Dataset',
            'CCP': 'Canadian Classification of Health Interventions',
            'C-HI': 'Canadian Health Information',
            'SNOMED CT CA': 'SNOMED CT Canadian Edition'
        };
        
        const results = [];
        
        // Search across multiple Canadian systems
        for (const [system, description] of Object.entries(canadianSystems)) {
            try {
                const url = `https://terminology.infoway-inforoute.ca/api/CodeSystem/$lookup?system=${system}&code=${searchTerm}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${INFOWAY_API_KEY}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.parameter && data.parameter.length > 0) {
                        results.push({
                            system: system,
                            display: data.parameter.find(p => p.name === 'display').valueString,
                            description: description
                        });
                    }
                }
            } catch (err) {
                console.log(`No match in ${system}`);
            }
        }
        
        return results;
    }


    // Test function for NWT health terms
        async function testCanadianRelevance() {
            const nwtRelevantTerms = [
                'tuberculosis',      // Higher incidence in Northern Canada
                'frostbite',         // Climate-relevant
                'vitamin D deficiency', // Northern latitude issue
                'hepatitis',         // Public health concern
                'mental health',     // Broad but important
                'prenatal care',     // Maternal health
                'traditional medicine' // Indigenous health
            ];
            
            console.log('Testing Canadian terminology relevance...');
            
            for (const term of nwtRelevantTerms.slice(0, 3)) { // Test first 3
                try {
                    const results = await searchInfowayAPI(term);
                    console.log(`"${term}": ${results.length} Canadian results`);
                    
                    // Look for Canadian-specific codes
                    const canadianResults = results.filter(r => 
                        r.description.includes('CA') || 
                        r.system.includes('canadian')
                    );
                    
                    if (canadianResults.length > 0) {
                        console.log(`  ‚Üí ${canadianResults.length} Canada-specific codes`);
                    }
                } catch (error) {
                    console.log(`"${term}": Failed - ${error.message}`);
                }
            }
        }

    // Your existing demo search function
    function searchTerminologyTree(event) {
        const term = event.target.value.toLowerCase().trim();
        const allLeaves = document.querySelectorAll('.leaf-node');
        
        if (!term) {
            allLeaves.forEach(leaf => leaf.style.display = 'block');
            return;
        }
        
        allLeaves.forEach(leaf => {
            const text = leaf.textContent.toLowerCase();
            leaf.style.display = text.includes(term) ? 'block' : 'none';
        });
    }

        // Add parameter card to board
        function addParameterCard(item) {
            // Check if already added
            const existingCard = specCards.find(card => card.code === item.code);
            if (existingCard) {
                alert(`Parameter "${item.name}" is already on the board.`);
                return;
            }
            
            // Create card object
            const cardId = `card-${Date.now()}`;
            const card = {
                id: cardId,
                name: item.name,
                code: item.code || '',
                description: item.description || '',
                source: '',
                logic: '',
                timestamp: new Date().toISOString()
            };
            
            specCards.push(card);
            
            // Update UI
            renderCard(card);
            updateStats();
            saveCardsToStorage();
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
        }

        // Render a single card
        function renderCard(card) {
            const board = document.getElementById('spec-board');
            if (!board) {
                console.error('spec-board element not found!');
                return;
            }
            
            const cardHTML = `
                <div class="spec-card" id="${card.id}" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0; color: #0a3b9c;">${card.name}</h4>
                            <small style="color: #666; font-family: 'Courier New', monospace;">${card.code}</small>
                        </div>
                        <button onclick="removeCard('${card.id}')" 
                                style="background: none; border: none; color: #cc0000; cursor: pointer; font-size: 20px; padding: 0 5px; line-height: 1;">√ó</button>
                    </div>
                    
                    ${card.description ? `<p style="margin: 0 0 10px 0; color: #666; font-size: 13px;">${card.description}</p>` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333;">
                            üìç Source Table/Column:
                        </label>
                        <input type="text" 
                               class="card-source" 
                               placeholder="e.g. DBO.PATIENTS.DOB or patients.date_of_birth"
                               value="${card.source}"
                               style="width: 100%; padding: 6px; border: 1px solid #808080; border-radius: 3px; font-size: 13px;"
                               onchange="updateCardField('${card.id}', 'source', this.value)">
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333;">
                            ‚öôÔ∏è ETL Transformation Logic:
                        </label>
                        <textarea class="card-logic" 
                                  placeholder="Describe calculation, filter, or transformation..."
                                  style="width: 100%; min-height: 80px; padding: 6px; border: 1px solid #808080; border-radius: 3px; font-size: 13px; resize: vertical;"
                                  onchange="updateCardField('${card.id}', 'logic', this.value)">${card.logic}</textarea>
                    </div>
                    
                    <div style="margin-top: 10px; font-size: 11px; color: #888; text-align: right;">
                        Added: ${new Date(card.timestamp).toLocaleDateString()}
                    </div>
                </div>
            `;
            
            // Insert at the top
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg && emptyMsg.style.display !== 'none') {
                board.innerHTML = cardHTML;
            } else {
                board.insertAdjacentHTML('afterbegin', cardHTML);
            }
        }

        // Update card field
        function updateCardField(cardId, field, value) {
            const card = specCards.find(c => c.id === cardId);
            if (card) {
                card[field] = value;
                saveCardsToStorage();
                updateStats();
            }
        }

        // Remove card - FIXED FUNCTION
        function removeCard(cardId) {
            console.log('Removing card:', cardId);
            
            // Remove from array
            specCards = specCards.filter(card => card.id !== cardId);
            
            // Remove from DOM
            const cardElement = document.getElementById(cardId);
            if (cardElement) {
                cardElement.remove();
            }
            
            // Show empty message if no cards left
            if (specCards.length === 0) {
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
            }
            
            updateStats();
            saveCardsToStorage();
        }

        // Load saved cards
        function loadSavedCards() {
            const board = document.getElementById('spec-board');
            if (!board) {
                console.error('spec-board element not found!');
                return;
            }
            
            if (specCards.length === 0) {
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
                return;
            }
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Clear and re-render all cards
            board.innerHTML = '';
            specCards.forEach(card => {
                renderCard(card);
            });
        }

        // Save cards to localStorage
        function saveCardsToStorage() {
            localStorage.setItem('nwtSpecCards', JSON.stringify(specCards));
        }

        // Update statistics
        function updateStats() {
            const totalCards = specCards.length;
            const mappedCards = specCards.filter(card => card.source.trim() !== '').length;
            
            const countElement = document.getElementById('card-count');
            const mappedElement = document.getElementById('mapped-count');
            
            if (countElement) {
                countElement.textContent = `${totalCards} parameter${totalCards !== 1 ? 's' : ''} mapped`;
            }
            
            if (mappedElement) {
                mappedElement.textContent = `${mappedCards} with source mapping`;
            }
        }

        // Export to CSV
        function exportSpecToCSV() {
            if (specCards.length === 0) {
                alert('No parameters to export. Add some parameters first.');
                return;
            }
            
            // Create CSV content
            let csvContent = 'data:text/csv;charset=utf-8,';
            
            // Headers
            csvContent += 'Parameter Name,Standard Code,Description,Source Column,ETL Logic\n';
            
            // Data rows
            specCards.forEach(card => {
                const row = [
                    `"${card.name}"`,
                    `"${card.code}"`,
                    `"${card.description || ''}"`,
                    `"${card.source || ''}"`,
                    `"${card.logic.replace(/"/g, '""')}"`
                ].join(',');
                csvContent += row + '\n';
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `nwt_etl_specification_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show confirmation
            alert(`Exported ${specCards.length} parameters to CSV.`);
        }

        // Clear all cards - FIXED FUNCTION
        function clearAllCards() {
            if (specCards.length === 0) {
                alert('No cards to clear.');
                return;
            }
            
            if (confirm(`Are you sure you want to remove all ${specCards.length} parameters from the board?`)) {
                specCards = [];
                saveCardsToStorage();
                
                const board = document.getElementById('spec-board');
                if (board) board.innerHTML = '';
                
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
                
                updateStats();
            }
        }

        // Clear tree - FIXED FUNCTION
        function clearTree() {
            const treeContainer = document.getElementById('treeContainer');
            if (treeContainer) {
                if (confirm('Clear the terminology tree? This will not affect your board.')) {
                    treeContainer.innerHTML = `
                        <div style="color: #666; text-align: center; padding: 20px;">
                            <p>Click "Load Demo Tree" for example terminology.</p>
                            <p>Or enter a search term to query real terminology servers.</p>
                        </div>
                    `;
                }
            }
        }

        // Add a simple test function to check if buttons work
        function testSpecTool() {
            console.log('Testing Spec Tool...');
            console.log('specCards:', specCards);
            console.log('spec-board element:', document.getElementById('spec-board'));
            console.log('treeContainer element:', document.getElementById('treeContainer'));
        }

        // Make sure functions are available globally
        window.loadDemoTerminology = loadDemoTerminology;
        window.addParameterCard = addParameterCard;
        window.removeCard = removeCard;
        window.clearAllCards = clearAllCards;
        window.clearTree = clearTree;
        window.exportSpecToCSV = exportSpecToCSV;
        window.updateCardField = updateCardField;

        // Initialize when Knowledge tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize spec tool when knowledge tab is activated
            const knowledgeTabButton = document.querySelector('[data-tab="knowledge-tab"]');
            if (knowledgeTabButton) {
                knowledgeTabButton.addEventListener('click', function() {
                    console.log('Knowledge tab clicked, initializing spec tool...');
                    setTimeout(initSpecTool, 100);
                });
            }
            
            // Also initialize when page loads if on knowledge tab
            const currentTab = document.querySelector('.tab-button.active');
            if (currentTab && currentTab.dataset.tab === 'knowledge-tab') {
                console.log('Starting on knowledge tab, initializing...');
                setTimeout(initSpecTool, 1000);
            }
        });


        // FREE Ontoserver API Search Function
        // Infoway Terminology Server Function
        async function searchInfowayAPI(searchTerm) {
            try {
                console.log(`üîç Searching Infoway for: ${searchTerm}`);
                
                // Check if using config.js approach
                let INFOWAY_API_KEY;
                let INFOWAY_BASE_URL;
                
                // OPTION 1: Check for global config object (if you created config.js)
                if (typeof API_CONFIG !== 'undefined' && API_CONFIG.INFOWAY) {
                    INFOWAY_API_KEY = API_CONFIG.INFOWAY.API_KEY;
                    INFOWAY_BASE_URL = API_CONFIG.INFOWAY.BASE_URL || 'https://terminology.infoway-inforoute.ca/api';
                    console.log('Using config.js API key');
                }
                // OPTION 2: Check localStorage (if you saved it there)
                else if (localStorage.getItem('infoway_api_key')) {
                    INFOWAY_API_KEY = localStorage.getItem('infoway_api_key');
                    INFOWAY_BASE_URL = 'https://terminology.infoway-inforoute.ca/api';
                    console.log('Using localStorage API key');
                }
                // OPTION 3: Hardcoded in this function (original approach)
                else {
                    INFOWAY_API_KEY = 'YOUR_ACTUAL_API_KEY_HERE'; // ‚Üê Your key should be HERE if not in config.js
                    INFOWAY_BASE_URL = 'https://terminology.infoway-inforoute.ca/api';
                    console.log('Using hardcoded API key');
                }
                
                // VALIDATE KEY
                if (!INFOWAY_API_KEY || 
                    INFOWAY_API_KEY.includes('YOUR_') || 
                    INFOWAY_API_KEY.includes('ihc_your_') ||
                    INFOWAY_API_KEY === 'YOUR_API_KEY_HERE') {
                    throw new Error('Infoway API key not configured. Check config.js or update this function.');
                }
                
                // Make the API call
                const url = `${INFOWAY_BASE_URL}/ValueSet/$expand?url=http://snomed.info/sct?fhir_vs&filter=${encodeURIComponent(searchTerm)}&count=20`;
                
                console.log('Calling Infoway API...');
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/fhir+json',
                        'Authorization': `Bearer ${INFOWAY_API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Infoway API error ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('Infoway response received');
                
                // Process results
                if (data.expansion?.contains) {
                    return data.expansion.contains.map(item => ({
                        code: item.code,
                        system: item.system,
                        display: item.display,
                        source: 'Infoway Canada',
                        description: `${item.display}`,
                        url: item.system ? `${item.system}/${item.code}` : ''
                    }));
                }
                
                return [];
                
            } catch (error) {
                console.error('Infoway search failed:', error);
                throw error;
            }
        }
        // Process Canadian terminology results
        function processInfowayResults(fhirData, searchTerm) {
            const results = [];
            
            if (fhirData.expansion && fhirData.expansion.contains) {
                fhirData.expansion.contains.forEach(item => {
                    // Canadian-specific metadata
                    const isCanadianEdition = item.system && item.system.includes('snomed.info/sct');
                    const canadianTag = isCanadianEdition ? ' üá®üá¶ CA Edition' : '';
                    
                    results.push({
                        code: item.code,
                        system: item.system,
                        display: item.display,
                        fhirType: 'Concept',
                        source: 'Infoway Canada',
                        description: `${item.display}${canadianTag}`,
                        url: item.system ? `${item.system}/${item.code}` : '',
                        // Canadian-specific extensions might be in item.extension
                        extensions: item.extension || []
                    });
                });
            }
            
            // If no results in primary search, try broader search
            if (results.length === 0) {
                console.log('No direct matches, trying broader Canadian search...');
                // Could implement fallback search here
            }
            
            return results;
        }

        // Process FHIR response
        function processOntoserverResults(fhirData) {
            const results = [];
            
            if (fhirData.expansion && fhirData.expansion.contains) {
                fhirData.expansion.contains.forEach(item => {
                    results.push({
                        code: item.code,
                        system: item.system,
                        display: item.display,
                        fhirType: 'Concept',
                        source: 'Ontoserver',
                        description: `SNOMED CT: ${item.display}`,
                        url: `http://snomed.info/id/${item.code}`
                    });
                });
            }
            
            return results;
        }

        // FREE Snowstorm Demo API
        async function searchSnowstormFree(searchTerm) {
            try {
                console.log(`üîç Searching Snowstorm for: ${searchTerm}`);
                
                // Snowstorm demo instance (FREE)
                const url = `https://snowstorm.ihtsdotools.org/snowstorm/snomed-ct/browser/MAIN/SNOMEDCT-US/2023-09-01/concepts?term=${encodeURIComponent(searchTerm)}&limit=20`;
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return processSnowstormResults(data);
                
            } catch (error) {
                console.error('Snowstorm search failed:', error);
                throw error;
            }
        }

        function processSnowstormResults(data) {
            const results = [];
            
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    results.push({
                        code: item.conceptId,
                        system: 'http://snomed.info/sct',
                        display: item.fsn.term,
                        fhirType: 'Concept',
                        source: 'Snowstorm',
                        description: item.fsn.term,
                        url: `http://snomed.info/id/${item.conceptId}`
                    });
                });
            }
            
            return results;
        }

        // Updated search function with FREE APIs
        async function searchTerminology() {
            const searchInput = document.getElementById('treeSearch');
            const searchTerm = searchInput.value.trim();
            const provider = document.getElementById('api-provider').value;
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            const treeContainer = document.getElementById('treeContainer');
            const statusText = document.getElementById('search-status') || 
                              (() => {
                                  const div = document.createElement('div');
                                  div.id = 'search-status';
                                  div.style.padding = '10px';
                                  treeContainer.parentElement.insertBefore(div, treeContainer);
                                  return div;
                              })();
            
            // Show loading
            statusText.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">
                <div style="font-size: 24px;">‚è≥</div>
                <div>Searching ${provider} for "${searchTerm}"...</div>
            </div>`;
            treeContainer.innerHTML = '';
            
            try {
                let results;
                
                switch(provider) {
                    case 'DEMO':
                        // Use your existing demo search
                        searchTerminologyTree({ target: { value: searchTerm } });
                        statusText.innerHTML = '';
                        return;
                        
                    case 'ONTOSERVER':
                        results = await searchOntoserverFree(searchTerm);
                        break;
                        
                    case 'SNOWSTORM':
                        results = await searchSnowstormFree(searchTerm);
                        break;
                        
                    default:
                        throw new Error(`Unknown provider: ${provider}`);
                }
                
                // Display results
                displayAPISearchResults(results, provider, searchTerm);
                statusText.innerHTML = '';
                
            } catch (error) {
                console.error('Search failed:', error);
                statusText.innerHTML = `<div style="color: #f44336; text-align: center; padding: 20px;">
                    <div style="font-size: 24px;">‚ùå</div>
                    <div>Search failed: ${error.message}</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        <button onclick="searchTerminologyTree({target: {value: '${searchTerm}'}})" 
                                style="padding: 5px 10px; background: #0a3b9c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            Use Demo Data Instead
                        </button>
                    </div>
                </div>`;
            }
        }

        // Display API search results
        function displayAPISearchResults(results, provider, searchTerm) {
            const treeContainer = document.getElementById('treeContainer');
            
            if (!results || results.length === 0) {
                treeContainer.innerHTML = `<div style="color: #666; text-align: center; padding: 40px;">
                    <div style="font-size: 36px;">üîç</div>
                    <div>No results found for "${searchTerm}"</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        Source: ${provider}<br>
                        Try different search terms
                    </div>
                </div>`;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 3px;">
                    <strong>Live Results from ${provider}:</strong> ${results.length} concepts found for "${searchTerm}"
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            results.forEach((item, index) => {
                html += `
                    <div class="api-result-item" 
                         style="margin-bottom: 8px; padding: 10px; border: 1px solid #d4d0c8; border-radius: 3px; cursor: pointer;"
                         onclick="addAPIParameterCard(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                         onmouseover="this.style.background='#f0f8ff'" 
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${item.display || item.description}</strong>
                                <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                    Code: ${item.code} | Source: ${item.source}
                                </div>
                            </div>
                            <button style="padding: 2px 8px; font-size: 11px; background: #0a3b9c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                Add +
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            treeContainer.innerHTML = html;
        }

        // Add API result to specification board
        function addAPIParameterCard(item) {
            // Check if already added
            const existingCard = specCards.find(card => card.code === item.code);
            if (existingCard) {
                alert(`"${item.display}" is already on the board.`);
                return;
            }
            
            // Create card object
            const cardId = `card-${Date.now()}`;
            const card = {
                id: cardId,
                name: item.display || item.description,
                code: item.code || '',
                description: item.description || '',
                source: item.source || 'API',
                system: item.system || '',
                logic: '',
                timestamp: new Date().toISOString()
            };
            
            specCards.push(card);
            renderCard(card);
            updateStats();
            saveCardsToStorage();
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Show success message
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: #4CAF50; color: white; border-radius: 3px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    ‚úì Added "${item.display.substring(0, 30)}${item.display.length > 30 ? '...' : ''}"
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Quick search examples
        function quickSearch(term) {
            document.getElementById('treeSearch').value = term;
            searchTerminology();
        }

        // Test the API connection
        function testAPIconnection(provider = 'ONTOSERVER') {
            const testTerms = ['diabetes', 'hypertension', 'vaccine'];
            const term = testTerms[Math.floor(Math.random() * testTerms.length)];
            
            document.getElementById('treeSearch').value = term;
            document.getElementById('api-provider').value = provider;
            
            searchTerminology();
        }
        
        // ================= UPDATE EXISTING FUNCTIONS =================
        
        // Update runSQLQuery to store results for export
        function runSQLQuery() {
            const query = document.getElementById('sql-query')?.value.trim();
            if (!query) {
                alert('Please enter a SQL query to run.');
                return;
            }
            
            if (!db) {
                alert('Database not loaded yet. Please wait.');
                return;
            }
            
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div style="color: blue; padding: 20px; text-align: center;">Executing query...</div>';
            }
            
            try {
                const result = db.exec(query);
                
                if (result.length === 0) {
                    displayQueryResults({ columns: [], values: [] }, 'Query executed (no results)');
                    currentQueryResults = { query, result: { columns: [], values: [] } };
                } else {
                    displayQueryResults(result[0], 'Query Results');
                    // STORE RESULTS FOR EXPORT - THIS IS CRITICAL
                    currentQueryResults = { query, result: result[0] };
                }
                
            } catch (error) {
                // ... error handling ...
            }
        }
        
        // Update previewTableData to store results for export
        function previewTableData(tableName) {
            console.log('DEBUG: previewTableData called with:', tableName);
            
            try {
                if (!db) {
                    alert('Database not loaded.');
                    return;
                }
                
                const resultsDiv = document.getElementById('query-results');
                if (!resultsDiv) {
                    console.error('ERROR: No element with id="query-results"');
                    alert('Cannot find results display area.');
                    return;
                }
                
                resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: blue;">Loading ${tableName}...</div>`;
                
                // Query the table
                const query = `SELECT * FROM ${tableName}`;
                const result = db.exec(query);
                
                if (!result.length || !result[0].values.length) {
                    resultsDiv.innerHTML = `<div style="padding: 20px;">Table "${tableName}" is empty or not found</div>`;
                    currentQueryResults = { query, result: { columns: [], values: [] } };
                    return;
                }
                
                // Display first 20 rows
                const displayResult = db.exec(`SELECT * FROM ${tableName} LIMIT 20`);
                displayQueryResults(displayResult[0], `Table: ${tableName} (showing 20 of ${result[0].values.length} rows)`);
                
                // STORE FULL RESULTS FOR EXPORT
                currentQueryResults = { query, result: result[0] };
                
            } catch (error) {
                // ... error handling ...
            }
        }
        
        // Add export button to table preview
        function addExportButtonToPreview(tableName) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            // Check if export button already exists
            if (!document.getElementById('export-preview-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-preview-btn';
                exportBtn.className = 'btn btn-secondary';
                exportBtn.style.marginTop = '10px';
                exportBtn.innerHTML = 'üíæ Export Full Table to CSV';
                exportBtn.onclick = () => exportTablePreview(tableName);
                
                resultsDiv.appendChild(exportBtn);
            }
        }

        // Analyze client request
        function analyzeClientRequest() {
            const requestText = document.getElementById('client-request')?.value.trim();
            if (!requestText) {
                alert('Please enter a client request to analyze.');
                return;
            }
            
            // Simple keyword analysis
            const analysis = analyzeRequestText(requestText);
            displayAnalysisResults(analysis, requestText);
        }

        // Analyze request text
        function analyzeRequestText(requestText) {
            const requestLower = requestText.toLowerCase();
            
            // Detect tables
            const tables = [];
            if (requestLower.includes('patient')) tables.push('patients');
            if (requestLower.includes('appointment') || requestLower.includes('schedule')) tables.push('appointments');
            if (requestLower.includes('encounter') || requestLower.includes('visit')) tables.push('encounters');
            if (requestLower.includes('diagnosis')) tables.push('diagnoses');
            if (requestLower.includes('lab') || requestLower.includes('test')) tables.push('labs');
            if (requestLower.includes('prescription') || requestLower.includes('medication')) tables.push('prescriptions');
            
            // Default tables if none detected
            if (tables.length === 0) tables.push('patients', 'encounters');
            
            // Generate sample SQL
            let sampleSQL = '';
            if (tables.includes('patients') && tables.includes('encounters')) {
                sampleSQL = `SELECT p.first_name, p.last_name, p.city, e.encounter_date
FROM patients p
JOIN encounters e ON p.patient_id = e.patient_id
WHERE p.province = 'NT'
LIMIT 50`;
            } else if (tables.includes('patients')) {
                sampleSQL = `SELECT first_name, last_name, city, province
FROM patients
WHERE province = 'NT'
LIMIT 50`;
            } else {
                sampleSQL = `SELECT * FROM ${tables[0]} LIMIT 50`;
            }
            
            return {
                suggested_tables: tables,
                suggested_conditions: ['patients.province = "NT"'],
                sample_sql: sampleSQL,
                etl_requirements: [
                    `Extract data from ${tables.length} table(s)`,
                    'Apply appropriate joins between tables',
                    'Filter data based on request criteria',
                    'Include relevant columns for analysis'
                ]
            };
        }

        // Display analysis results
        function displayAnalysisResults(analysis, originalRequest) {
            const resultsDiv = document.getElementById('analysis-results');
            if (!resultsDiv) return;
            
            resultsDiv.style.display = 'block';
            
            // Update UI elements
            const tablesRequired = document.getElementById('tables-required');
            const sqlConditions = document.getElementById('sql-conditions');
            const sampleSql = document.getElementById('sample-sql');
            const etlRequirements = document.getElementById('etl-requirements');
            const sqlQueryBox = document.getElementById('sql-query');
            
            if (tablesRequired) tablesRequired.textContent = analysis.suggested_tables.join(', ');
            if (sqlConditions) sqlConditions.innerHTML = analysis.suggested_conditions.map(c => `<div>‚Ä¢ ${c}</div>`).join('');
            if (sampleSql) sampleSql.textContent = analysis.sample_sql;
            if (etlRequirements) etlRequirements.innerHTML = analysis.etl_requirements.map(r => `<div>‚Ä¢ ${r}</div>`).join('');
            if (sqlQueryBox) sqlQueryBox.value = analysis.sample_sql;
            
            // Save as custom scenario
            saveCustomScenario(originalRequest, analysis);
        }

        // Save custom scenario
        function saveCustomScenario(request, analysis) {
            const scenario = {
                id: Date.now(),
                request: request,
                timestamp: new Date().toISOString(),
                tables: analysis.suggested_tables,
                conditions: analysis.suggested_conditions,
                sql: analysis.sample_sql
            };
            
            customScenarios.push(scenario);
            localStorage.setItem('customScenarios', JSON.stringify(customScenarios));
            
            updateCustomScenariosDropdown();
        }

        // Update custom scenarios dropdown
        function updateCustomScenariosDropdown() {
            const container = document.querySelector('.scenario-container');
            if (!container) return;
            
            container.innerHTML = '<h4 style="margin-top: 20px;">Your Custom Scenarios:</h4>';
            
            if (customScenarios.length === 0) {
                container.innerHTML += '<p>No custom scenarios yet. Analyze a request to create one.</p>';
                return;
            }
            
            // Show last 5 custom scenarios
            customScenarios.slice(-5).reverse().forEach(scenario => {
                const scenarioBox = document.createElement('div');
                scenarioBox.className = 'scenario-box';
                scenarioBox.innerHTML = `
                    <div class="scenario-title">Custom: ${scenario.request.substring(0, 50)}${scenario.request.length > 50 ? '...' : ''}</div>
                    <div class="scenario-desc">${new Date(scenario.timestamp).toLocaleDateString()} - ${scenario.tables.length} tables</div>
                `;
                scenarioBox.addEventListener('click', () => {
                    const clientRequestBox = document.getElementById('client-request');
                    const sqlQueryBox = document.getElementById('sql-query');
                    
                    if (clientRequestBox) clientRequestBox.value = scenario.request;
                    if (sqlQueryBox) sqlQueryBox.value = scenario.sql;
                    
                    analyzeClientRequest();
                });
                container.appendChild(scenarioBox);
            });
        }

        // Load scenario
        function loadScenario(scenarioName) {
            const scenarios = {
                diabetes: {
                    clientRequest: "I need all diabetic patients aged 50+ from Yellowknife",
                    sample_sql: `SELECT p.first_name, p.last_name, p.dob, p.city, d.icd_code, d.description
FROM patients p
JOIN encounters e ON p.patient_id = e.patient_id
JOIN diagnoses d ON e.encounter_id = d.encounter_id
WHERE p.city = 'Yellowknife'
  AND d.icd_code LIKE 'E11%'
LIMIT 50`
                },
                appointments: {
                    clientRequest: "Show all appointments by region for 2024",
                    sample_sql: `SELECT p.province, p.city, a.appt_type, a.appt_start, a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
WHERE a.appt_start >= '2024-01-01'
ORDER BY p.city, a.appt_start
LIMIT 50`
                }
            };
            
            const scenario = scenarios[scenarioName];
            if (scenario) {
                const clientRequestBox = document.getElementById('client-request');
                const sqlQueryBox = document.getElementById('sql-query');
                
                if (clientRequestBox) clientRequestBox.value = scenario.clientRequest;
                if (sqlQueryBox) sqlQueryBox.value = scenario.sample_sql;
                
                analyzeClientRequest();
            }
        }

        // Clear query
        function clearQuery() {
            const sqlQueryBox = document.getElementById('sql-query');
            const resultsDiv = document.getElementById('query-results');
            
            if (sqlQueryBox) sqlQueryBox.value = '';
            if (resultsDiv) resultsDiv.innerHTML = 'Results will appear here...';
        }

        // Save query
        function saveQuery() {
            const query = document.getElementById('sql-query')?.value.trim();
            if (!query) {
                alert('Please enter a query to save.');
                return;
            }
            
            const queryName = prompt('Enter a name for this query:', 'My Query');
            if (queryName) {
                savedQueries.push({
                    name: queryName,
                    query: query,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem('emrSavedQueries', JSON.stringify(savedQueries));
                loadSavedQueries();
                alert('Query saved successfully!');
            }
        }

        // Load saved queries
        function loadSavedQueries() {
            const select = document.getElementById('saved-queries');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a saved query...</option>';
            
            savedQueries.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${q.name} (${new Date(q.timestamp).toLocaleDateString()})`;
                select.appendChild(option);
            });
        }

        // Load a saved query
        function loadSavedQuery() {
            const index = this.value;
            const sqlQueryBox = document.getElementById('sql-query');
            
            if (index && savedQueries[index] && sqlQueryBox) {
                sqlQueryBox.value = savedQueries[index].query;
            }
        }

        // Render schema diagram
        function renderSchemaDiagram() {
            const diagram = document.getElementById('schema-diagram');
            if (!diagram || !window.emrSchema) return;
            
            diagram.innerHTML = '';
            
            Object.keys(window.emrSchema).forEach(tableName => {
                const table = window.emrSchema[tableName];
                const tableNode = document.createElement('div');
                tableNode.className = 'table-node';
                tableNode.innerHTML = `
                    <div class="table-name">${tableName}</div>
                    <div class="table-fields">
                        ${table.columns.slice(0, 5).map(col => 
                            `<div class="table-field">${col.name} (${col.type})</div>`
                        ).join('')}
                        ${table.columns.length > 5 ? 
                            `<div class="table-field">... ${table.columns.length - 5} more fields</div>` : ''}
                    </div>
                `;
                diagram.appendChild(tableNode);
            });
        }

        // Render table selector
        function renderTableSelector() {
            const selector = document.getElementById('table-selector');
            if (!selector || !window.emrSchema) return;
            
            selector.innerHTML = '';
            
            Object.keys(window.emrSchema).forEach(tableName => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" class="table-checkbox" value="${tableName}">
                    ${tableName} (${window.emrSchema[tableName].columns.length} fields)
                `;
                selector.appendChild(label);
            });
        }

        // Create status div for database loading
        function createStatusDiv() {
            const emrTab = document.getElementById('emr-tab');
            if (!emrTab) return null;
            
            const statusDiv = document.createElement('div');
            statusDiv.id = 'database-status';
            statusDiv.style.cssText = `
                padding: 10px;
                margin: 10px 0;
                background: #f0f8ff;
                border: 1px solid #a0c0ff;
                border-radius: 3px;
                font-size: 14px;
            `;
            
            emrTab.insertBefore(statusDiv, emrTab.firstChild);
            return statusDiv;
        }

        // ============================================
        // FORM TAB FUNCTIONS (Keep your existing code)
        // ============================================
        
        // Update organization variable
        function updateOrganization() {
            const dhss = document.getElementById('dhss').checked;
            const hssa = document.getElementById('hssa').checked;
            const otherOrg = document.getElementById('other-org').checked;
            const otherText = document.getElementById('other-org-text').value;
            
            let org = "";
            if (dhss) {
                org = "DHSS";
            } else if (hssa) {
                org = "HSSA";
            } else if (otherOrg) {
                org = otherText ? `Other: ${otherText}` : "Other";
            }
            
            const orgInput = document.getElementById('organization');
            if (orgInput) orgInput.value = org;
        }

        // Validate form
        function validateForm() {
            clearValidationErrors();
            let hasErrors = false;

            // Organization check
            const dhss = document.getElementById('dhss')?.checked;
            const hssa = document.getElementById('hssa')?.checked;
            const otherOrg = document.getElementById('other-org')?.checked;
            if ((!dhss && !hssa && !otherOrg)) {
                showValidationError('org-error', 'Compliance Rule: You must select DHSS, HSSA, or Other.');
                hasErrors = true;
            }

            // NEW: Request Number Validation
            const requestNumber = document.getElementById('request-number')?.value.trim();
    
            if (requestNumber && isDuplicateRequestNumber(requestNumber)) {
                showValidationError('reqnum-error', 'This Request Number already exists. Use a unique number.');
                document.getElementById('request-number')?.classList.add('validation-error');
                hasErrors = true;
            }
             else if (!isValidRequestNumber(requestNumber)) {
                showValidationError('reqnum-error', 'Invalid format. Must be like: IM-703546 (letters, dash, numbers)');
                document.getElementById('request-number')?.classList.add('validation-error');
                hasErrors = true;
            }

            // Request history
            const requestHistory = document.querySelector('input[name="request-history"]:checked');
            if (!requestHistory) {
                showValidationError('history-error', 'Compliance Rule: You must select First Original or Recurring.');
                hasErrors = true;
            }

            // Legislative Authority
            const legislative = document.querySelector('input[name="legislative"]:checked');
            if (!legislative) {
                showValidationError('legislative-error', 'Compliance Rule: You must select Yes or No for Legislative Authority.');
                hasErrors = true;
            }

            // If Legislative Authority is Yes, description required
            if (legislative && legislative.value === "yes") {
                const legDesc = document.getElementById('legislative-desc')?.value.trim();
                if (!legDesc) {
                    showValidationError('legdesc-error', 'Compliance Rule: If Legislative Authority is Yes, you must describe it.');
                    document.getElementById('legislative-desc')?.classList.add('validation-error');
                    hasErrors = true;
                }
            }

            // Statutory Owner
            const statutory = document.querySelector('input[name="statutory"]:checked');
            if (!statutory) {
                showValidationError('statutory-error', 'Compliance Rule: You must select Yes or No for Statutory Owner.');
                hasErrors = true;
            }

            // Agreement Requirement
            const agreement = document.querySelector('input[name="agreement"]:checked');
            if (!agreement) {
                showValidationError('agreement-error', 'Compliance Rule: You must select Yes or No for Agreement Requirement.');
                hasErrors = true;
            }

            // Data Matching
            const matching = document.querySelector('input[name="matching"]:checked');
            if (!matching) {
                showValidationError('matching-error', 'Compliance Rule: You must select Yes or No for Data Matching.');
                hasErrors = true;
            }

            // Meeting Requirement
            const meeting = document.querySelector('input[name="meeting"]:checked');
            if (!meeting) {
                showValidationError('meeting-error', 'Compliance Rule: You must select Yes or No for Meeting Requirement.');
                hasErrors = true;
            }

            // Location
            const region = document.getElementById('region')?.value;
            const district = document.getElementById('district')?.value;
            if (!region || !district) {
                showValidationError('location-error', 'Compliance Rule: You must select both Region and District for Location.');
                if (!region) document.getElementById('region')?.classList.add('validation-error');
                if (!district) document.getElementById('district')?.classList.add('validation-error');
                hasErrors = true;
            }

            // Defined Purpose
            const definedPurpose = document.getElementById('defined-purpose')?.value.trim();
            if (!definedPurpose) {
                showValidationError('purpose-error', 'Compliance Rule: You must enter a Defined Purpose.');
                document.getElementById('defined-purpose')?.classList.add('validation-error');
                hasErrors = true;
            }

            return !hasErrors;
       }

        function showValidationError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearValidationErrors() {
            document.querySelectorAll('.validation-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('validation-error');
            });
        }

        // NEW: Request Number Format Validation
        function isValidRequestNumber(requestNum) {
            // Pattern: letters (2-4), dash, numbers (4-6)
            // Examples: IM-703546, DHSS-24001, HSSA-98765
            const pattern = /^[A-Z]{2,4}-\d{4,6}$/;
            return pattern.test(requestNum);

        // Get form data
        return {
            id: nextId++,
            organization: org,
            request_number: requestNumber,
            requestor: requestor,
            classification: classification,
            request_history: requestHistory === 'first' ? 'First Original' : `Recurring: ${recurringDate}`,
            legislative_authority: legislative,
            legislative_description: legislativeDesc,
            conditions: conditions,
            conditions_description: conditionsDesc,
            statutory_owner: statutory,
            statutory_selected: statutorySelected,
            statutory_other: statutoryOther,
            defined_purpose: definedPurpose,
            agreement_required: agreement,
            existing_agreement: existingAgreement ? 'Yes' : 'No',
            agreement_description: agreementDesc,
            data_matching: matching,
            matching_description: matchingDesc,
            meeting_required: meeting,
            meeting_description: meetingDesc,
            region: region,
            district: district,
            data_type_specification: dataTypeSpec,
            data_request_frequency: dataRequestFrequency,
            comments: comments,
            
            // NEW FIELDS FOR DASHBOARD
            date_received: document.getElementById('date-received').value,
            date_completed: document.getElementById('date-completed').value,
            request_status: document.getElementById('request-status').value,
            timestamp: new Date().toISOString()
        };
    }

        // Save request
       function saveRequest() {
            if (!validateForm()) {
                alert("Cannot save: Please fix all validation errors.");
                return;
            }
            
            const formData = getFormData();
            
            // Double-check request number is saved
            if (!formData.request_number) {
                alert("Error: Request Number is required!");
                return;
            }
            
            // Check for duplicate
            if (isDuplicateRequestNumber(formData.request_number)) {
                alert("Error: Request Number already exists!");
                return;
            }
            
            // Add to storage
            requestsData.push(formData);
            localStorage.setItem('dataRequests', JSON.stringify(requestsData));
            
            // Clear and refresh
            clearForm();
            loadTableData();
            
            alert(`Data request saved successfully!\nRequest Number: ${formData.request_number}`);
        }

        // Load table data for form tab
        function loadTableData() {
            const tbody = document.getElementById('table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (requestsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No requests saved yet.</td></tr>';
                return;
            }
            
            const sortedData = [...requestsData].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedData.forEach(data => {
                const row = document.createElement('tr');
                
                const legislativeAuth = data.legislative_authority === 'yes' ? 
                    `Yes: ${data.legislative_description.substring(0, 100)}...` : 'No';
                
                const definedPurpose = data.defined_purpose.length > 50 ? 
                    data.defined_purpose.substring(0, 50) + '...' : data.defined_purpose;
                
                const location = `${data.region} / ${data.district}`;
                
                // UPDATED: Added request_number column
                row.innerHTML = `
                    <td>${data.id}</td>
                    <td><strong style="color: #0a3b9c; font-family: 'Courier New', monospace;">${data.request_number}</strong></td>
                    <td>${data.organization}</td>
                    <td>${legislativeAuth}</td>
                    <td>${definedPurpose}</td>
                    <td>${data.timestamp}</td>
                    <td>${location}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        // Clear form
        function clearForm() {
            clearValidationErrors();
            
            // Organization
            document.querySelectorAll('.org-checkbox').forEach(cb => cb.checked = false);
            const otherOrgText = document.getElementById('other-org-text');
            if (otherOrgText) otherOrgText.value = '';
            const orgInput = document.getElementById('organization');
            if (orgInput) orgInput.value = '';
            
            // Request details
            const requestNumber = document.getElementById('request-number');
            if (requestNumber) requestNumber.value = '';
            const requestor = document.getElementById('requestor');
            if (requestor) requestor.value = '';
            const classification = document.getElementById('classification');
            if (classification) classification.value = '';
            const recurringDate = document.getElementById('recurring-date');
            if (recurringDate) recurringDate.value = '';
            const firstRadio = document.querySelector('input[name="request-history"][value="first"]');
            if (firstRadio) firstRadio.checked = true;
            
            // Legislative
            document.querySelectorAll('input[name="legislative"]').forEach(r => r.checked = false);
            const legislativeDesc = document.getElementById('legislative-desc');
            if (legislativeDesc) legislativeDesc.value = '';
            
            // Conditions
            document.querySelectorAll('input[name="conditions"]').forEach(r => r.checked = false);
            const conditionsDesc = document.getElementById('conditions-desc');
            if (conditionsDesc) conditionsDesc.value = '';
            
            // Statutory
            document.querySelectorAll('input[name="statutory"]').forEach(r => r.checked = false);
            document.querySelectorAll('.statutory-option').forEach(cb => cb.checked = false);
            const statutoryOther = document.getElementById('statutory-other');
            if (statutoryOther) statutoryOther.value = '';
            
            // Agreement
            document.querySelectorAll('input[name="agreement"]').forEach(r => r.checked = false);
            const existingAgreement = document.getElementById('existing-agreement');
            if (existingAgreement) existingAgreement.checked = false;
            const agreementDesc = document.getElementById('agreement-desc');
            if (agreementDesc) agreementDesc.value = '';
            
            // Data Matching
            document.querySelectorAll('input[name="matching"]').forEach(r => r.checked = false);
            const matchingDesc = document.getElementById('matching-desc');
            if (matchingDesc) matchingDesc.value = '';
            
            // Meeting
            document.querySelectorAll('input[name="meeting"]').forEach(r => r.checked = false);
            const meetingDesc = document.getElementById('meeting-desc');
            if (meetingDesc) meetingDesc.value = '';
            
            // Location
            const regionSelect = document.getElementById('region');
            const districtSelect = document.getElementById('district');
            if (regionSelect) regionSelect.value = '';
            if (districtSelect) {
                districtSelect.value = '';
                districtSelect.disabled = true;
                districtSelect.innerHTML = '<option value="">Select District</option>';
            }

            // NEW FIELDS - ADD THESE:
            const dataTypeSpecs = document.getElementById('data-type-specs');
            const frequencyFeasibility = document.getElementById('frequency-feasibility');
            
            if (dataTypeSpecs) dataTypeSpecs.value = '';
            if (frequencyFeasibility) frequencyFeasibility.value = '';
            
            // Other
            const definedPurpose = document.getElementById('defined-purpose');
            if (definedPurpose) definedPurpose.value = '';
            const comments = document.getElementById('comments');
            if (comments) comments.value = '';
        }
    </script>
</body>

</html>