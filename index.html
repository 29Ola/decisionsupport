<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Data Explorer - NWT Government</title>
    <!-- üõ°Ô∏è COMPLETE FAVICON SET -->
    <!-- Primary shield icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <!-- Apple devices -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <!-- Windows 8/10 -->
    <meta name="msapplication-TileColor" content="#0a3b9c">
    <meta name="theme-color" content="#0a3b9c">
    <style>
        /* Windows XP/2000 Theme Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', Arial, sans-serif;
            background-color: #ece9d8;
            color: #000;
            line-height: 1.4;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #ece9d8;
            border: 2px outset #d4d0c8;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: linear-gradient(to bottom, #245edc, #424d63);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid #424d63;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            background-color: #d4d0c8;
            border-bottom: 2px solid #ffffff;
            padding: 5px 5px 0;
        }

        .tab-button {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            border: 1px solid #808080;
            border-bottom: none;
            padding: 8px 20px;
            margin-right: 5px;
            cursor: pointer;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
            color: #000;
            border-radius: 4px 4px 0 0;
            position: relative;
            top: 2px;
        }

        .tab-button:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }

        .tab-button.active {
            background: linear-gradient(to bottom, #ffffff, #d4d0c8);
            border-bottom: 2px solid #ece9d8;
            z-index: 1;
        }

        .tab-content {
            background-color: #ffffff;
            border: 1px solid #808080;
            border-top: none;
            padding: 20px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-container {
            background-color: #ffffff;
            border: 2px inset #d4d0c8;
            margin-bottom: 20px;
            padding: 20px;
        }

        .form-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            padding: 10px 15px;
            border-bottom: 1px solid #d4d0c8;
            margin-bottom: 20px;
        }

        .form-header h2 {
            font-size: 18px;
            color: #000;
        }

        .form-columns {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-column {
            background-color: #f8f8f8;
            border: 1px solid #d4d0c8;
            padding: 15px;
            border-radius: 3px;
        }

        .form-column h3 {
            background-color: #e8e8e8;
            padding: 8px 10px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid #d4d0c8;
            font-size: 16px;
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #808080;
            background-color: #ffffff;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
        }

        .form-control:focus {
            outline: 2px solid #245edc;
            border-color: #245edc;
        }

        .textarea-small {
            min-height: 80px;
            resize: vertical;
        }

        .textarea-medium {
            min-height: 100px;
            resize: vertical;
        }

        .textarea-large {
            min-height: 150px;
            resize: vertical;
        }

        .checkbox-group, .radio-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .checkbox-label, .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            cursor: pointer;
            font-size: 14px;
        }

        .small-input {
            width: 120px;
            padding: 4px 6px;
            border: 1px solid #808080;
            margin-left: 5px;
        }

        .date-input {
            width: 100px;
            padding: 4px 6px;
            border: 1px solid #808080;
            margin-left: 5px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #d4d0c8;
        }

        .btn {
            padding: 8px 20px;
            border: 1px solid #808080;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(to bottom, #245edc, #0a3b9c);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(to bottom, #3a7afc, #1a5bbc);
        }

        .btn-secondary {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            color: #000;
        }

        .btn-secondary:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }

        .table-container {
            background-color: #ffffff;
            border: 2px inset #d4d0c8;
            padding: 20px;
        }

        .table-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            padding: 10px 15px;
            border-bottom: 1px solid #d4d0c8;
            margin-bottom: 15px;
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid #d4d0c8;
        }

        #requests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #requests-table thead {
            background: linear-gradient(to bottom, #245edc, #0a3b9c);
            color: white;
        }

        #requests-table th {
            padding: 10px;
            text-align: left;
            border: 1px solid #0a3b9c;
            font-weight: bold;
        }

        #requests-table tbody tr {
            border-bottom: 1px solid #d4d0c8;
        }

        #requests-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        #requests-table tbody tr:hover {
            background-color: #e8f0ff;
        }

        #requests-table td {
            padding: 8px 10px;
            border: 1px solid #d4d0c8;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .footer {
            background-color: #d4d0c8;
            padding: 10px 20px;
            text-align: center;
            border-top: 2px solid #ffffff;
            font-size: 12px;
            color: #000;
        }

        /* VBA-style validation messages */
        .validation-error {
            border: 2px solid red !important;
            background-color: #fff0f0 !important;
        }

        .validation-message {
            color: red;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }

        /* NEW: EMR Explorer Styles */
        .emr-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .emr-section {
            flex: 1;
            min-width: 300px;
            background-color: #f8f8f8;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .emr-section-header {
            background-color: #e8e8e8;
            padding: 8px 10px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid #d4d0c8;
            font-size: 16px;
            color: #000;
        }

        .schema-diagram {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 300px;
            overflow: auto;
        }

        .table-node {
            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
            border: 1px solid #808080;
            border-radius: 3px;
            padding: 8px;
            margin: 10px;
            display: inline-block;
            min-width: 150px;
            box-shadow: 2px 2px 3px rgba(0,0,0,0.1);
        }

        .table-name {
            font-weight: bold;
            color: #0a3b9c;
            border-bottom: 1px solid #d4d0c8;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .table-field {
            font-size: 12px;
            padding: 2px 0;
            font-family: 'Courier New', monospace;
        }

        .relationship-line {
            margin: 0 10px;
            color: #666;
            font-size: 12px;
        }

        .query-builder {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 200px;
        }

        .query-input {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #808080;
            padding: 8px;
            background-color: #f8f8f8;
        }

        .query-results {
            background-color: white;
            border: 1px solid #d4d0c8;
            padding: 10px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .scenario-box {
            background-color: #e8f0ff;
            border: 1px solid #a0c0ff;
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .scenario-box:hover {
            background-color: #d0e0ff;
        }

        .scenario-title {
            font-weight: bold;
            color: #0a3b9c;
            margin-bottom: 5px;
        }

        .scenario-desc {
            font-size: 12px;
            color: #333;
        }

        .sql-preview {
            background-color: #2b2b2b;
            color: #f8f8f8;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .highlight {
            background-color: #ffff88;
            padding: 2px;
        }

        .table-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d4d0c8;
            padding: 10px;
        }

        .table-item {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
        }

        .table-item:hover {
            background-color: #e8f0ff;
        }

        .table-item.selected {
            background-color: #d0e0ff;
            border-left: 3px solid #0a3b9c;
        }

        @media (max-width: 1200px) {
            .form-columns {
                grid-template-columns: repeat(2, 1fr);
            }
            .emr-container {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .form-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Accordion Styles */
        .accordion {
            margin-bottom: 10px;
        }
        
        .accordion-header {
            background: linear-gradient(to bottom, #d4d0c8, #a0a0a0);
            border: 1px solid #808080;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 3px;
        }
        
        .accordion-header:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }
        
        .accordion-header.active {
            background: linear-gradient(to bottom, #ffffff, #d4d0c8);
            border-bottom: 1px solid #ffffff;
        }
        
        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(45deg); /* Plus to X */
        }
        
        .accordion-content {
            border: 1px solid #808080;
            border-top: none;
            padding: 15px;
            background-color: #ffffff;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        /* Scrollable sections */
        .scrollable-section {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #d4d0c8;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* Fixed height for query results */
        .fixed-height-results {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Compact layout */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .compact-section {
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            background: #f8f8f8;
        }

        /* Style for the new important sections */
        .data-guidance-section {
            background-color: #f0f8ff;
            border: 2px solid #a0c0ff;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .data-guidance-section label {
            color: #0a3b9c;
            font-weight: bold;
        }
        
        .data-guidance-section textarea {
            background-color: #ffffff;
            border: 1px solid #245edc;
        }
        
        /* Help bubble styling */
        .help-bubble {
            cursor: help;
            background: #0a3b9c;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            font-weight: bold;
            font-size: 12px;
            vertical-align: middle;
        }
        
        .help-bubble:hover {
            background: #3a7afc;
            transform: scale(1.1);
        }

        /* Intelligence Accordion Styles */
        .intelligence-container {
            padding: 20px;
            background: #f8faff;
            border: 1px solid #a0c0ff;
            border-radius: 3px;
        }
        
        .intelligence-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0a3b9c;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .intelligence-section {
            background: white;
            border: 1px solid #d4d0c8;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .intelligence-section h4 {
            margin-top: 0;
            color: #0a3b9c;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .request-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .request-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .request-item:hover {
            background: #f0f8ff;
        }
        
        .request-id {
            font-weight: bold;
            color: #0a3b9c;
        }
        
        .request-purpose {
            flex-grow: 1;
            margin: 0 15px;
            font-size: 13px;
        }
        
        .request-match {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .recommendation-card {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: #fff8e1;
            border-left: 4px solid #FF9800;
            margin-bottom: 8px;
            border-radius: 2px;
        }
        
        .rec-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .rec-content {
            flex-grow: 1;
            font-size: 13px;
        }
        
        .intelligence-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
    </style>
    <!-- SQL.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Info Management Task Utility & Decision Support</h1>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-button active" data-tab="form-tab">Data Request Analysis</button>
                <button class="tab-button" data-tab="knowledge-tab">Knowledge Management</button>
                <button class="tab-button" data-tab="dashboard-tab">Dashboard</button>
                <button class="tab-button" data-tab="emr-tab">EMR Data Explorer</button>
            </div>

            <div class="tab-content">
                <!-- FORM TAB -->
                <!-- FORM TAB -->
                <div id="form-tab" class="tab-pane active">
                    <!-- ================= ACCORDION 1: DATA REQUEST FORM ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="data-request">
                            <span>üìã Data Request Form</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-data-request">
                            <div class="form-container">
                                <div class="form-header">
                                    <h2>Data Request Form</h2>
                                </div>
                                
                                <div class="form-columns">
                                    <!-- COLUMN 1 -->
                                    <div class="form-column">
                                        <h3>Request Information</h3>
                                        
                                        <div class="form-group">
                                            <label>Data Request Identification:</label>
                                            <div class="checkbox-group">
                                                <label class="checkbox-label">
                                                    <input type="checkbox" id="dhss" class="org-checkbox">
                                                    DHSS
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" id="hssa" class="org-checkbox">
                                                    HSSA
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" id="other-org" class="org-checkbox">
                                                    Other:
                                                </label>
                                                <input type="text" id="other-org-text" placeholder="Specify" class="small-input">
                                            </div>
                                            <input type="hidden" id="organization" value="">
                                            <div class="validation-message" id="org-error"></div>
                                        </div>
                
                                        <div class="form-group">
                                            <label for="request-number">Data Request Number:</label>
                                            <input type="text" 
                                                   id="request-number" 
                                                   class="form-control" 
                                                   required
                                                   pattern="[A-Z]{2,4}-\d{4,6}"
                                                   title="Format: IM-703546 (2-4 letters, dash, 4-6 numbers)"
                                                   placeholder="e.g., IM-703546, DHSS-24001">
                                            <div class="validation-message" id="reqnum-error"></div>
                                        </div>
                
                                        <div class="form-group">
                                            <label for="requestor">Data Requestor's Name/Org:</label>
                                            <input type="text" id="requestor" class="form-control">
                                        </div>
                
                                        <div class="form-group">
                                            <label for="classification">
                                                Data Request Classification:
                                                <span class="help-bubble" onclick="showClassificationHelp()" 
                                                      style="cursor: help; 
                                                             background: #0a3b9c; 
                                                             color: white; 
                                                             width: 18px; 
                                                             height: 18px; 
                                                             border-radius: 50%; 
                                                             display: inline-flex; 
                                                             align-items: center; 
                                                             justify-content: center; 
                                                             margin-left: 8px; 
                                                             font-weight: bold;
                                                             font-size: 12px;
                                                             vertical-align: middle;">?</span>
                                            </label>
                                            <input type="text" id="classification" class="form-control">
                                        </div>
                
                                        <div class="form-group">
                                            <label>Data Request History:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="request-history" value="first" checked>
                                                    Request is first original
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="request-history" value="recurring">
                                                    Request occurred in past submitted on:
                                                    <input type="text" id="recurring-date" placeholder="yyyy-mm-dd" class="date-input">
                                                </label>
                                            </div>
                                            <div class="validation-message" id="history-error"></div>
                                        </div>
                                    </div>
                
                                    <!-- COLUMN 2 -->
                                    <div class="form-column">
                                        <h3>Legal & Conditions</h3>
                                        
                                        <div class="form-group">
                                            <label>Legislative Authority:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="legislative" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="legislative" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <div class="validation-message" id="legislative-error"></div>
                                            <label for="legislative-desc">If Yes, describe authority:</label>
                                            <textarea id="legislative-desc" class="form-control textarea-small" rows="4"></textarea>
                                            <div class="validation-message" id="legdesc-error"></div>
                                        </div>
                
                                        <div class="form-group">
                                            <label>Conditions / Client Instructions:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="conditions" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="conditions" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <label for="conditions-desc">If Yes, describe conditions:</label>
                                            <input type="text" id="conditions-desc" class="form-control">
                                        </div>
                
                                        <div class="form-group">
                                            <label>Location:</label>
                                            <label for="region">Region:</label>
                                            <select id="region" class="form-control">
                                                <option value="">Select Region</option>
                                                <option value="Beaufort Delta Region">Beaufort Delta Region</option>
                                                <option value="Dehcho Region">Dehcho Region</option>
                                                <option value="Sahtu Region">Sahtu Region</option>
                                                <option value="South Slave Region">South Slave Region</option>
                                                <option value="T≈ÇƒØch«´ Region">T≈ÇƒØch«´ Region</option>
                                                <option value="Yellowknife Region">Yellowknife Region</option>
                                            </select>
                                            
                                            <label for="district">District:</label>
                                            <select id="district" class="form-control" disabled>
                                                <option value="">Select District</option>
                                            </select>
                                            <div class="validation-message" id="location-error"></div>
                                        </div>
                                    </div>
                
                                    <!-- COLUMN 3 -->
                                    <div class="form-column">
                                        <h3>Purpose & Agreements</h3>
                                        
                                        <div class="form-group">
                                            <label for="defined-purpose">
                                                Defined Purpose:
                                                <span class="help-bubble" onclick="showPurposeHelp()" 
                                                      style="cursor: help; 
                                                             background: #0a3b9c; 
                                                             color: white; 
                                                             width: 18px; 
                                                             height: 18px; 
                                                             border-radius: 50%; 
                                                             display: inline-flex; 
                                                             align-items: center; 
                                                             justify-content: center; 
                                                             margin-left: 8px; 
                                                             font-weight: bold;
                                                             font-size: 12px;
                                                             vertical-align: middle;">?</span>
                                            </label>
                                            <textarea id="defined-purpose" class="form-control textarea-medium" rows="5" required></textarea>
                                            <div class="validation-message" id="purpose-error"></div>
                                        </div>
                
                                        <div class="form-group">
                                            <label>Statutory Owner:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="statutory" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="statutory" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <div class="validation-message" id="statutory-error"></div>
                                            
                                            <label>If Yes, identify statutory appointment:</label>
                                            <div class="checkbox-group">
                                                <label class="checkbox-label">
                                                    <input type="checkbox" class="statutory-option" value="Director, Medical Insurance">
                                                    Director, Medical Insurance
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" class="statutory-option" value="Registrar, Vital Statistics">
                                                    Registrar, Vital Statistics
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" class="statutory-option" value="Registrar, Professional Licensing">
                                                    Registrar, Professional Licensing
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" class="statutory-option" value="Chief Public Health Officer">
                                                    Chief Public Health Officer
                                                </label>
                                                <label class="checkbox-label">
                                                    <input type="checkbox" class="statutory-option" value="Other">
                                                    Other
                                                </label>
                                            </div>
                                            
                                            <label for="statutory-other">If Other, describe:</label>
                                            <input type="text" id="statutory-other" class="form-control">
                                        </div>
                                    </div>
                
                                    <!-- COLUMN 4 -->
                                    <div class="form-column">
                                        <h3>Data & Meetings</h3>
                                        
                                        <div class="form-group">
                                            <label>Agreement Requirement:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="agreement" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="agreement" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <div class="validation-message" id="agreement-error"></div>
                                            
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="existing-agreement">
                                                Existing Agreement: Yes
                                            </label>
                                            
                                            <label for="agreement-desc">Agreement Details:</label>
                                            <input type="text" id="agreement-desc" class="form-control">
                                        </div>
                
                                        <div class="form-group">
                                            <label>Data Matching:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="matching" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="matching" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <div class="validation-message" id="matching-error"></div>
                                            
                                            <label for="matching-desc">Describe Data Matching:</label>
                                            <input type="text" id="matching-desc" class="form-control">
                                        </div>
                
                                        <div class="form-group">
                                            <label>Meeting Requirement:</label>
                                            <div class="radio-group">
                                                <label class="radio-label">
                                                    <input type="radio" name="meeting" value="yes">
                                                    Yes
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="meeting" value="no">
                                                    No
                                                </label>
                                            </div>
                                            <div class="validation-message" id="meeting-error"></div>
                                            
                                            <label for="meeting-desc">Meeting Details:</label>
                                            <input type="text" id="meeting-desc" class="form-control">
                                        </div>
                                        
                                        <!-- NEW: Data Type Specification -->
                                        <div class="form-group data-guidance-section">
                                            <label for="data-type-spec">
                                                Data Type Specification:
                                                <span class="help-bubble" onclick="showDataTypeHelp()" 
                                                      style="cursor: help; 
                                                             background: #0a3b9c; 
                                                             color: white; 
                                                             width: 18px; 
                                                             height: 18px; 
                                                             border-radius: 50%; 
                                                             display: inline-flex; 
                                                             align-items: center; 
                                                             justify-content: center; 
                                                             margin-left: 8px; 
                                                             font-weight: bold;
                                                             font-size: 12px;
                                                             vertical-align: middle;">?</span>
                                            </label>
                                            <textarea id="data-type-spec" class="form-control textarea-small" rows="4" 
                                                      placeholder="Specify the exact data elements needed, distinguishing between parameters and elements..."></textarea>
                                        </div>
                                    
                                        <!-- NEW: Data Request Frequency -->
                                        <div class="form-group data-guidance-section">
                                            <label for="data-request-frequency">
                                                Data Request Frequency:
                                                <span class="help-bubble" onclick="showFrequencyHelp()" 
                                                      style="cursor: help; 
                                                             background: #0a3b9c; 
                                                             color: white; 
                                                             width: 18px; 
                                                             height: 18px; 
                                                             border-radius: 50%; 
                                                             display: inline-flex; 
                                                             align-items: center; 
                                                             justify-content: center; 
                                                             margin-left: 8px; 
                                                             font-weight: bold;
                                                             font-size: 12px;
                                                             vertical-align: middle;">?</span>
                                            </label>
                                            <textarea id="data-request-frequency" class="form-control textarea-small" rows="4"
                                                      placeholder="Specify initial extract dates and recurring logic..."></textarea>
                                        </div>
                
                                        <div class="form-group">
                                            <label for="comments">Additional Comments:</label>
                                            <textarea id="comments" class="form-control textarea-small" rows="4"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-buttons">
                                    <button id="save-btn" class="btn btn-primary">Save Request</button>
                                    <button id="clear-btn" class="btn btn-secondary">Clear Form</button>
                                    <button id="refresh-btn" class="btn btn-secondary">Refresh Table</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ================= NEW: REQUEST INTELLIGENCE ACCORDION ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="request-intelligence">
                            <span>üí° Request Intelligence & Recommendations</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-request-intelligence">
                            <!-- Intelligence Panel Content Goes Here -->
                            <div class="intelligence-container">
                                
                                <!-- Row 1: Quick Stats -->
                                <div class="intelligence-stats">
                                    <div class="stat-card">
                                        <div class="stat-value" id="similar-count">0</div>
                                        <div class="stat-label">Similar Requests</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="confidence-score">0%</div>
                                        <div class="stat-label">Match Confidence</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="avg-days">--</div>
                                        <div class="stat-label">Avg. Approval Days</div>
                                    </div>
                                    <div class="stat-card">
                                        <button onclick="analyzeCurrentRequest()" class="btn btn-primary">
                                            üîç Analyze Request
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Row 2: Similar Requests -->
                                <div class="intelligence-section">
                                    <h4>üìö Similar Historical Requests</h4>
                                    <div id="similar-requests-list" class="request-list">
                                        <div class="empty-state">
                                            Start typing in the form above to see similar requests...
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Row 3: Recommendations -->
                                <div class="intelligence-section">
                                    <h4>üí° Smart Recommendations</h4>
                                    <div id="recommendations-list">
                                        <div class="recommendation-card">
                                            <div class="rec-icon">‚öñÔ∏è</div>
                                            <div class="rec-content">
                                                <strong>Legislative Authority:</strong>
                                                <span>Based on similar requests, consider: Public Health Act Section 12</span>
                                            </div>
                                        </div>
                                        <!-- More recommendations will appear here -->
                                    </div>
                                </div>
                                
                                <!-- Row 4: Quick Actions -->
                                <div class="intelligence-actions">
                                    <button onclick="showComparisonView()" class="btn btn-secondary">
                                        üîÑ Compare with Precedents
                                    </button>
                                    <button onclick="showClusterAnalysis()" class="btn btn-secondary">
                                        üåç View Cluster Analysis
                                    </button>
                                    <button onclick="generateRecommendationReport()" class="btn btn-primary">
                                        üì• Download Intelligence Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- ================= ACCORDION 2: REQUEST RESULTS TABLE ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="request-results">
                            <span>üìä Request Summary Table</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-request-results">
                            <div class="table-container">
                                <div class="table-header">
                                    <h2>Request Summary Table</h2>
                                </div>
                                <div class="table-wrapper">
                                    <table id="requests-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Request Number</th>
                                                <th>Organization</th>
                                                <th>Legislative Authority</th>
                                                <th>Defined Purpose</th>
                                                <th>Timestamp</th>
                                                <th>Location</th>
                                            </tr>
                                        </thead>
                                        <tbody id="table-body">
                                            <!-- Table rows will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 3: ADDITIONAL FUNCTIONALITIES (Placeholder) ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="additional-functions">
                            <span>‚öôÔ∏è Additional Tools (Coming Soon)</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-additional-functions">
                            <div style="padding: 20px; text-align: center;">
                                <h3>Future Functionalities</h3>
                                <p>Additional tools and features will be added here.</p>
                                <ul style="text-align: left; display: inline-block; margin: 20px auto;">
                                    <li>Request Analytics Dashboard</li>
                                    <li>Export to PDF/Excel</li>
                                    <li>Bulk Import/Export</li>
                                    <li>Advanced Filtering</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KNOWLEDGE TAB -->
                <!-- Replace the entire KNOWLEDGE TAB section with this: -->
                <div id="knowledge-tab" class="tab-pane">
                    <!-- ================= ACCORDION 1: TERMINOLOGY MAPPER ================= -->
                    <div class="accordion">
                        <div class="accordion-header active" data-accordion="spec-tool">
                            <span>üìã Data Specification Tool (FHIR/SNOMED Mapper)</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content active" id="accordion-spec-tool">
                            <!-- Two-column layout for the spec tool -->
                            <div style="display: flex; height: 600px; gap: 15px; padding: 10px;">
                                <!-- LEFT SIDEBAR - Tree Navigation -->
                                <!-- Update the sidebar in the knowledge tab to this: -->
                                <!-- Update the sidebar buttons in the knowledge tab: -->
                                <aside style="width: 350px; background: #e8f0ff; border: 1px solid #a0c0ff; border-radius: 3px; display: flex; flex-direction: column; padding: 15px;">
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: #0a3b9c; margin-bottom: 10px;">NWT Terminology Navigator</h3>
                                    
                                    <!-- SEARCH BOX WITH BUTTON -->
                                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                        <input type="text" 
                                               id="treeSearch" 
                                               class="form-control" 
                                               placeholder="Search SNOMED/FHIR..."
                                               style="flex-grow: 1; padding: 8px;">
                                        <button onclick="searchTerminology()" 
                                                class="btn btn-primary"
                                                style="padding: 8px 15px; white-space: nowrap;">
                                            Search
                                        </button>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                        Search real terminology servers or use demo data
                                    </div>
                                    
                                    <!-- API SELECTOR -->
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">Data Source:</label>
                                        <select id="api-provider" class="form-control" style="font-size: 12px; padding: 5px;">
                                            <option value="DEMO">Demo Mode (Sample Data)</option>
                                            <option value="ONTOSERVER">Ontoserver (Live FHIR)</option>
                                            <option value="SNOWSTORM">Snowstorm (Live SNOMED)</option>
                                        </select>
                                        <button onclick="openApiSettings()" 
                                                style="margin-top: 5px; font-size: 11px; padding: 3px 8px;" 
                                                class="btn btn-secondary">
                                            API Settings
                                        </button>
                                    </div>
                                    
                                    <!-- QUICK SEARCH BUTTONS -->
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">Quick Searches:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                            <button onclick="quickSearch('diabetes')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Diabetes
                                            </button>
                                            <button onclick="quickSearch('hypertension')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Hypertension
                                            </button>
                                            <button onclick="quickSearch('cancer')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Cancer
                                            </button>
                                            <button onclick="quickSearch('vaccine')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Vaccine
                                            </button>
                                            <button onclick="quickSearch('pregnancy')" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                                Pregnancy
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ACTION BUTTONS -->
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                        <button onclick="loadDemoTerminology()" class="btn btn-secondary" style="font-size: 12px; flex: 1;">
                                            üìÅ Load Demo Tree
                                        </button>
                                        <button onclick="clearTree()" class="btn btn-secondary" style="font-size: 12px; flex: 1;">
                                            üóëÔ∏è Clear
                                        </button>
                                    </div>
                                    
                                    <!-- DEBUG BUTTON (optional) -->
                                    <button onclick="testSpecTool()" 
                                            style="font-size: 11px; padding: 3px 8px; background: #ff9900; color: white; border: none; border-radius: 3px; cursor: pointer; width: 100%;">
                                        üêõ Debug Test
                                    </button>
                                </div>
                                
                                <!-- TREE/RESULTS CONTAINER -->
                                <div id="treeContainer" style="flex-grow: 1; overflow-y: auto; border: 1px solid #d4d0c8; padding: 10px; background: white;">
                                    <div style="color: #666; text-align: center; padding: 20px;">
                                        <p>Enter a search term above to find medical terminology.</p>
                                        <p>Or click "Load Demo Tree" for example data.</p>
                                    </div>
                                </div>
                            </aside>
                
                                <!-- MAIN WORKSPACE - Specification Board -->
                                <main style="flex-grow: 1; display: flex; flex-direction: column; background: #f8f8f8; border: 1px solid #d4d0c8; border-radius: 3px; padding: 15px;">
                                    <!-- Update the header buttons in the main workspace: -->
                                    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #d4d0c8;">
                                        <h2 style="color: #0a3b9c;">Specification Board</h2>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="exportSpecToCSV()" class="btn btn-primary">
                                                üíæ Download ETL Spec (CSV)
                                            </button>
                                            <button onclick="clearAllCards()" class="btn btn-secondary">
                                                Clear Board
                                            </button>
                                        </div>
                                    </header>
                                    
                                    <!-- Cards display area -->
                                    <div id="spec-board" style="flex-grow: 1; overflow-y: auto; padding: 10px; background: white; border: 1px solid #d4d0c8; border-radius: 3px;">
                                        <div id="empty-board-message" style="color: #666; text-align: center; padding: 50px;">
                                            <h3>No Parameters Added</h3>
                                            <p>Click on any item in the terminology tree to add it to the board.</p>
                                            <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Stats bar -->
                                    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px; font-size: 12px; display: flex; justify-content: space-between;">
                                        <span id="card-count">0 parameters mapped</span>
                                        <span id="mapped-count">0 with source mapping</span>
                                    </div>
                                </main>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 2: LEGISLATIVE LIBRARY ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="legislative">
                            <span>üìö Legislative & Policy Reference Library</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-legislative">
                            <div style="padding: 20px; text-align: center;">
                                <h3>Coming Soon: Legislative Repository</h3>
                                <p>Searchable database of NWT health legislation, policies, and compliance requirements.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 3: PRECEDENT DATABASE ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="precedent">
                            <span>‚öñÔ∏è Data Request Precedent Database</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-precedent">
                            <div style="padding: 20px; text-align: center;">
                                <h3>Coming Soon: Precedent Database</h3>
                                <p>Historical data request decisions, approvals, and conditions.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DASHBOARD TAB -->
                <!-- DASHBOARD TAB -->
                <!-- DASHBOARD TAB -->
                <div id="dashboard-tab" class="tab-pane">
                    <!-- Dashboard Header -->
                    <div class="dashboard-header" style="background: linear-gradient(to right, #0a3b9c, #1e88e5); color: white; padding: 20px; margin: -20px -20px 20px -20px;">
                        <h1 style="margin: 0; display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 32px;">üìà</span>
                            NWT Data Request Intelligence Dashboard
                        </h1>
                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">
                            Analyzing <span id="total-requests-count">0</span> historical requests across NWT health regions
                        </p>
                    </div>
                    
                    <!-- Dashboard Controls -->
                    <div style="padding: 15px 20px; background: #f5f5f5; border: 1px solid #d4d0c8; border-radius: 3px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center;">
                        <div style="display: flex; gap: 15px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 5px;">Time Period:</label>
                                <select id="time-period" class="form-control" style="width: 150px;" onchange="loadDashboardData()">
                                    <option value="all">All time</option>
                                    <option value="12">Last 12 months</option>
                                    <option value="36">Last 3 years</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 5px;">Region:</label>
                                <select id="region-filter" class="form-control" style="width: 180px;" onchange="loadDashboardData()">
                                    <option value="all">All NWT Regions</option>
                                    <option value="Beaufort Delta Region">Beaufort Delta</option>
                                    <option value="Dehcho Region">Dehcho</option>
                                    <option value="Sahtu Region">Sahtu</option>
                                    <option value="South Slave Region">South Slave</option>
                                    <option value="Yellowknife Region">Yellowknife</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 5px;">Organization:</label>
                                <select id="org-filter" class="form-control" style="width: 120px;" onchange="loadDashboardData()">
                                    <option value="all">All</option>
                                    <option value="DHSS">DHSS</option>
                                    <option value="HSSA">HSSA</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="flex-grow: 1; display: flex; justify-content: flex-end; gap: 10px;">
                            <button onclick="exportDashboardData()" class="btn btn-primary">
                                üì• Export Data
                            </button>
                            <button onclick="loadDashboardData()" class="btn btn-secondary">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Key Metrics Row - ALL DYNAMIC -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="metric-card" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div id="metric-total-requests" class="metric-value" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0</div>
                            <div class="metric-label" style="font-size: 14px; color: #666;">Total Requests</div>
                            <div id="trend-total" class="metric-trend" style="font-size: 12px; color: #666; margin-top: 5px;">No data yet</div>
                        </div>
                        
                        <div class="metric-card" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div id="metric-approval-rate" class="metric-value" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0%</div>
                            <div class="metric-label" style="font-size: 14px; color: #666;">Approval Rate</div>
                            <div id="trend-approval" class="metric-trend" style="font-size: 12px; color: #666; margin-top: 5px;">No approvals yet</div>
                        </div>
                        
                        <div class="metric-card" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div id="metric-avg-days" class="metric-value" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">--</div>
                            <div class="metric-label" style="font-size: 14px; color: #666;">Avg. Days to Complete</div>
                            <div id="trend-days" class="metric-trend" style="font-size: 12px; color: #666; margin-top: 5px;">No completed requests</div>
                        </div>
                        
                        <div class="metric-card" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div id="metric-clusters" class="metric-value" style="font-size: 32px; font-weight: bold; color: #0a3b9c; margin-bottom: 5px;">0</div>
                            <div class="metric-label" style="font-size: 14px; color: #666;">Active Clusters</div>
                            <div id="trend-clusters" class="metric-trend" style="font-size: 12px; color: #666; margin-top: 5px;">Analyzing patterns...</div>
                        </div>
                    </div>
                    
                    <!-- Main Dashboard Content -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                        
                        <!-- Left Column: Request Distribution -->
                        <div style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #0a3b9c; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                üìä Request Distribution
                            </h3>
                            
                            <div id="request-distribution" style="min-height: 300px; display: flex; align-items: center; justify-content: center; color: #999;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px;">üìÅ</div>
                                    <div>No request data yet</div>
                                    <div style="font-size: 12px; margin-top: 10px;">Submit requests via the Form tab to see distribution</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Regional Breakdown -->
                        <div style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #0a3b9c; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                üó∫Ô∏è Regional Breakdown
                            </h3>
                            
                            <div id="regional-breakdown" style="margin-top: 15px;">
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <div style="font-size: 48px;">üó∫Ô∏è</div>
                                    <div>No regional data yet</div>
                                    <div style="font-size: 12px; margin-top: 10px;">Requests will be grouped by region automatically</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        
                        <!-- Recent Activity -->
                        <div style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #0a3b9c; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                üìÖ Recent Activity
                            </h3>
                            
                            <div id="recent-activity" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                                <div style="text-align: center;">
                                    <div style="font-size: 36px;">‚è≥</div>
                                    <div>No recent activity</div>
                                    <div style="font-size: 12px;">New requests will appear here</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Status -->
                        <div style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #0a3b9c; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                üìã Data Status
                            </h3>
                            
                            <div id="data-status" style="margin-top: 15px;">
                                <div class="status-item">
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f8f8; margin-bottom: 8px; border-radius: 3px;">
                                        <span>Database Connection:</span>
                                        <span id="db-status" style="color: #4CAF50; font-weight: bold;">‚úÖ Ready</span>
                                    </div>
                                </div>
                                <div class="status-item">
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f8f8; margin-bottom: 8px; border-radius: 3px;">
                                        <span>Total Requests Stored:</span>
                                        <span id="storage-count" style="color: #2196F3; font-weight: bold;">0</span>
                                    </div>
                                </div>
                                <div class="status-item">
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f8f8; margin-bottom: 8px; border-radius: 3px;">
                                        <span>Last Updated:</span>
                                        <span id="last-updated" style="color: #666; font-size: 12px;">Never</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 3px;">
                                <h5 style="margin-top: 0; color: #2e7d32;">üéØ Ready for Real Data</h5>
                                <ul style="font-size: 12px; margin: 10px 0 0 15px; padding: 0;">
                                    <li>Submit your first data request via the Form tab</li>
                                    <li>Dashboard updates automatically</li>
                                    <li>All analytics are real-time</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="margin-top: 20px; padding: 20px; background: #f8f8f8; border: 1px solid #d4d0c8; border-radius: 3px;">
                        <h4 style="margin-top: 0; color: #0a3b9c;">‚ö° Quick Actions</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="loadDashboardData()" class="btn btn-primary">
                                üîÑ Refresh Dashboard
                            </button>
                            <button onclick="clearDashboardCache()" class="btn btn-secondary">
                                üóëÔ∏è Clear Cache
                            </button>
                            <button onclick="showDataHealth()" class="btn btn-secondary">
                                üè• Data Health Check
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NEW: EMR DATA EXPLORER TAB -->
                <!-- NEW: EMR DATA EXPLORER TAB -->
                <div id="emr-tab" class="tab-pane">
                    <!-- Database Status Bar -->
                    <div id="database-status" style="padding: 10px; margin-bottom: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                        Loading database...
                    </div>
                    
                    <!-- DEBUG PANEL (optional) -->
                    <div style="margin: 10px 0; padding: 10px; border: 2px solid orange; background: #fff8e1; display: none;" id="debug-panel">
                        <h4>üîß DEBUG PANEL</h4>
                        <button onclick="testDisplayArea()" style="padding: 5px 10px; margin: 2px;">Test Display</button>
                        <button onclick="testFirstTable()" style="padding: 5px 10px; margin: 2px;">Test First Table</button>
                        <button onclick="reloadDatabase()" style="padding: 5px 10px; margin: 2px;">Reload DB</button>
                    </div>
                    
                    <!-- ================= ACCORDION 1: SCHEMA & TABLES ================= -->
                    <div class="accordion">
                        <div class="accordion-header active" data-accordion="schema">
                            <span>üìä Schema Visualization & Table Explorer</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content active" id="accordion-schema">
                            <div class="compact-grid">
                                <!-- Left: Schema Diagram -->
                                <div class="compact-section">
                                    <div class="emr-section-header">
                                        <h3>Database Schema</h3>
                                    </div>
                                    <div class="scrollable-section">
                                        <div class="schema-diagram" id="schema-diagram">
                                            <!-- Schema will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Table List -->
                                <div class="compact-section">
                                    <div class="emr-section-header">
                                        <h3>Table Explorer</h3>
                                    </div>
                                    <div class="scrollable-section">
                                        <div class="table-list" id="table-list">
                                            Click table names to preview data...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 2: CLIENT REQUEST TRANSLATOR ================= -->
                    <div class="accordion">
                        <div class="accordion-header active" data-accordion="translator">
                            <span>üîç Client Request Translator</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content active" id="accordion-translator">
                            <div class="form-group">
                                <label for="client-request">Enter Client Request:</label>
                                <textarea id="client-request" class="form-control textarea-large" 
                                          placeholder="Example: 'I need all diabetic patients aged 50+ from Yellowknife with HbA1c > 7% in 2024'"
                                          rows="3"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button id="analyze-request" class="btn btn-primary">Analyze Request</button>
                                <button onclick="clearAnalysis()" class="btn btn-secondary">Clear</button>
                            </div>
                            
                            <div id="analysis-results" style="display: none; background: #f8f8f8; padding: 15px; border: 1px solid #d4d0c8;">
                                <h4>Analysis Results:</h4>
                                <div class="form-group">
                                    <label>Tables Required:</label>
                                    <div id="tables-required" class="highlight"></div>
                                </div>
                                <div class="form-group">
                                    <label>SQL Conditions:</label>
                                    <div id="sql-conditions" class="highlight"></div>
                                </div>
                                <div class="form-group">
                                    <label>Sample SQL Query:</label>
                                    <div id="sample-sql" class="sql-preview"></div>
                                </div>
                            </div>
                            
                            <!-- Quick Scenarios -->
                            <div style="margin-top: 15px;">
                                <h4>Quick Scenarios:</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    <button onclick="loadScenario('diabetes')" class="btn btn-secondary" style="font-size: 12px;">
                                        ü©∫ Diabetes Patients
                                    </button>
                                    <button onclick="loadScenario('appointments')" class="btn btn-secondary" style="font-size: 12px;">
                                        üìÖ Appointments
                                    </button>
                                    <button onclick="loadScenario('medications')" class="btn btn-secondary" style="font-size: 12px;">
                                        üíä Medications
                                    </button>
                                    <button onclick="loadScenario('admissions')" class="btn btn-secondary" style="font-size: 12px;">
                                        üè• Admissions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 3: SQL PRACTICE ================= -->
                    <div class="accordion">
                        <div class="accordion-header active" data-accordion="sql">
                            <span>üíª SQL Practice & Query Builder</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content active" id="accordion-sql">
                            <div class="compact-grid">
                                <!-- Left: Query Input -->
                                <div class="compact-section">
                                    <div class="form-group">
                                        <label>SQL Query:</label>
                                        <textarea id="sql-query" class="form-control textarea-large" 
                                                  placeholder="Write your SQL query here...
                Example: SELECT first_name, last_name FROM patients WHERE city = 'Yellowknife' LIMIT 10"
                                                  rows="6"></textarea>
                                    </div>
                                    
                                    <div class="form-buttons">
                                        <button id="run-query" class="btn btn-primary">Run Query</button>
                                        <button id="clear-query" class="btn btn-secondary">Clear</button>
                                        <button id="save-query" class="btn btn-secondary">Save</button>
                                        <button id="export-results" class="btn btn-secondary">Export CSV</button>
                                    </div>
                                    
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>Saved Queries:</label>
                                        <select id="saved-queries" class="form-control">
                                            <option value="">Select a saved query...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Right: Table Selector -->
                                <div class="compact-section">
                                    <div class="form-group">
                                        <label>Available Tables:</label>
                                        <div class="scrollable-section" style="height: 200px;">
                                            <div id="table-selector" class="checkbox-group">
                                                <!-- Tables will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Quick Templates:</label>
                                        <div style="display: flex; flex-direction: column; gap: 5px;">
                                            <button onclick="loadTemplate('select_all')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
                                                SELECT * FROM [table]
                                            </button>
                                            <button onclick="loadTemplate('count')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
                                                SELECT COUNT(*) FROM [table]
                                            </button>
                                            <button onclick="loadTemplate('join')" class="btn btn-secondary" style="font-size: 12px; text-align: left;">
                                                Simple JOIN template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================= ACCORDION 4: QUERY RESULTS ================= -->
                    <div class="accordion">
                        <div class="accordion-header" data-accordion="results">
                            <span>üìã Query Results</span>
                            <span class="accordion-icon">+</span>
                        </div>
                        <div class="accordion-content" id="accordion-results">
                            <div id="query-results" class="fixed-height-results">
                                Results will appear here when you run a query or click a table...
                            </div>
                            
                            <!-- Results Info -->
                            <div id="results-info" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; display: none;">
                                <strong>Query Info:</strong> <span id="row-count">0</span> rows returned
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>NWT Government Data Request Tool ‚Ä¢ Windows XP/2000 Theme</p>
        </footer>
    </div>

    <script>

        // ================= TOOLTIP SYSTEM =================
        function setupTooltips() {
            console.log('Setting up tooltips...');
            
            // 1. TOOLTIP FOR DATA REQUEST CLASSIFICATION
            const classLabel = document.querySelector('label[for="classification"]');
            if (classLabel) {
                classLabel.innerHTML += `
                    <span class="help-bubble" onclick="showClassificationHelp()" 
                          style="cursor: help; 
                                 background: #0a3b9c; 
                                 color: white; 
                                 width: 18px; 
                                 height: 18px; 
                                 border-radius: 50%; 
                                 display: inline-flex; 
                                 align-items: center; 
                                 justify-content: center; 
                                 margin-left: 8px; 
                                 font-weight: bold;
                                 font-size: 12px;
                                 vertical-align: middle;">?</span>
                `;
            }
            
        }
        
        // ================= COMPLETE TOOLTIP FUNCTIONS =================

        function showDataTypeHelp() {
            const message = `
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë                DATA TYPE SPECIFICATION                       ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë                                                              ‚ïë
        ‚ïë  Under the Health Information Act (HIA), you must restrict   ‚ïë
        ‚ïë  your request to the absolute minimum data required to meet  ‚ïë
        ‚ïë  your objective.                                             ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üî¥ NO "Just in Case" Data:                                  ‚ïë
        ‚ïë     ‚Ä¢ Do not include elements for hypothetical use           ‚ïë
        ‚ïë     ‚Ä¢ or "future verification"                               ‚ïë
        ‚ïë     ‚Ä¢ Example: patient address is rarely necessary           ‚ïë
        ‚ïë       if you only need to know the facility community        ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üî¥ Parameters vs. Elements:                                 ‚ïë
        ‚ïë     ‚Ä¢ If a field is only used to filter the list             ‚ïë
        ‚ïë       (a parameter), do not include it as a column           ‚ïë
        ‚ïë       in the final extract (an element) unless it            ‚ïë
        ‚ïë       is strictly required for your work.                    ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üî¥ Finalized List:                                          ‚ïë
        ‚ïë     ‚Ä¢ Remove all "options" or "maybes."                      ‚ïë
        ‚ïë     ‚Ä¢ The list must be definitive and confirmed              ‚ïë
        ‚ïë       with the IM Analyst before submission.                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `;
            
            showTooltipWindow('Data Type Specification', message);
        }
        
        function showFrequencyHelp() {
            const message = `
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë              DATA REQUEST FREQUENCY                          ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë                                                              ‚ïë
        ‚ïë  Scheduling Tip: Specific vs. Relative Dates                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  For recurring requests, your timeframe must distinguish     ‚ïë
        ‚ïë  between the first delivery and future runs:                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üü¢ Initial Extract:                                         ‚ïë
        ‚ïë     ‚Ä¢ List specific dates                                    ‚ïë
        ‚ïë     ‚Ä¢ Example: Jan 1 ‚Äì Mar 31, 2025                          ‚ïë
        ‚ïë     ‚Ä¢ To define the starting data set                        ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üü¢ Recurring Logic:                                         ‚ïë
        ‚ïë     ‚Ä¢ Use relative terms                                     ‚ïë
        ‚ïë     ‚Ä¢ Example: "Prior Quarter" or "Last 3 months"            ‚ïë
        ‚ïë     ‚Ä¢ To ensure the data stays current                       ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üî¥ AVOID:                                                   ‚ïë
        ‚ïë     ‚Ä¢ Putting specific years or dates in the recurring       ‚ïë
        ‚ïë       description                                            ‚ïë
        ‚ïë     ‚Ä¢ This may result in receiving the same historical       ‚ïë
        ‚ïë       data every period                                      ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `;
            
            showTooltipWindow('Data Request Frequency', message);
        }
        
        function showTooltipWindow(title, content) {
            // Remove any existing tooltip window
            const existing = document.getElementById('custom-tooltip-window');
            if (existing) existing.remove();
            
            // Create new tooltip window
            const tooltipWindow = document.createElement('div');
            tooltipWindow.id = 'custom-tooltip-window';
            tooltipWindow.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(to bottom, #0a3b9c, #245edc);
                color: white;
                padding: 25px;
                border: 3px solid white;
                border-radius: 5px;
                box-shadow: 0 0 30px rgba(0,0,0,0.7);
                z-index: 10000;
                width: 650px;
                max-height: 80vh;
                overflow-y: auto;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.5;
                white-space: pre;
            `;
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚úï CLOSE';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: #cc0000;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 3px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
            `;
            closeBtn.onclick = () => tooltipWindow.remove();
            
            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.textContent = title;
            titleDiv.style.cssText = `
                font-weight: bold;
                font-size: 18px;
                margin-bottom: 20px;
                color: #ffff88;
                text-align: center;
                border-bottom: 2px solid #ffff88;
                padding-bottom: 10px;
                text-shadow: 1px 1px 2px black;
            `;
            
            // Add content
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            contentDiv.style.cssText = `
                margin-top: 15px;
                font-size: 13px;
                line-height: 1.6;
            `;
            
            // Assemble
            tooltipWindow.appendChild(closeBtn);
            tooltipWindow.appendChild(titleDiv);
            tooltipWindow.appendChild(contentDiv);
            
            // Add to page
            document.body.appendChild(tooltipWindow);
            
            // Close on escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') tooltipWindow.remove();
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Remove listener when window closes
            tooltipWindow.addEventListener('remove', () => {
                document.removeEventListener('keydown', closeOnEscape);
            });
        }
        
        // ================= ALSO ADD FOR EXISTING FIELDS =================
        
        function showClassificationHelp() {
            const message = `
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë          DATA REQUEST CLASSIFICATION                         ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë                                                              ‚ïë
        ‚ïë  This section is for recording the final data that will be   ‚ïë
        ‚ïë  shared. The format is:                                      ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  1. [ehealth information system]                             ‚ïë
        ‚ïë     ‚Ä¢ e.g., EMR, MediPatient, HMIS                           ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  2. [parameters of request]                                  ‚ïë
        ‚ïë     ‚Ä¢ Type of data                                           ‚ïë
        ‚ïë     ‚Ä¢ Inclusion/exclusion criteria if applicable             ‚ïë
        ‚ïë     ‚Ä¢ Timeframe of data                                      ‚ïë
        ‚ïë     ‚Ä¢ Communities included/excluded                          ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  3. [list of data elements or stats]                         ‚ïë
        ‚ïë     ‚Ä¢ To be provided                                         ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `;
            
            showTooltipWindow('Data Request Classification', message);
        }
        
        function showPurposeHelp() {
            const message = `
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë                   DEFINE PURPOSE                             ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë                                                              ‚ïë
        ‚ïë  Tailor the purpose to what the requestor states.            ‚ïë
        ‚ïë  Reference the Request Form if Necessary.                    ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  Clearly identify the logic that flows from:                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  1. PURPOSE                                                  ‚ïë
        ‚ïë     ‚Ä¢ Requestor's need                                       ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  2. LEGISLATIVE AUTHORITY                                    ‚ïë
        ‚ïë     ‚Ä¢ Through appropriate legislative authorization          ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  3. DATA IDENTIFICATION                                      ‚ïë
        ‚ïë     ‚Ä¢ The data that's identified for the purpose of sharing  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `;
            
            showTooltipWindow('Define Purpose', message);
        }
        
        // ================= INITIALIZE ALL TOOLTIPS =================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('All tooltip functions are ready!');
            // The ? buttons in your HTML will call these functions when clicked
        });
        
        // 5. SHOW TOOLTIP WINDOW (Beautiful popup)
        function showTooltipWindow(title, content) {
            // Remove any existing tooltip window
            const existing = document.getElementById('custom-tooltip-window');
            if (existing) existing.remove();
            
            // Create new tooltip window
            const tooltipWindow = document.createElement('div');
            tooltipWindow.id = 'custom-tooltip-window';
            tooltipWindow.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(to bottom, #0a3b9c, #245edc);
                color: white;
                padding: 20px;
                border: 3px solid white;
                border-radius: 5px;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                z-index: 10000;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.4;
                white-space: pre;
            `;
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚úï Close';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: #cc0000;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-weight: bold;
            `;
            closeBtn.onclick = () => tooltipWindow.remove();
            
            // Add title
            const titleDiv = document.createElement('div');
            titleDiv.textContent = title;
            titleDiv.style.cssText = `
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 15px;
                color: #ffff88;
                text-align: center;
                border-bottom: 2px solid #ffff88;
                padding-bottom: 5px;
            `;
            
            // Add content
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            contentDiv.style.cssText = `
                margin-top: 10px;
                font-size: 13px;
            `;
            
            // Assemble
            tooltipWindow.appendChild(closeBtn);
            tooltipWindow.appendChild(titleDiv);
            tooltipWindow.appendChild(contentDiv);
            
            // Add to page
            document.body.appendChild(tooltipWindow);
            
            // Close on escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') tooltipWindow.remove();
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Remove listener when window closes
            tooltipWindow.addEventListener('remove', () => {
                document.removeEventListener('keydown', closeOnEscape);
            });
        }
        
        // 6. Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupTooltips();
            console.log('Tooltip system ready. Click the ? buttons!');
        });

        // Add to your existing JavaScript tooltip setup
        function addNewFieldTooltips() {
            // Tooltip for Data Type Specifications
            const dataTypeField = document.getElementById('data-type-specs');
            if (dataTypeField) {
                const label = dataTypeField.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    label.innerHTML += `
                        <span class="help-bubble" onclick="showDataTypeHelp()" 
                              style="cursor: help; background: #0a3b9c; color: white; ...">?</span>
                    `;
                }
            }
            
            // Tooltip for Request Frequency Feasibility
            const freqField = document.getElementById('frequency-feasibility');
            if (freqField) {
                const label = freqField.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    label.innerHTML += `
                        <span class="help-bubble" onclick="showFrequencyHelp()" 
                              style="cursor: help; background: #0a3b9c; color: white; ...">?</span>
                    `;
                }
            }
        }

        // Auto-open intelligence accordion when user starts typing purpose
        document.getElementById('defined-purpose').addEventListener('input', function(e) {
            if (e.target.value.length > 15) {
                // Open the intelligence accordion
                const intelAccordion = document.querySelector('[data-accordion="request-intelligence"]');
                if (intelAccordion) {
                    intelAccordion.click(); // Simulate click to open
                    analyzeRequest(e.target.value);
                }
            }
        });
        
        // Configuration
        let db = null;
        let databaseLoaded = false;
        let currentQueryResults = null;
        
        // NWT Location Data
        const locationData = {
            "Beaufort Delta Region": ["Aklavik", "Fort McPherson", "Inuvik", "Paulatuk", "Sachs Harbour", "Tsiigehtchic", "Tuktoyaktuk", "Ulukhaktok"],
            "Dehcho Region": ["Fort Liard", "Fort Providence", "Fort Simpson", "Hay River Dene Reserve", "Jean Marie River", "Kakisa", "Nahanni Butte", "Sambaa K'e", "Wrigley"],
            "Sahtu Region": ["Colville Lake", "D√©lƒ±Ã®nƒô", "Fort Good Hope", "Norman Wells", "Tulita"],
            "South Slave Region": ["Enterprise", "Fort Resolution", "Fort Smith", "Hay River", "≈Åutselk'e"],
            "T≈ÇƒØch«´ Region": ["Behchok«´ÃÄ", "Gam√®tƒ±ÃÄ", "Wekwe√®tƒ±ÃÄ", "Whatƒ±ÃÄ"],
            "Yellowknife Region": ["Dettah", "Yellowknife"]
        };

        // Data storage for form tab
        let requestsData = JSON.parse(localStorage.getItem('dataRequests')) || [];
        let nextId = requestsData.length > 0 ? Math.max(...requestsData.map(r => r.id)) + 1 : 1;
        let savedQueries = JSON.parse(localStorage.getItem('emrSavedQueries')) || [];
        let customScenarios = JSON.parse(localStorage.getItem('customScenarios')) || [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    // Initialize EMR explorer when tab is activated
                    if (this.dataset.tab === 'emr-tab' && !databaseLoaded) {
                        loadDatabase();
                    }
                });
            });

            // Region selection
            document.getElementById('region').addEventListener('change', function() {
                const region = this.value;
                const districtSelect = document.getElementById('district');
                districtSelect.innerHTML = '<option value="">Select District</option>';
                
                if (region && locationData[region]) {
                    districtSelect.disabled = false;
                    locationData[region].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                } else {
                    districtSelect.disabled = true;
                }
            });

            // Organization checkboxes
            document.querySelectorAll('.org-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('.org-checkbox').forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                    updateOrganization();
                });
            });

            // Other org text input
            document.getElementById('other-org-text').addEventListener('input', updateOrganization);

            // Clear validation on input
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('input', function() {
                    this.classList.remove('validation-error');
                    const errorId = this.id + '-error';
                    if (document.getElementById(errorId)) {
                        document.getElementById(errorId).style.display = 'none';
                    }
                });
            });

            // Form tab buttons
            document.getElementById('save-btn').addEventListener('click', saveRequest);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('refresh-btn').addEventListener('click', loadTableData);
            

            // EMR tab buttons (will be set up after database loads)
            
            // Load initial table data for form tab
            loadTableData();
            
            // Pre-load database when page loads
            setTimeout(() => loadDatabase(), 1000);
        });

        // Dashboard Data Loader - Connects to YOUR real data
        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data from your database...');
                
                // 1. Get filter values
                const timeFilter = document.getElementById('time-period').value;
                const regionFilter = document.getElementById('region-filter').value;
                const orgFilter = document.getElementById('org-filter').value;
                
                // 2. Load data from YOUR database
                // (This assumes you have a function that queries your SQLite database)
                const dashboardData = await getDashboardDataFromDB(timeFilter, regionFilter, orgFilter);
                
                // 3. Update the dashboard with REAL data
                updateDashboardWithRealData(dashboardData);
                
                // 4. Update status
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Could not load dashboard data. Check database connection.');
            }
        }
        
        // Example function you need to implement based on your database structure
        async function getDashboardDataFromDB(timeFilter, regionFilter, orgFilter) {
            // THIS IS WHERE YOU CONNECT TO YOUR ACTUAL DATABASE
            // Example structure - you'll adapt this to your actual tables
            
            const db = window.database; // Your SQLite database connection
            
            // Count total requests
            const totalResult = await db.query("SELECT COUNT(*) as count FROM data_requests");
            const totalRequests = totalResult[0].count;
            
            // Count approved requests (you'll need to add a status field to your table)
            const approvedResult = await db.query("SELECT COUNT(*) as count FROM data_requests WHERE status = 'approved'");
            const approvedRequests = approvedResult[0].count;
            
            // Calculate approval rate
            const approvalRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
            
            // Group by region
            const regionResult = await db.query("SELECT region, COUNT(*) as count FROM data_requests GROUP BY region");
            
            // Get recent requests
            const recentResult = await db.query("SELECT request_number, purpose, created_at FROM data_requests ORDER BY created_at DESC LIMIT 5");
            
            return {
                totalRequests,
                approvalRate,
                regions: regionResult,
                recent: recentResult
            };
        }
        
        // Update dashboard with real data
        function updateDashboardWithRealData(data) {
            // Update metrics
            document.getElementById('metric-total-requests').textContent = data.totalRequests;
            document.getElementById('total-requests-count').textContent = data.totalRequests;
            document.getElementById('metric-approval-rate').textContent = data.approvalRate + '%';
            document.getElementById('storage-count').textContent = data.totalRequests;
            
            // Update regional breakdown
            updateRegionalData(data.regions);
            
            // Update recent activity
            updateRecentActivity(data.recent);
            
            // Update trends if you have historical data
            updateTrends(data);
        }
        
        // Initialize dashboard when tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            // Load dashboard when Dashboard tab is clicked
            const dashboardTab = document.querySelector('[data-tab="dashboard-tab"]');
            if (dashboardTab) {
                dashboardTab.addEventListener('click', function() {
                    setTimeout(loadDashboardData, 100); // Small delay to ensure tab is visible
                });
            }
            
            // Initial load
            loadDashboardData();
        });

        // Load SQLite database
        async function loadDatabase() {
            const statusDiv = document.getElementById('database-status') || createStatusDiv();
            
            try {
                statusDiv.innerHTML = 'Loading SQLite engine...';
                
                // Initialize SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                statusDiv.innerHTML = 'Downloading database...';
                
                // Load your database file
                // IMPORTANT: You need to convert your .db file to ArrayBuffer
                // Option 1: Fetch from GitHub (if under 50MB)
                const response = await fetch('OpenEMR_Sim.db');
                if (!response.ok) {
                    throw new Error(`Database not found: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                statusDiv.innerHTML = 'Initializing database...';
                
                // Create database
                db = new SQL.Database(new Uint8Array(arrayBuffer));
                databaseLoaded = true;
                
                // Update UI
                statusDiv.innerHTML = `
                    <span style="color: green;">‚úì Database loaded successfully!</span>
                    <button onclick="showDatabaseInfo()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px;">
                        Show Info
                    </button>
                `;
                
                // Initialize EMR explorer
                initEMRExplorer();
                
                console.log('Database loaded successfully');
                
            } catch (error) {
                console.error('Database load error:', error);
                statusDiv.innerHTML = `
                    <span style="color: red;">‚úó Error loading database: ${error.message}</span><br>
                    <small>Using demo mode with sample data</small>
                `;
                
                // Create demo database
                createDemoDatabase();
            }
        }

        // ================= ACCORDION FUNCTIONALITY =================

        // Initialize accordions
        function initAccordions() {
            console.log("Initializing accordions...");
            
            // Set up click handlers for all accordion headers
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', function() {
                    const accordionId = this.dataset.accordion;
                    const content = document.getElementById(`accordion-${accordionId}`);
                    const icon = this.querySelector('.accordion-icon');
                    
                    // Toggle active state
                    const isActive = this.classList.contains('active');
                    
                    // Close all accordions if desired, or just toggle this one
                    // For now, just toggle this one
                    this.classList.toggle('active');
                    content.classList.toggle('active');
                    
                    // Update icon
                    if (this.classList.contains('active')) {
                        icon.textContent = '‚àí'; // Minus sign
                    } else {
                        icon.textContent = '+'; // Plus sign
                    }
                    
                    // Auto-open results when query runs
                    if (accordionId === 'results' && !isActive) {
                        // Ensure it's visible
                        setTimeout(() => {
                            content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                });
            });
            
            // Auto-open results accordion when results are displayed
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const resultsDiv = document.getElementById('query-results');
                        if (resultsDiv && resultsDiv.textContent && 
                            resultsDiv.textContent.trim() !== 'Results will appear here...' &&
                            resultsDiv.textContent.trim() !== '') {
                            
                            // Open results accordion
                            const resultsHeader = document.querySelector('[data-accordion="results"]');
                            const resultsContent = document.getElementById('accordion-results');
                            
                            if (resultsHeader && !resultsHeader.classList.contains('active')) {
                                resultsHeader.classList.add('active');
                                resultsContent.classList.add('active');
                                resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                                
                                // Scroll to results
                                setTimeout(() => {
                                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 300);
                            }
                        }
                    }
                });
            });
            
            // Observe the results div for changes
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                observer.observe(resultsDiv, { 
                    childList: true, 
                    characterData: true, 
                    subtree: true 
                });
            }
            
            console.log("Accordions initialized");
        }
        
        // Update previewTableData to auto-open results
        function previewTableData(tableName) {
            console.log('DEBUG: previewTableData called with:', tableName);
            
            // ... [keep all your existing previewTableData code] ...
            
            // At the END of the function, after displaying results, add:
            
            // Auto-open results accordion
            setTimeout(() => {
                const resultsHeader = document.querySelector('[data-accordion="results"]');
                const resultsContent = document.getElementById('accordion-results');
                
                if (resultsHeader && !resultsHeader.classList.contains('active')) {
                    resultsHeader.classList.add('active');
                    resultsContent.classList.add('active');
                    resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                    
                    // Smooth scroll to results
                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }
        
        // Update runSQLQuery to auto-open results
        function runSQLQuery() {
            // ... [keep all your existing runSQLQuery code] ...
            
            // At the END, after displaying results, add same auto-open logic
            
            setTimeout(() => {
                const resultsHeader = document.querySelector('[data-accordion="results"]');
                const resultsContent = document.getElementById('accordion-results');
                
                if (resultsHeader && !resultsHeader.classList.contains('active')) {
                    resultsHeader.classList.add('active');
                    resultsContent.classList.add('active');
                    resultsHeader.querySelector('.accordion-icon').textContent = '‚àí';
                    
                    resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }
        
        // Helper functions
        function clearAnalysis() {
            document.getElementById('client-request').value = '';
            document.getElementById('analysis-results').style.display = 'none';
        }
        
        function loadTemplate(templateType) {
            const templates = {
                'select_all': 'SELECT * FROM patients LIMIT 10',
                'count': 'SELECT COUNT(*) as count FROM patients',
                'join': `SELECT p.first_name, p.last_name, e.encounter_date
        FROM patients p
        JOIN encounters e ON p.patient_id = e.patient_id
        LIMIT 10`
            };
            
            const sqlQueryBox = document.getElementById('sql-query');
            if (sqlQueryBox && templates[templateType]) {
                sqlQueryBox.value = templates[templateType];
            }
        }
        
        // Initialize accordions when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // ... your existing DOM loaded code ...
            
            // Initialize accordions
            setTimeout(() => initAccordions(), 500);
        });

        // Add this function to your JavaScript
        function debugDatabase() {
            console.log("=== DATABASE DEBUG ===");
            
            // Check basic setup
            console.log("1. Database object exists:", !!db);
            console.log("2. Database loaded flag:", databaseLoaded);
            console.log("3. Window.SQL available:", !!window.SQL);
            
            if (!db) {
                alert("‚ùå Database object is null/undefined");
                return;
            }
            
            try {
                // Test 1: List all tables
                console.log("4. Testing: Listing tables...");
                const tablesResult = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
                console.log("   Tables found:", tablesResult[0]?.values?.length || 0);
                
                if (tablesResult.length > 0 && tablesResult[0].values.length > 0) {
                    console.log("   Table names:", tablesResult[0].values.map(t => t[0]));
                    
                    // Test 2: Try to query first table
                    const firstTable = tablesResult[0].values[0][0];
                    console.log("5. Testing: Querying first table (" + firstTable + ")...");
                    
                    const dataResult = db.exec(`SELECT * FROM ${firstTable} LIMIT 3`);
                    console.log("   Query successful:", dataResult.length > 0);
                    
                    if (dataResult.length > 0) {
                        console.log("   Columns:", dataResult[0].columns);
                        console.log("   Sample data (first row):", dataResult[0].values[0]);
                        
                        // Show in alert
                        let alertMsg = `‚úÖ DATABASE WORKS!\n\n`;
                        alertMsg += `Tables: ${tablesResult[0].values.length}\n`;
                        alertMsg += `First table: ${firstTable}\n`;
                        alertMsg += `Columns: ${dataResult[0].columns.length}\n\n`;
                        alertMsg += `Click "patients" in table list to test preview.`;
                        
                        alert(alertMsg);
                        
                        // Try to trigger preview
                        setTimeout(() => {
                            console.log("6. Attempting to trigger preview...");
                            previewTableData(firstTable);
                        }, 100);
                        
                    } else {
                        alert("‚ùå Query returned no data");
                    }
                } else {
                    alert("‚ùå No tables found in database");
                }
                
            } catch (error) {
                console.error("Database error:", error);
                alert("‚ùå DATABASE ERROR:\n" + error.message + "\n\nCheck console for details.");
            }
            
            console.log("=== DEBUG COMPLETE ===");
        }

        // Create demo database if real one fails
        function createDemoDatabase() {
            try {
                const SQL = window.SQL;
                db = new SQL.Database();
                
                // Create sample tables
                db.run(`
                    CREATE TABLE patients (
                        patient_id INTEGER PRIMARY KEY,
                        first_name TEXT,
                        last_name TEXT,
                        dob DATE,
                        city TEXT,
                        province TEXT
                    );
                    
                    CREATE TABLE encounters (
                        encounter_id INTEGER PRIMARY KEY,
                        patient_id INTEGER,
                        encounter_date DATE,
                        diagnosis_code TEXT
                    );
                    
                    CREATE TABLE appointments (
                        appt_id INTEGER PRIMARY KEY,
                        patient_id INTEGER,
                        appt_date DATE,
                        type TEXT
                    );
                    
                    INSERT INTO patients VALUES 
                    (1, 'John', 'Doe', '1980-01-15', 'Yellowknife', 'NT'),
                    (2, 'Jane', 'Smith', '1975-05-20', 'Inuvik', 'NT'),
                    (3, 'Bob', 'Johnson', '1990-08-30', 'Hay River', 'NT');
                    
                    INSERT INTO encounters VALUES
                    (1, 1, '2024-01-15', 'E11.9'),
                    (2, 2, '2024-02-20', 'I10'),
                    (3, 3, '2024-03-10', 'E11.9');
                    
                    INSERT INTO appointments VALUES
                    (1, 1, '2024-01-10', 'Consultation'),
                    (2, 2, '2024-02-15', 'Follow-up'),
                    (3, 3, '2024-03-05', 'Check-up');
                `);
                
                databaseLoaded = true;
                initEMRExplorer();
                
            } catch (error) {
                console.error('Demo database error:', error);
            }
        }

        // Show database information
        function showDatabaseInfo() {
            if (!db) {
                alert('Database not loaded yet.');
                return;
            }
            
            try {
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                let info = 'Database Tables:\n\n';
                
                tables[0]?.values.forEach(table => {
                    const tableName = table[0];
                    const columns = db.exec(`PRAGMA table_info(${tableName})`);
                    info += `${tableName}:\n`;
                    columns[0]?.values.forEach(col => {
                        info += `  - ${col[1]} (${col[2]})\n`;
                    });
                    info += '\n';
                });
                
                alert(info);
            } catch (error) {
                alert('Error getting database info: ' + error.message);
            }
        }

        // Initialize EMR Explorer
        function initEMRExplorer() {
            if (!databaseLoaded) {
                console.log('Database not loaded yet, skipping EMR init');
                return;
            }
            
            try {
                // Load database schema
                loadDatabaseSchema();
                
                // Load table list
                loadTableList();
                
                // Setup event listeners for EMR tab
                const analyzeBtn = document.getElementById('analyze-request');
                const runQueryBtn = document.getElementById('run-query');
                const clearQueryBtn = document.getElementById('clear-query');
                const saveQueryBtn = document.getElementById('save-query');
                const exportBtn = document.getElementById('export-results');
                const savedQueriesSelect = document.getElementById('saved-queries');
                
                if (analyzeBtn) analyzeBtn.addEventListener('click', analyzeClientRequest);
                if (runQueryBtn) runQueryBtn.addEventListener('click', runSQLQuery);
                if (clearQueryBtn) clearQueryBtn.addEventListener('click', clearQuery);
                if (saveQueryBtn) saveQueryBtn.addEventListener('click', saveQuery);
                if (exportBtn) exportBtn.addEventListener('click', exportResults);
                if (savedQueriesSelect) savedQueriesSelect.addEventListener('change', loadSavedQuery);
                
                // Setup scenario click handlers
                document.querySelectorAll('.scenario-box').forEach(box => {
                    box.addEventListener('click', function() {
                        loadScenario(this.dataset.scenario);
                    });
                });
                
                // Load custom scenarios
                updateCustomScenariosDropdown();
                
                console.log('EMR Explorer initialized');
                
            } catch (error) {
                console.error('Error initializing EMR Explorer:', error);
            }
        }

        // Load database schema
        function loadDatabaseSchema() {
            try {
                if (!db) return;
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                window.emrSchema = {};
                
                tables[0]?.values.forEach(table => {
                    const tableName = table[0];
                    const columns = db.exec(`PRAGMA table_info(${tableName})`);
                    
                    window.emrSchema[tableName] = {
                        columns: columns[0]?.values.map(col => ({
                            name: col[1],
                            type: col[2],
                            notnull: col[3],
                            pk: col[5]
                        })) || []
                    };
                });
                
                renderSchemaDiagram();
                renderTableSelector();
                
            } catch (error) {
                console.error('Error loading schema:', error);
            }
        }

        // Load table list
        // ============ WORKING VERSION ============

        // 1. FIXED loadTableList function
        function loadTableList() {
            console.log("loadTableList called");
            
            try {
                if (!db) {
                    console.log("Database not ready");
                    return;
                }
                
                // Get tables
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
                console.log("Tables query result:", result);
                
                if (!result.length) {
                    console.log("No tables found");
                    return;
                }
                
                const tableList = document.getElementById('table-list');
                if (!tableList) {
                    console.error("table-list element not found");
                    return;
                }
                
                // Clear existing
                tableList.innerHTML = '';
                
                // Add each table
                const tables = result[0].values;
                console.log("Found tables:", tables);
                
                for (let i = 0; i < tables.length; i++) {
                    const tableName = tables[i][0];
                    
                    const tableItem = document.createElement('div');
                    tableItem.className = 'table-item';
                    tableItem.dataset.tableName = tableName; // Store table name
                    tableItem.innerHTML = `<strong>${tableName}</strong><br><small>Click to preview</small>`;
                    
                    // Add click handler
                    tableItem.addEventListener('click', function(event) {
                        event.stopPropagation();
                        console.log("Table item clicked:", this.dataset.tableName);
                        
                        // Remove previous selection
                        document.querySelectorAll('.table-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // Select this one
                        this.classList.add('selected');
                        
                        // Preview the table
                        const clickedTableName = this.dataset.tableName;
                        console.log("Calling previewTableData with:", clickedTableName);
                        previewTableData(clickedTableName);
                    });
                    
                    tableList.appendChild(tableItem);
                }
                
                console.log("Table list populated with", tables.length, "tables");
                
            } catch (error) {
                console.error("Error in loadTableList:", error);
            }
        }
        
        // 2. SIMPLE previewTableData function WITH EXPORT STORAGE
        function previewTableData(tableName) {
            console.log("previewTableData called for:", tableName);
            
            // Get results div
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) {
                console.error("query-results div not found!");
                alert("Error: Cannot find results area. Check HTML for id='query-results'");
                return;
            }
            
            // Show loading
            resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: blue;">Loading ${tableName}...</div>`;
            
            try {
                if (!db) {
                    resultsDiv.innerHTML = `<div style="color: red;">Database not loaded</div>`;
                    return;
                }
                
                // ========== FIXED: GET FULL TABLE DATA FIRST ==========
                // Query the ENTIRE table for export
                console.log("Getting full table data for export...");
                const fullQuery = `SELECT * FROM ${tableName}`;
                const fullResult = db.exec(fullQuery);
                
                // Store full table data for export
                window.currentTableData = {
                    tableName: tableName,
                    columns: fullResult[0]?.columns || [],
                    values: fullResult[0]?.values || [],
                    rowCount: fullResult[0]?.values?.length || 0
                };
                
                console.log(`Stored ${window.currentTableData.rowCount} rows for export`);
                
                // ========== THEN GET LIMITED DATA FOR DISPLAY ==========
                // Simple query - no quotes, just table name
                const displayQuery = `SELECT * FROM ${tableName} LIMIT 10`;
                console.log("Executing display query:", displayQuery);
                
                const displayResult = db.exec(displayQuery);
                console.log("Display query result:", displayResult);
                
                if (!displayResult.length || !displayResult[0].values.length) {
                    resultsDiv.innerHTML = `<div style="padding: 20px;">Table "${tableName}" is empty or not found</div>`;
                    return;
                }
                
                // Display the data WITH EXPORT BUTTON
                displayTablePreview(
                    tableName, 
                    displayResult[0].columns, 
                    displayResult[0].values,
                    window.currentTableData.rowCount  // Pass total count for display
                );
                
            } catch (error) {
                console.error("Error in previewTableData:", error);
                resultsDiv.innerHTML = `
                    <div style="color: red; padding: 20px; border: 1px solid red;">
                        <strong>Error loading ${tableName}:</strong><br>
                        ${error.message}<br><br>
                        Try a different table.
                    </div>
                `;
            }
        }
        
        // 3. UPDATED display function with export button and total count
        function displayTablePreview(tableName, columns, rows, totalRows = rows.length) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            console.log(`Displaying ${rows.length} of ${totalRows} rows from ${tableName}`);
            
            // Build HTML
            let html = `<h3 style="color: #0a3b9c;">${tableName}</h3>`;
            html += `<p>Showing ${rows.length} of ${totalRows} total rows</p>`;
            html += `<div style="overflow-x: auto; margin-top: 10px;">`;
            html += `<table border="1" style="border-collapse: collapse; width: 100%;">`;
            
            // Header
            html += `<tr style="background: #245edc; color: white;">`;
            columns.forEach(col => {
                html += `<th style="padding: 8px; text-align: left;">${col}</th>`;
            });
            html += `</tr>`;
            
            // Data rows
            rows.forEach((row, rowIndex) => {
                html += `<tr style="${rowIndex % 2 === 0 ? 'background: #f8f8f8;' : ''}">`;
                row.forEach(cell => {
                    let displayValue;
                    if (cell === null || cell === undefined) {
                        displayValue = '<em style="color: #999;">NULL</em>';
                    } else {
                        const str = String(cell);
                        displayValue = str.length > 30 ? str.substring(0, 30) + '...' : str;
                    }
                    html += `<td style="padding: 6px; border: 1px solid #ddd;">${displayValue}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</table></div>`;
            
            // ADD EXPORT BUTTON - only if we have data
            if (totalRows > 0) {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                        <button onclick="exportCurrentTable()" 
                                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 14px;">
                            üíæ Export Full Table (${totalRows} rows) to CSV
                        </button>
                        <div style="margin-top: 8px; color: #666; font-size: 13px;">
                            Exports all ${totalRows} rows from the ${tableName} table
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            console.log("Table displayed successfully with export button");
        }
        
        // 4. EXPORT FUNCTION for current table
        function exportCurrentTable() {
            if (!window.currentTableData || !window.currentTableData.tableName) {
                alert('No table data available for export. Click a table first.');
                return;
            }
            
            const { tableName, columns, values, rowCount } = window.currentTableData;
            
            console.log(`Exporting: ${tableName} with ${rowCount} rows`);
            
            if (!values || values.length === 0) {
                alert(`Table "${tableName}" is empty.`);
                return;
            }
            
            try {
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        // Wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Create filename
                const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const filename = `${tableName}_${timestamp}.csv`;
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úÖ Exported ${rowCount} rows from "${tableName}" to:\n${filename}`);
                console.log(`Exported ${rowCount} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Error exporting "${tableName}": ${error.message}`);
            }
        }
        
        // 3. SIMPLE display function WITH EXPORT BUTTON
        function displayTablePreview(tableName, columns, rows) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            console.log(`Displaying ${rows.length} rows from ${tableName}`);
            
            // Build HTML
            let html = `<h3 style="color: #0a3b9c;">${tableName}</h3>`;
            html += `<p>Showing ${rows.length} rows</p>`;
            html += `<div style="overflow-x: auto; margin-top: 10px;">`;
            html += `<table border="1" style="border-collapse: collapse; width: 100%;">`;
            
            // Header
            html += `<tr style="background: #245edc; color: white;">`;
            columns.forEach(col => {
                html += `<th style="padding: 8px; text-align: left;">${col}</th>`;
            });
            html += `</tr>`;
            
            // Data rows
            rows.forEach((row, rowIndex) => {
                html += `<tr style="${rowIndex % 2 === 0 ? 'background: #f8f8f8;' : ''}">`;
                row.forEach(cell => {
                    let displayValue;
                    if (cell === null || cell === undefined) {
                        displayValue = '<em style="color: #999;">NULL</em>';
                    } else {
                        const str = String(cell);
                        displayValue = str.length > 30 ? str.substring(0, 30) + '...' : str;
                    }
                    html += `<td style="padding: 6px; border: 1px solid #ddd;">${displayValue}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</table></div>`;
            
            // ADD EXPORT BUTTON
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border: 1px solid #a0c0ff; border-radius: 3px;">
                    <button onclick="exportTable('${tableName}')" 
                            style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                        üíæ Export Full Table to CSV
                    </button>
                    <span style="margin-left: 10px; color: #666; font-size: 14px;">
                        Export all data from ${tableName} table
                    </span>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            console.log("Table displayed successfully with export button");
        }
        
        // 4. EXPORT TABLE FUNCTION
        function exportTable(tableName) {
            console.log(`Exporting table: ${tableName}`);
            
            if (!db) {
                alert('Database not loaded.');
                return;
            }
            
            try {
                // Query the FULL table (no LIMIT)
                const result = db.exec(`SELECT * FROM ${tableName}`);
                
                if (!result.length || !result[0].values.length) {
                    alert(`Table "${tableName}" is empty.`);
                    return;
                }
                
                const columns = result[0].columns;
                const values = result[0].values;
                
                console.log(`Exporting ${values.length} rows, ${columns.length} columns`);
                
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        // Wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Create filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const filename = `${tableName}_export_${timestamp}.csv`;
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úÖ Exported ${values.length} rows from "${tableName}" to ${filename}`);
                console.log(`Exported ${values.length} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Error exporting "${tableName}": ${error.message}`);
            }
        }
        
        // 4. TEST function - call this from browser console
        function testTablePreview() {
            console.log("=== TEST TABLE PREVIEW ===");
            
            if (!db) {
                console.log("Database not loaded");
                alert("Load database first");
                return;
            }
            
            // Get first table
            const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' LIMIT 1");
            if (result.length && result[0].values.length) {
                const firstTable = result[0].values[0][0];
                console.log("Testing with table:", firstTable);
                previewTableData(firstTable);
            } else {
                console.log("No tables found");
            }
        }

        // Run SQL query
        function runSQLQuery() {
            const queryInput = document.getElementById('sql-query');
            if (!queryInput) return;
            
            const query = queryInput.value.trim();
            if (!query) {
                alert('Please enter a SQL query to run.');
                return;
            }
            
            if (!db) {
                alert('Database not loaded yet. Please wait.');
                return;
            }
            
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div style="color: blue; padding: 20px; text-align: center;">Executing query...</div>';
            }
            
            try {
                // Basic query validation
                const queryLower = query.toLowerCase();
                if (queryLower.includes('drop ') || queryLower.includes('delete ') || 
                    queryLower.includes('update ') || queryLower.includes('insert ') ||
                    queryLower.includes('alter ') || queryLower.includes('create ')) {
                    throw new Error('Only SELECT queries are allowed for safety.');
                }
                
                const result = db.exec(query);
                
                if (result.length === 0) {
                    displayQueryResults({ columns: [], values: [] }, 'Query executed (no results)');
                } else {
                    displayQueryResults(result[0], 'Query Results');
                }
                
                // Store for export
                currentQueryResults = { query, result: result[0] };
                
            } catch (error) {
                const errorDiv = document.getElementById('query-results');
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div style="color: red; font-weight: bold;">SQL Error:</div>
                        <div style="color: #666; margin: 10px 0; padding: 10px; background: #fff0f0; border: 1px solid red;">
                            ${error.message}
                        </div>
                        <div style="margin-top: 10px; color: #666;">Query: ${query.substring(0, 200)}${query.length > 200 ? '...' : ''}</div>
                    `;
                }
                console.error('SQL Error:', error);
            }
        }

        // Display query results
        function displayQueryResults(data, title = 'Results') {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            const columns = data.columns || [];
            const values = data.values || [];
            
            if (values.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="color: green; font-weight: bold;">‚úì ${title}</div>
                    <div style="margin-top: 10px; color: #666;">0 rows returned</div>
                `;
                return;
            }
            
            let html = `
                <div style="color: green; font-weight: bold;">‚úì ${title}</div>
                <div style="margin-top: 5px; color: #666;">
                    Returned ${values.length} rows with ${columns.length} columns
                </div>
                <div style="margin-top: 10px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr style="background-color: #245edc; color: white;">
            `;
            
            // Add headers
            columns.forEach(column => {
                html += `<th style="padding: 8px; border: 1px solid #0a3b9c; text-align: left;">${column}</th>`;
            });
            html += '</tr>';
            
            // Add data rows (limit to 100 for display)
            const displayLimit = Math.min(values.length, 100);
            for (let i = 0; i < displayLimit; i++) {
                const row = values[i];
                html += '<tr style="border-bottom: 1px solid #ddd;' + (i % 2 === 0 ? ' background-color: #f8f8f8;' : '') + '">';
                columns.forEach((column, colIndex) => {
                    const value = row[colIndex];
                    const displayValue = value !== null && value !== undefined ? 
                        String(value).substring(0, 50) + (String(value).length > 50 ? '...' : '') : 
                        '<em style="color: #999;">NULL</em>';
                    html += `<td style="padding: 6px; border: 1px solid #ddd;" title="${value !== null ? String(value).replace(/"/g, '&quot;') : ''}">${displayValue}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table></div>';
            
            if (values.length > 100) {
                html += `
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Showing first 100 of ${values.length} rows
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        // Export results to CSV
        // ================= CSV EXPORT FUNCTION =================

        // Export current query results to CSV
        function exportResults() {
            console.log("Export button clicked");
            
            // Check if we have results to export
            if (!currentQueryResults || !currentQueryResults.query) {
                alert('No query results to export. Please run a query first.');
                return;
            }
            
            const { query, result } = currentQueryResults;
            const columns = result?.columns || [];
            const values = result?.values || [];
            
            console.log("Exporting:", columns.length, "columns,", values.length, "rows");
            
            if (values.length === 0) {
                alert('No data to export.');
                return;
            }
            
            try {
                // Create CSV content
                let csvContent = '';
                
                // Add column headers
                csvContent += columns.join(',') + '\n';
                
                // Add data rows
                values.forEach(row => {
                    const csvRow = row.map(cell => {
                        if (cell === null || cell === undefined) {
                            return '';
                        }
                        
                        let cellStr = String(cell);
                        
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes('"')) {
                            cellStr = cellStr.replace(/"/g, '""');
                        }
                        
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            cellStr = `"${cellStr}"`;
                        }
                        
                        return cellStr;
                    }).join(',');
                    
                    csvContent += csvRow + '\n';
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                let filename = 'query_results.csv';
                
                // Try to extract table name from query for better filename
                const tableMatch = query.match(/FROM\s+(\w+)/i) || query.match(/FROM\s+"(\w+)"/i);
                if (tableMatch && tableMatch[1]) {
                    filename = `${tableMatch[1]}_${timestamp}.csv`;
                } else {
                    filename = `query_${timestamp}.csv`;
                }
                
                link.href = url;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`‚úì Exported ${values.length} rows to ${filename}`);
                console.log(`Exported ${values.length} rows to ${filename}`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }
        
        // Also export table previews to CSV
        function exportTablePreview(tableName) {
            if (!db) {
                alert('Database not loaded.');
                return;
            }
            
            try {
                // Query the table
                const result = db.exec(`SELECT * FROM ${tableName}`);
                
                if (!result.length || !result[0].values.length) {
                    alert(`Table "${tableName}" is empty.`);
                    return;
                }
                
                const columns = result[0].columns;
                const values = result[0].values;
                
                // Create CSV
                let csvContent = columns.join(',') + '\n';
                values.forEach(row => {
                    csvContent += row.map(cell => {
                        if (cell === null || cell === undefined) return '';
                        let str = String(cell);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            str = `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    }).join(',') + '\n';
                });
                
                // Download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}_export.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                alert(`Exported ${values.length} rows from "${tableName}"`);
                
            } catch (error) {
                alert(`Error exporting ${tableName}: ${error.message}`);
            }
        }
        
        // ================= UPDATE EXISTING FUNCTIONS =================
        
        // Update runSQLQuery to store results for export
        function runSQLQuery() {
            const query = document.getElementById('sql-query')?.value.trim();
            if (!query) {
                alert('Please enter a SQL query to run.');
                return;
            }
            
            if (!db) {
                alert('Database not loaded yet. Please wait.');
                return;
            }
            
            const resultsDiv = document.getElementById('query-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div style="color: blue; padding: 20px; text-align: center;">Executing query...</div>';
            }
            
            try {
                const result = db.exec(query);
                
                if (result.length === 0) {
                    displayQueryResults({ columns: [], values: [] }, 'Query executed (no results)');
                    currentQueryResults = { query, result: { columns: [], values: [] } };
                } else {
                    displayQueryResults(result[0], 'Query Results');
                    // STORE RESULTS FOR EXPORT - THIS IS CRITICAL
                    currentQueryResults = { query, result: result[0] };
                }
                
            } catch (error) {
                // ... error handling ...
            }
        }
        
        // Update previewTableData to store results for export
        function previewTableData(tableName) {
            console.log('DEBUG: previewTableData called with:', tableName);
            
            try {
                if (!db) {
                    alert('Database not loaded.');
                    return;
                }
                
                const resultsDiv = document.getElementById('query-results');
                if (!resultsDiv) {
                    console.error('ERROR: No element with id="query-results"');
                    alert('Cannot find results display area.');
                    return;
                }
                
                resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: blue;">Loading ${tableName}...</div>`;
                
                // Query the table
                const query = `SELECT * FROM ${tableName}`;
                const result = db.exec(query);
                
                if (!result.length || !result[0].values.length) {
                    resultsDiv.innerHTML = `<div style="padding: 20px;">Table "${tableName}" is empty or not found</div>`;
                    currentQueryResults = { query, result: { columns: [], values: [] } };
                    return;
                }
                
                // Display first 20 rows
                const displayResult = db.exec(`SELECT * FROM ${tableName} LIMIT 20`);
                displayQueryResults(displayResult[0], `Table: ${tableName} (showing 20 of ${result[0].values.length} rows)`);
                
                // STORE FULL RESULTS FOR EXPORT
                currentQueryResults = { query, result: result[0] };
                
            } catch (error) {
                // ... error handling ...
            }
        }
        
        // Add export button to table preview
        function addExportButtonToPreview(tableName) {
            const resultsDiv = document.getElementById('query-results');
            if (!resultsDiv) return;
            
            // Check if export button already exists
            if (!document.getElementById('export-preview-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-preview-btn';
                exportBtn.className = 'btn btn-secondary';
                exportBtn.style.marginTop = '10px';
                exportBtn.innerHTML = 'üíæ Export Full Table to CSV';
                exportBtn.onclick = () => exportTablePreview(tableName);
                
                resultsDiv.appendChild(exportBtn);
            }
        }

        // Analyze client request
        function analyzeClientRequest() {
            const requestText = document.getElementById('client-request')?.value.trim();
            if (!requestText) {
                alert('Please enter a client request to analyze.');
                return;
            }
            
            // Simple keyword analysis
            const analysis = analyzeRequestText(requestText);
            displayAnalysisResults(analysis, requestText);
        }

        // Analyze request text
        function analyzeRequestText(requestText) {
            const requestLower = requestText.toLowerCase();
            
            // Detect tables
            const tables = [];
            if (requestLower.includes('patient')) tables.push('patients');
            if (requestLower.includes('appointment') || requestLower.includes('schedule')) tables.push('appointments');
            if (requestLower.includes('encounter') || requestLower.includes('visit')) tables.push('encounters');
            if (requestLower.includes('diagnosis')) tables.push('diagnoses');
            if (requestLower.includes('lab') || requestLower.includes('test')) tables.push('labs');
            if (requestLower.includes('prescription') || requestLower.includes('medication')) tables.push('prescriptions');
            
            // Default tables if none detected
            if (tables.length === 0) tables.push('patients', 'encounters');
            
            // Generate sample SQL
            let sampleSQL = '';
            if (tables.includes('patients') && tables.includes('encounters')) {
                sampleSQL = `SELECT p.first_name, p.last_name, p.city, e.encounter_date
FROM patients p
JOIN encounters e ON p.patient_id = e.patient_id
WHERE p.province = 'NT'
LIMIT 50`;
            } else if (tables.includes('patients')) {
                sampleSQL = `SELECT first_name, last_name, city, province
FROM patients
WHERE province = 'NT'
LIMIT 50`;
            } else {
                sampleSQL = `SELECT * FROM ${tables[0]} LIMIT 50`;
            }
            
            return {
                suggested_tables: tables,
                suggested_conditions: ['patients.province = "NT"'],
                sample_sql: sampleSQL,
                etl_requirements: [
                    `Extract data from ${tables.length} table(s)`,
                    'Apply appropriate joins between tables',
                    'Filter data based on request criteria',
                    'Include relevant columns for analysis'
                ]
            };
        }

        // Display analysis results
        function displayAnalysisResults(analysis, originalRequest) {
            const resultsDiv = document.getElementById('analysis-results');
            if (!resultsDiv) return;
            
            resultsDiv.style.display = 'block';
            
            // Update UI elements
            const tablesRequired = document.getElementById('tables-required');
            const sqlConditions = document.getElementById('sql-conditions');
            const sampleSql = document.getElementById('sample-sql');
            const etlRequirements = document.getElementById('etl-requirements');
            const sqlQueryBox = document.getElementById('sql-query');
            
            if (tablesRequired) tablesRequired.textContent = analysis.suggested_tables.join(', ');
            if (sqlConditions) sqlConditions.innerHTML = analysis.suggested_conditions.map(c => `<div>‚Ä¢ ${c}</div>`).join('');
            if (sampleSql) sampleSql.textContent = analysis.sample_sql;
            if (etlRequirements) etlRequirements.innerHTML = analysis.etl_requirements.map(r => `<div>‚Ä¢ ${r}</div>`).join('');
            if (sqlQueryBox) sqlQueryBox.value = analysis.sample_sql;
            
            // Save as custom scenario
            saveCustomScenario(originalRequest, analysis);
        }

        // Save custom scenario
        function saveCustomScenario(request, analysis) {
            const scenario = {
                id: Date.now(),
                request: request,
                timestamp: new Date().toISOString(),
                tables: analysis.suggested_tables,
                conditions: analysis.suggested_conditions,
                sql: analysis.sample_sql
            };
            
            customScenarios.push(scenario);
            localStorage.setItem('customScenarios', JSON.stringify(customScenarios));
            
            updateCustomScenariosDropdown();
        }

        // Update custom scenarios dropdown
        function updateCustomScenariosDropdown() {
            const container = document.querySelector('.scenario-container');
            if (!container) return;
            
            container.innerHTML = '<h4 style="margin-top: 20px;">Your Custom Scenarios:</h4>';
            
            if (customScenarios.length === 0) {
                container.innerHTML += '<p>No custom scenarios yet. Analyze a request to create one.</p>';
                return;
            }
            
            // Show last 5 custom scenarios
            customScenarios.slice(-5).reverse().forEach(scenario => {
                const scenarioBox = document.createElement('div');
                scenarioBox.className = 'scenario-box';
                scenarioBox.innerHTML = `
                    <div class="scenario-title">Custom: ${scenario.request.substring(0, 50)}${scenario.request.length > 50 ? '...' : ''}</div>
                    <div class="scenario-desc">${new Date(scenario.timestamp).toLocaleDateString()} - ${scenario.tables.length} tables</div>
                `;
                scenarioBox.addEventListener('click', () => {
                    const clientRequestBox = document.getElementById('client-request');
                    const sqlQueryBox = document.getElementById('sql-query');
                    
                    if (clientRequestBox) clientRequestBox.value = scenario.request;
                    if (sqlQueryBox) sqlQueryBox.value = scenario.sql;
                    
                    analyzeClientRequest();
                });
                container.appendChild(scenarioBox);
            });
        }

        // Load scenario
        function loadScenario(scenarioName) {
            const scenarios = {
                diabetes: {
                    clientRequest: "I need all diabetic patients aged 50+ from Yellowknife",
                    sample_sql: `SELECT p.first_name, p.last_name, p.dob, p.city, d.icd_code, d.description
FROM patients p
JOIN encounters e ON p.patient_id = e.patient_id
JOIN diagnoses d ON e.encounter_id = d.encounter_id
WHERE p.city = 'Yellowknife'
  AND d.icd_code LIKE 'E11%'
LIMIT 50`
                },
                appointments: {
                    clientRequest: "Show all appointments by region for 2024",
                    sample_sql: `SELECT p.province, p.city, a.appt_type, a.appt_start, a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
WHERE a.appt_start >= '2024-01-01'
ORDER BY p.city, a.appt_start
LIMIT 50`
                }
            };
            
            const scenario = scenarios[scenarioName];
            if (scenario) {
                const clientRequestBox = document.getElementById('client-request');
                const sqlQueryBox = document.getElementById('sql-query');
                
                if (clientRequestBox) clientRequestBox.value = scenario.clientRequest;
                if (sqlQueryBox) sqlQueryBox.value = scenario.sample_sql;
                
                analyzeClientRequest();
            }
        }

        // Clear query
        function clearQuery() {
            const sqlQueryBox = document.getElementById('sql-query');
            const resultsDiv = document.getElementById('query-results');
            
            if (sqlQueryBox) sqlQueryBox.value = '';
            if (resultsDiv) resultsDiv.innerHTML = 'Results will appear here...';
        }

        // Save query
        function saveQuery() {
            const query = document.getElementById('sql-query')?.value.trim();
            if (!query) {
                alert('Please enter a query to save.');
                return;
            }
            
            const queryName = prompt('Enter a name for this query:', 'My Query');
            if (queryName) {
                savedQueries.push({
                    name: queryName,
                    query: query,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem('emrSavedQueries', JSON.stringify(savedQueries));
                loadSavedQueries();
                alert('Query saved successfully!');
            }
        }

        // Load saved queries
        function loadSavedQueries() {
            const select = document.getElementById('saved-queries');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a saved query...</option>';
            
            savedQueries.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${q.name} (${new Date(q.timestamp).toLocaleDateString()})`;
                select.appendChild(option);
            });
        }

        // Load a saved query
        function loadSavedQuery() {
            const index = this.value;
            const sqlQueryBox = document.getElementById('sql-query');
            
            if (index && savedQueries[index] && sqlQueryBox) {
                sqlQueryBox.value = savedQueries[index].query;
            }
        }

        // Render schema diagram
        function renderSchemaDiagram() {
            const diagram = document.getElementById('schema-diagram');
            if (!diagram || !window.emrSchema) return;
            
            diagram.innerHTML = '';
            
            Object.keys(window.emrSchema).forEach(tableName => {
                const table = window.emrSchema[tableName];
                const tableNode = document.createElement('div');
                tableNode.className = 'table-node';
                tableNode.innerHTML = `
                    <div class="table-name">${tableName}</div>
                    <div class="table-fields">
                        ${table.columns.slice(0, 5).map(col => 
                            `<div class="table-field">${col.name} (${col.type})</div>`
                        ).join('')}
                        ${table.columns.length > 5 ? 
                            `<div class="table-field">... ${table.columns.length - 5} more fields</div>` : ''}
                    </div>
                `;
                diagram.appendChild(tableNode);
            });
        }

        // Render table selector
        function renderTableSelector() {
            const selector = document.getElementById('table-selector');
            if (!selector || !window.emrSchema) return;
            
            selector.innerHTML = '';
            
            Object.keys(window.emrSchema).forEach(tableName => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" class="table-checkbox" value="${tableName}">
                    ${tableName} (${window.emrSchema[tableName].columns.length} fields)
                `;
                selector.appendChild(label);
            });
        }

        // Create status div for database loading
        function createStatusDiv() {
            const emrTab = document.getElementById('emr-tab');
            if (!emrTab) return null;
            
            const statusDiv = document.createElement('div');
            statusDiv.id = 'database-status';
            statusDiv.style.cssText = `
                padding: 10px;
                margin: 10px 0;
                background: #f0f8ff;
                border: 1px solid #a0c0ff;
                border-radius: 3px;
                font-size: 14px;
            `;
            
            emrTab.insertBefore(statusDiv, emrTab.firstChild);
            return statusDiv;
        }


        // ============================================
        // KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL
        // ============================================


        // ================= KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL WITH REAL API =================

        // ================= KNOWLEDGE MANAGEMENT: SPECIFICATION TOOL =================
        
        // Store for terminology tree and cards
        let specCards = JSON.parse(localStorage.getItem('nwtSpecCards')) || [];
        let terminologyTree = null;
        
        // Initialize spec tool
        function initSpecTool() {
            console.log('Initializing Specification Tool...');
            
            // Load saved cards
            loadSavedCards();
            
            // Setup event listeners
            const treeSearch = document.getElementById('treeSearch');
            if (treeSearch) {
                treeSearch.addEventListener('input', searchTerminologyTree);
            }
            
            // Load demo terminology if no cards exist
            if (specCards.length === 0) {
                // Don't auto-load - let user click button
            }
            
            updateStats();
        }
        
        // Load demo terminology tree
        function loadDemoTerminology() {
            console.log('Loading demo terminology...');
            
            // Sample FHIR/SNOMED terminology tree
            const demoTree = [
                {
                    name: "Clinical Parameters",
                    type: "category",
                    children: [
                        {
                            name: "Diabetes Mellitus",
                            code: "SNOMED:73211009",
                            description: "Diabetes mellitus (disorder)",
                            type: "parameter",
                            children: [
                                {
                                    name: "Type 1 Diabetes",
                                    code: "SNOMED:46635009",
                                    description: "Insulin dependent diabetes mellitus",
                                    type: "parameter"
                                },
                                {
                                    name: "Type 2 Diabetes",
                                    code: "SNOMED:44054006",
                                    description: "Diabetes mellitus type 2",
                                    type: "parameter"
                                }
                            ]
                        },
                        {
                            name: "Hypertension",
                            code: "SNOMED:38341003",
                            description: "Hypertensive disorder",
                            type: "parameter",
                            children: [
                                {
                                    name: "Essential Hypertension",
                                    code: "SNOMED:59621000",
                                    description: "Essential hypertension",
                                    type: "parameter"
                                }
                            ]
                        },
                        {
                            name: "Body Mass Index",
                            code: "LOINC:39156-5",
                            description: "Body mass index (BMI)",
                            type: "parameter"
                        }
                    ]
                },
                {
                    name: "Demographics",
                    type: "category",
                    children: [
                        {
                            name: "Age at Visit",
                            code: "ISO:Age",
                            description: "Patient age at encounter date",
                            type: "parameter"
                        },
                        {
                            name: "Administrative Gender",
                            code: "HL7:Gender",
                            description: "Administrative gender",
                            type: "parameter",
                            children: [
                                { name: "Male", code: "M", type: "value" },
                                { name: "Female", code: "F", type: "value" },
                                { name: "Other", code: "O", type: "value" }
                            ]
                        }
                    ]
                },
                {
                    name: "Laboratory Results",
                    type: "category",
                    children: [
                        {
                            name: "Hemoglobin A1c",
                            code: "LOINC:4548-4",
                            description: "Hemoglobin A1c/Hemoglobin.total in Blood",
                            type: "parameter"
                        },
                        {
                            name: "Cholesterol",
                            code: "LOINC:2093-3",
                            description: "Cholesterol in Serum or Plasma",
                            type: "parameter",
                            children: [
                                { name: "HDL Cholesterol", code: "LOINC:2085-9", type: "parameter" },
                                { name: "LDL Cholesterol", code: "LOINC:13457-7", type: "parameter" }
                            ]
                        }
                    ]
                }
            ];
            
            terminologyTree = demoTree;
            renderTerminologyTree(demoTree);
        }
        
        // Render terminology tree recursively
        function renderTerminologyTree(data, container = null) {
            const targetContainer = container || document.getElementById('treeContainer');
            if (!targetContainer) {
                console.error('treeContainer not found!');
                return;
            }
            
            targetContainer.innerHTML = '';
            
            const ul = document.createElement('ul');
            ul.style.listStyleType = 'none';
            ul.style.paddingLeft = '10px';
            
            if (!data || data.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="color: #666; padding: 10px;">No data available</div>';
                ul.appendChild(li);
                targetContainer.appendChild(ul);
                return;
            }
            
            data.forEach(item => {
                const li = document.createElement('li');
                li.style.marginBottom = '5px';
                
                if (item.children && item.children.length > 0) {
                    // It's a category/folder - use details/summary
                    const details = document.createElement('details');
                    details.open = true;
                    
                    const summary = document.createElement('summary');
                    summary.style.cursor = 'pointer';
                    summary.style.padding = '5px';
                    summary.style.backgroundColor = '#e0e8ff';
                    summary.style.borderRadius = '3px';
                    summary.style.fontWeight = 'bold';
                    summary.style.color = '#0a3b9c';
                    summary.textContent = item.name;
                    
                    const childContainer = document.createElement('div');
                    childContainer.style.marginLeft = '15px';
                    childContainer.style.marginTop = '5px';
                    
                    details.appendChild(summary);
                    details.appendChild(childContainer);
                    li.appendChild(details);
                    
                    // Recursively render children
                    renderTerminologyTree(item.children, childContainer);
                    
                } else {
                    // It's a leaf node (parameter)
                    const span = document.createElement('span');
                    span.className = 'leaf-node';
                    span.style.display = 'block';
                    span.style.padding = '8px';
                    span.style.margin = '2px 0';
                    span.style.cursor = 'pointer';
                    span.style.backgroundColor = '#f0f0f0';
                    span.style.borderRadius = '3px';
                    span.style.borderLeft = '3px solid #4CAF50';
                    span.style.fontSize = '14px';
                    
                    span.innerHTML = `
                        <strong>${item.name}</strong>
                        ${item.code ? `<br><small style="color: #666;">${item.code}</small>` : ''}
                        ${item.description ? `<br><small style="color: #888;">${item.description}</small>` : ''}
                    `;
                    
                    // Add click handler to add parameter to board
                    span.addEventListener('click', function(e) {
                        e.stopPropagation();
                        addParameterCard(item);
                    });
                    
                    li.appendChild(span);
                }
                
                ul.appendChild(li);
            });
            
            targetContainer.appendChild(ul);
        }
        
        // Search terminology tree
        function searchTerminologyTree(event) {
            const term = event.target.value.toLowerCase().trim();
            const allLeaves = document.querySelectorAll('.leaf-node');
            
            if (!term) {
                // Show all
                allLeaves.forEach(leaf => {
                    leaf.style.display = 'block';
                });
                return;
            }
            
            allLeaves.forEach(leaf => {
                const text = leaf.textContent.toLowerCase();
                leaf.style.display = text.includes(term) ? 'block' : 'none';
            });
        }
        
        // Add parameter card to board
        function addParameterCard(item) {
            // Check if already added
            const existingCard = specCards.find(card => card.code === item.code);
            if (existingCard) {
                alert(`Parameter "${item.name}" is already on the board.`);
                return;
            }
            
            // Create card object
            const cardId = `card-${Date.now()}`;
            const card = {
                id: cardId,
                name: item.name,
                code: item.code || '',
                description: item.description || '',
                source: '',
                logic: '',
                timestamp: new Date().toISOString()
            };
            
            specCards.push(card);
            
            // Update UI
            renderCard(card);
            updateStats();
            saveCardsToStorage();
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
        }
        
        // Render a single card
        function renderCard(card) {
            const board = document.getElementById('spec-board');
            if (!board) {
                console.error('spec-board element not found!');
                return;
            }
            
            const cardHTML = `
                <div class="spec-card" id="${card.id}" style="background: white; border: 1px solid #d4d0c8; border-radius: 3px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0; color: #0a3b9c;">${card.name}</h4>
                            <small style="color: #666; font-family: 'Courier New', monospace;">${card.code}</small>
                        </div>
                        <button onclick="removeCard('${card.id}')" 
                                style="background: none; border: none; color: #cc0000; cursor: pointer; font-size: 20px; padding: 0 5px; line-height: 1;">√ó</button>
                    </div>
                    
                    ${card.description ? `<p style="margin: 0 0 10px 0; color: #666; font-size: 13px;">${card.description}</p>` : ''}
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333;">
                            üìç Source Table/Column:
                        </label>
                        <input type="text" 
                               class="card-source" 
                               placeholder="e.g. DBO.PATIENTS.DOB or patients.date_of_birth"
                               value="${card.source}"
                               style="width: 100%; padding: 6px; border: 1px solid #808080; border-radius: 3px; font-size: 13px;"
                               onchange="updateCardField('${card.id}', 'source', this.value)">
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333;">
                            ‚öôÔ∏è ETL Transformation Logic:
                        </label>
                        <textarea class="card-logic" 
                                  placeholder="Describe calculation, filter, or transformation..."
                                  style="width: 100%; min-height: 80px; padding: 6px; border: 1px solid #808080; border-radius: 3px; font-size: 13px; resize: vertical;"
                                  onchange="updateCardField('${card.id}', 'logic', this.value)">${card.logic}</textarea>
                    </div>
                    
                    <div style="margin-top: 10px; font-size: 11px; color: #888; text-align: right;">
                        Added: ${new Date(card.timestamp).toLocaleDateString()}
                    </div>
                </div>
            `;
            
            // Insert at the top
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg && emptyMsg.style.display !== 'none') {
                board.innerHTML = cardHTML;
            } else {
                board.insertAdjacentHTML('afterbegin', cardHTML);
            }
        }
        
        // Update card field
        function updateCardField(cardId, field, value) {
            const card = specCards.find(c => c.id === cardId);
            if (card) {
                card[field] = value;
                saveCardsToStorage();
                updateStats();
            }
        }
        
        // Remove card - FIXED FUNCTION
        function removeCard(cardId) {
            console.log('Removing card:', cardId);
            
            // Remove from array
            specCards = specCards.filter(card => card.id !== cardId);
            
            // Remove from DOM
            const cardElement = document.getElementById(cardId);
            if (cardElement) {
                cardElement.remove();
            }
            
            // Show empty message if no cards left
            if (specCards.length === 0) {
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
            }
            
            updateStats();
            saveCardsToStorage();
        }
        
        // Load saved cards
        function loadSavedCards() {
            const board = document.getElementById('spec-board');
            if (!board) {
                console.error('spec-board element not found!');
                return;
            }
            
            if (specCards.length === 0) {
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
                return;
            }
            
            // Hide empty message
            const emptyMsg = document.getElementById('empty-board-message');
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Clear and re-render all cards
            board.innerHTML = '';
            specCards.forEach(card => {
                renderCard(card);
            });
        }
        
        // Save cards to localStorage
        function saveCardsToStorage() {
            localStorage.setItem('nwtSpecCards', JSON.stringify(specCards));
        }
        
        // Update statistics
        function updateStats() {
            const totalCards = specCards.length;
            const mappedCards = specCards.filter(card => card.source.trim() !== '').length;
            
            const countElement = document.getElementById('card-count');
            const mappedElement = document.getElementById('mapped-count');
            
            if (countElement) {
                countElement.textContent = `${totalCards} parameter${totalCards !== 1 ? 's' : ''} mapped`;
            }
            
            if (mappedElement) {
                mappedElement.textContent = `${mappedCards} with source mapping`;
            }
        }
        
        // Export to CSV
        function exportSpecToCSV() {
            if (specCards.length === 0) {
                alert('No parameters to export. Add some parameters first.');
                return;
            }
            
            // Create CSV content
            let csvContent = 'data:text/csv;charset=utf-8,';
            
            // Headers
            csvContent += 'Parameter Name,Standard Code,Description,Source Column,ETL Logic\n';
            
            // Data rows
            specCards.forEach(card => {
                const row = [
                    `"${card.name}"`,
                    `"${card.code}"`,
                    `"${card.description || ''}"`,
                    `"${card.source || ''}"`,
                    `"${card.logic.replace(/"/g, '""')}"`
                ].join(',');
                csvContent += row + '\n';
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `nwt_etl_specification_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show confirmation
            alert(`Exported ${specCards.length} parameters to CSV.`);
        }
        
        // Clear all cards - FIXED FUNCTION
        function clearAllCards() {
            if (specCards.length === 0) {
                alert('No cards to clear.');
                return;
            }
            
            if (confirm(`Are you sure you want to remove all ${specCards.length} parameters from the board?`)) {
                specCards = [];
                saveCardsToStorage();
                
                const board = document.getElementById('spec-board');
                if (board) board.innerHTML = '';
                
                const emptyMsg = document.getElementById('empty-board-message');
                if (emptyMsg) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerHTML = `
                        <h3>No Parameters Added</h3>
                        <p>Click on any item in the terminology tree to add it to the board.</p>
                        <p>Each card represents a data element that needs to be mapped for ETL development.</p>
                    `;
                }
                
                updateStats();
            }
        }
        
        // Clear tree - FIXED FUNCTION
        function clearTree() {
            const treeContainer = document.getElementById('treeContainer');
            if (treeContainer) {
                if (confirm('Clear the terminology tree? This will not affect your board.')) {
                    treeContainer.innerHTML = `
                        <div style="color: #666; text-align: center; padding: 20px;">
                            <p>Click "Load Demo Tree" for example terminology.</p>
                            <p>Or enter a search term to query real terminology servers.</p>
                        </div>
                    `;
                }
            }
        }


        // Search terminology function
        // Search real terminology - SIMPLIFIED WORKING VERSION
        async function searchRealTerminology(searchTerm) {
            const apiProvider = document.getElementById('api-provider').value;
            const treeContainer = document.getElementById('treeContainer');
            
            if (!treeContainer) return;
            
            // Show loading
            treeContainer.innerHTML = `
                <div style="color: #0a3b9c; text-align: center; padding: 40px;">
                    <div style="margin-bottom: 15px; font-size: 16px;">üîç Searching live terminology...</div>
                    <div style="font-size: 14px; color: #666;">"${searchTerm}"</div>
                    <div style="font-size: 12px; color: #888; margin-top: 10px;">
                        Querying ${apiProvider}...
                    </div>
                </div>
            `;
            
            try {
                let results = [];
                let sourceName = '';
                
                if (apiProvider === 'ONTOSERVER') {
                    // Ontoserver FHIR API
                    const url = `https://r4.ontoserver.csiro.au/fhir/ValueSet/$expand?url=http://snomed.info/sct?fhir_vs&filter=${encodeURIComponent(searchTerm)}&count=30`;
                    
                    console.log('Fetching from Ontoserver:', url);
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) throw new Error(`Ontoserver error: ${response.status}`);
                    
                    const data = await response.json();
                    results = parseOntoserverResponse(data);
                    sourceName = 'Ontoserver (FHIR)';
                    
                } else if (apiProvider === 'SNOWSTORM') {
                    // Snowstorm SNOMED API
                    const url = `https://snowstorm.ihtsdotools.org/snowstorm/snomed-ct/browser/MAIN/concepts?term=${encodeURIComponent(searchTerm)}&limit=30`;
                    
                    console.log('Fetching from Snowstorm:', url);
                    const response = await fetch(url);
                    
                    if (!response.ok) throw new Error(`Snowstorm error: ${response.status}`);
                    
                    const data = await response.json();
                    results = parseSnowstormResponse(data);
                    sourceName = 'Snowstorm (SNOMED CT)';
                }
                
                // Display results
                if (results.length > 0) {
                    displaySearchResults(results, searchTerm, sourceName);
                } else {
                    treeContainer.innerHTML = `
                        <div style="color: #666; text-align: center; padding: 30px;">
                            <div style="margin-bottom: 10px; font-size: 16px;">No results found for "${searchTerm}"</div>
                            <p style="margin-bottom: 20px;">Try:</p>
                            <ul style="text-align: left; display: inline-block; margin: 0 auto;">
                                <li>Different search terms</li>
                                <li>More specific terms (e.g., "Type 2 diabetes" instead of "diabetes")</li>
                                <li>Switching to Demo Mode</li>
                            </ul>
                            <button onclick="searchDemoTerminology('${searchTerm}')" class="btn btn-secondary" style="margin-top: 20px;">
                                Try Demo Data Instead
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('API Error:', error);
                
                // Fallback to demo data
                treeContainer.innerHTML = `
                    <div style="color: #cc0000; text-align: center; padding: 20px;">
                        <div style="margin-bottom: 10px; font-size: 16px;">‚ö†Ô∏è API Connection Issue</div>
                        <div style="margin-bottom: 15px; font-size: 14px;">${error.message}</div>
                        <p style="color: #666;">Falling back to demo data...</p>
                        <button onclick="searchDemoTerminology('${searchTerm}')" class="btn btn-primary" style="margin-top: 15px;">
                            Load Demo Results
                        </button>
                    </div>
                `;
                
                // Auto-fallback after 2 seconds
                setTimeout(() => {
                    searchDemoTerminology(searchTerm);
                }, 2000);
            }
        }
        
        // Parse Ontoserver response
        function parseOntoserverResponse(data) {
            const results = [];
            
            if (data.expansion && data.expansion.contains) {
                data.expansion.contains.forEach(item => {
                    // Filter out very generic results
                    if (item.display && item.code && !item.display.toLowerCase().includes('substance') && !item.display.toLowerCase().includes('product')) {
                        results.push({
                            name: item.display,
                            code: `SNOMED:${item.code}`,
                            system: 'SNOMED CT',
                            description: item.display,
                            type: 'parameter'
                        });
                    }
                });
            }
            
            return results.slice(0, 20); // Limit to 20 results
        }
        
        // Parse Snowstorm response
        function parseSnowstormResponse(data) {
            const results = [];
            
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    if (item.pt && item.pt.term && item.conceptId) {
                        results.push({
                            name: item.pt.term,
                            code: `SNOMED:${item.conceptId}`,
                            system: 'SNOMED CT',
                            description: item.fsn ? item.fsn.term : item.pt.term,
                            type: 'parameter'
                        });
                    }
                });
            }
            
            return results.slice(0, 20); // Limit to 20 results
        }
        
        // Make sure searchTerminology function uses this
        function searchTerminology() {
            const searchInput = document.getElementById('treeSearch');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                searchInput.focus();
                return;
            }
            
            const apiProvider = document.getElementById('api-provider').value;
            
            if (apiProvider === 'DEMO') {
                searchDemoTerminology(searchTerm);
            } else {
                searchRealTerminology(searchTerm);
            }
        }
        
        // Also update the quickSearch function
        function quickSearch(term) {
            const searchInput = document.getElementById('treeSearch');
            const apiSelect = document.getElementById('api-provider');
            
            searchInput.value = term;
            searchTerminology(); // This will use whatever API is selected
        }
        
        // Demo search function
        function searchDemoTerminology(searchTerm) {
            const demoData = [
                {
                    name: "Diabetes mellitus",
                    code: "SNOMED:73211009",
                    description: "Diabetes mellitus (disorder)",
                    system: "SNOMED CT"
                },
                {
                    name: "Type 2 diabetes mellitus",
                    code: "SNOMED:44054006",
                    description: "Diabetes mellitus type 2",
                    system: "SNOMED CT"
                },
                {
                    name: "Essential hypertension",
                    code: "SNOMED:59621000",
                    description: "Essential hypertension",
                    system: "SNOMED CT"
                },
                {
                    name: "Body mass index",
                    code: "LOINC:39156-5",
                    description: "Body mass index (BMI)",
                    system: "LOINC"
                },
                {
                    name: "Hemoglobin A1c",
                    code: "LOINC:4548-4",
                    description: "Hemoglobin A1c/Hemoglobin.total in Blood",
                    system: "LOINC"
                },
                {
                    name: "Influenza vaccine",
                    code: "SNOMED:86198006",
                    description: "Influenza virus vaccine",
                    system: "SNOMED CT"
                },
                {
                    name: "Pregnancy",
                    code: "SNOMED:289908002",
                    description: "Pregnant",
                    system: "SNOMED CT"
                }
            ];
            
            const filtered = demoData.filter(item => 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.system.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displaySearchResults(filtered, searchTerm, 'Demo Data');
        }
        
        // Display search results
        function displaySearchResults(results, searchTerm, source) {
            const treeContainer = document.getElementById('treeContainer');
            if (!treeContainer) return;
            
            if (results.length === 0) {
                treeContainer.innerHTML = `
                    <div style="color: #666; text-align: center; padding: 30px;">
                        <div style="margin-bottom: 10px;">No results found for "${searchTerm}"</div>
                        <p>Try a different search term or use demo data.</p>
                        <button onclick="loadDemoTerminology()" class="btn btn-secondary" style="font-size: 12px; margin-top: 10px;">
                            Load Demo Terminology
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 3px;">
                    <strong>Search Results:</strong> "${searchTerm}"
                    <span style="float: right; font-size: 12px;">
                        ${results.length} results ‚Ä¢ ${source}
                    </span>
                </div>
                <ul style="list-style-type: none; padding-left: 0;">
            `;
            
            results.forEach((item, index) => {
                html += `
                    <li style="margin-bottom: 8px;">
                        <div class="search-result-item" 
                             onclick="addParameterCard(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                             style="padding: 12px; background: white; border: 1px solid #d4d0c8; border-radius: 3px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.backgroundColor='#e8f0ff'; this.style.borderColor='#a0c0ff';"
                             onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#d4d0c8';">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex-grow: 1;">
                                    <strong style="color: #0a3b9c; font-size: 14px;">${item.name}</strong>
                                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; margin-top: 3px;">
                                        ${item.code}
                                    </div>
                                </div>
                                <span style="background: #4CAF50; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; white-space: nowrap;">
                                    ADD
                                </span>
                            </div>
                            
                            ${item.description ? `<div style="font-size: 12px; color: #666; margin-top: 8px;">${item.description}</div>` : ''}
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #888;">
                                <span>${item.system}</span>
                                <span>Click to add to board</span>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            // Add search tips
            html += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #d4d0c8;">
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">Search Tips:</div>
                    <ul style="font-size: 11px; color: #666; margin: 0; padding-left: 15px;">
                        <li>Use specific terms like "Type 2 diabetes" not just "diabetes"</li>
                        <li>Try both common names and medical terms</li>
                        <li>Switch to "Demo Mode" if live APIs are slow</li>
                        <li>Click any result to add it to your specification board</li>
                    </ul>
                </div>
            `;
            
            treeContainer.innerHTML = html;
        }
        
        // Also keep the Enter key functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('treeSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchTerminology();
                    }
                });
            }
        });
        
        // Make functions globally available
        window.searchTerminology = searchTerminology;
        window.quickSearch = quickSearch;
        window.searchDemoTerminology = searchDemoTerminology;
        
        // Add a simple test function to check if buttons work
        function testSpecTool() {
            console.log('Testing Spec Tool...');
            console.log('specCards:', specCards);
            console.log('spec-board element:', document.getElementById('spec-board'));
            console.log('treeContainer element:', document.getElementById('treeContainer'));
        }
        
        // Make sure functions are available globally
        window.loadDemoTerminology = loadDemoTerminology;
        window.addParameterCard = addParameterCard;
        window.removeCard = removeCard;
        window.clearAllCards = clearAllCards;
        window.clearTree = clearTree;
        window.exportSpecToCSV = exportSpecToCSV;
        window.updateCardField = updateCardField;
        
        // Initialize when Knowledge tab is clicked
        // Initialize when Knowledge tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            
            // Initialize spec tool when knowledge tab is activated
            const knowledgeTabButton = document.querySelector('[data-tab="knowledge-tab"]');
            if (knowledgeTabButton) {
                knowledgeTabButton.addEventListener('click', function() {
                    console.log('Knowledge tab clicked, initializing spec tool...');
                    setTimeout(initSpecTool, 100);
                });
            }
            
            // Also initialize when page loads if on knowledge tab
            const currentTab = document.querySelector('.tab-button.active');
            if (currentTab && currentTab.dataset.tab === 'knowledge-tab') {
                console.log('Starting on knowledge tab, initializing...');
                setTimeout(initSpecTool, 1000);
            }
        });
        // ============================================
        // FORM TAB FUNCTIONS (Keep your existing code)
        // ============================================
        
        // Update organization variable
        function updateOrganization() {
            const dhss = document.getElementById('dhss').checked;
            const hssa = document.getElementById('hssa').checked;
            const otherOrg = document.getElementById('other-org').checked;
            const otherText = document.getElementById('other-org-text').value;
            
            let org = "";
            if (dhss) {
                org = "DHSS";
            } else if (hssa) {
                org = "HSSA";
            } else if (otherOrg) {
                org = otherText ? `Other: ${otherText}` : "Other";
            }
            
            const orgInput = document.getElementById('organization');
            if (orgInput) orgInput.value = org;
        }

        // Validate form
        function validateForm() {
            clearValidationErrors();
            let hasErrors = false;
        
            // Organization check
            const dhss = document.getElementById('dhss')?.checked;
            const hssa = document.getElementById('hssa')?.checked;
            const otherOrg = document.getElementById('other-org')?.checked;
            if ((!dhss && !hssa && !otherOrg)) {
                showValidationError('org-error', 'Compliance Rule: You must select DHSS, HSSA, or Other.');
                hasErrors = true;
            }
        
            // Request number - ONLY ONCE!
            const requestNumber = document.getElementById('request-number')?.value.trim();
            const requestNumberError = document.getElementById('reqnum-error');
            
            // Check 1: Is it empty?
            if (!requestNumber) {
                showValidationError('reqnum-error', 'Compliance Rule: Request Number cannot be blank.');
                document.getElementById('request-number')?.classList.add('validation-error');
                hasErrors = true;
            } 
            // Check 2: Is format valid? (Add this check)
            else if (!isValidRequestNumber(requestNumber)) {
                showValidationError('reqnum-error', 'Invalid format. Must be like: IM-703546 (letters, dash, numbers)');
                document.getElementById('request-number')?.classList.add('validation-error');
                hasErrors = true;
            }
            // Check 3: Is it a duplicate?
            else if (isDuplicateRequestNumber(requestNumber)) {
                showValidationError('reqnum-error', 'This Request Number already exists. Use a unique number.');
                document.getElementById('request-number')?.classList.add('validation-error');
                hasErrors = true;
            }
        
            // Request history
            const requestHistory = document.querySelector('input[name="request-history"]:checked');
            if (!requestHistory) {
                showValidationError('history-error', 'Compliance Rule: You must select First Original or Recurring.');
                hasErrors = true;
            }
        
            // Legislative Authority
            const legislative = document.querySelector('input[name="legislative"]:checked');
            if (!legislative) {
                showValidationError('legislative-error', 'Compliance Rule: You must select Yes or No for Legislative Authority.');
                hasErrors = true;
            }
        
            // If Legislative Authority is Yes, description required
            if (legislative && legislative.value === "yes") {
                const legDesc = document.getElementById('legislative-desc')?.value.trim();
                if (!legDesc) {
                    showValidationError('legdesc-error', 'Compliance Rule: If Legislative Authority is Yes, you must describe it.');
                    document.getElementById('legislative-desc')?.classList.add('validation-error');
                    hasErrors = true;
                }
            }
        
            // Statutory Owner
            const statutory = document.querySelector('input[name="statutory"]:checked');
            if (!statutory) {
                showValidationError('statutory-error', 'Compliance Rule: You must select Yes or No for Statutory Owner.');
                hasErrors = true;
            }
        
            // Agreement Requirement
            const agreement = document.querySelector('input[name="agreement"]:checked');
            if (!agreement) {
                showValidationError('agreement-error', 'Compliance Rule: You must select Yes or No for Agreement Requirement.');
                hasErrors = true;
            }
        
            // Data Matching
            const matching = document.querySelector('input[name="matching"]:checked');
            if (!matching) {
                showValidationError('matching-error', 'Compliance Rule: You must select Yes or No for Data Matching.');
                hasErrors = true;
            }
        
            // Meeting Requirement
            const meeting = document.querySelector('input[name="meeting"]:checked');
            if (!meeting) {
                showValidationError('meeting-error', 'Compliance Rule: You must select Yes or No for Meeting Requirement.');
                hasErrors = true;
            }
        
            // Location
            const region = document.getElementById('region')?.value;
            const district = document.getElementById('district')?.value;
            if (!region || !district) {
                showValidationError('location-error', 'Compliance Rule: You must select both Region and District for Location.');
                if (!region) document.getElementById('region')?.classList.add('validation-error');
                if (!district) document.getElementById('district')?.classList.add('validation-error');
                hasErrors = true;
            }
        
            // Defined Purpose
            const definedPurpose = document.getElementById('defined-purpose')?.value.trim();
            if (!definedPurpose) {
                showValidationError('purpose-error', 'Compliance Rule: You must enter a Defined Purpose.');
                document.getElementById('defined-purpose')?.classList.add('validation-error');
                hasErrors = true;
            }
        
            return !hasErrors;
        }
        // NEW: Request Number Format Validation
        function isValidRequestNumber(requestNum) {
            // Pattern: letters (2-4), dash, numbers (4-6)
            // Examples: IM-703546, DHSS-24001, HSSA-98765
            const pattern = /^[A-Z]{2,4}-\d{4,6}$/;
            return pattern.test(requestNum);
        }

        function isDuplicateRequestNumber(requestNum) {
                return requestsData.some(request => 
                    request.request_number.toUpperCase() === requestNum.toUpperCase()
                );
            }

        function showValidationError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearValidationErrors() {
            document.querySelectorAll('.validation-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('validation-error');
            });
        }

        function getFormData() {
            updateOrganization();
            const org = document.getElementById('organization')?.value || '';
            
            const requestHistory = document.querySelector('input[name="request-history"]:checked')?.value;
            const recurringDate = requestHistory === 'recurring' ? document.getElementById('recurring-date')?.value : '';
            
            const legislative = document.querySelector('input[name="legislative"]:checked')?.value;
            const legislativeDesc = document.getElementById('legislative-desc')?.value || '';
            
            const conditions = document.querySelector('input[name="conditions"]:checked')?.value;
            const conditionsDesc = document.getElementById('conditions-desc')?.value || '';
            
            const statutory = document.querySelector('input[name="statutory"]:checked')?.value;
            const statutoryOptions = document.querySelectorAll('.statutory-option:checked');
            const statutorySelected = Array.from(statutoryOptions).map(option => option.value);
            const statutoryOther = document.getElementById('statutory-other')?.value || '';
            
            const agreement = document.querySelector('input[name="agreement"]:checked')?.value;
            const existingAgreement = document.getElementById('existing-agreement')?.checked;
            const agreementDesc = document.getElementById('agreement-desc')?.value || '';
            
            const matching = document.querySelector('input[name="matching"]:checked')?.value;
            const matchingDesc = document.getElementById('matching-desc')?.value || '';
            
            const meeting = document.querySelector('input[name="meeting"]:checked')?.value;
            const meetingDesc = document.getElementById('meeting-desc')?.value || '';
            
            const region = document.getElementById('region')?.value || '';
            const district = document.getElementById('district')?.value || '';
            
            const requestNumber = document.getElementById('request-number')?.value.trim() || '';
            const requestor = document.getElementById('requestor')?.value || '';
            const classification = document.getElementById('classification')?.value || '';
            const definedPurpose = document.getElementById('defined-purpose')?.value || '';
            const comments = document.getElementById('comments')?.value || '';
            
            // NEW FIELDS - Use the CORRECT IDs based on your HTML:
            const dataTypeSpec = document.getElementById('data-type-spec')?.value || '';
            const dataRequestFrequency = document.getElementById('data-request-frequency')?.value || '';
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
        
            return {  // ‚úÖ ONLY ONE return statement!
                id: nextId++,
                organization: org,
                request_number: requestNumber,
                requestor: requestor,
                classification: classification,
                request_history: requestHistory === 'first' ? 'First Original' : `Recurring: ${recurringDate}`,
                legislative_authority: legislative,
                legislative_description: legislativeDesc,
                conditions: conditions,
                conditions_description: conditionsDesc,
                statutory_owner: statutory,
                statutory_selected: statutorySelected,
                statutory_other: statutoryOther,
                defined_purpose: definedPurpose,
                agreement_required: agreement,
                existing_agreement: existingAgreement ? 'Yes' : 'No',
                agreement_description: agreementDesc,
                data_matching: matching,
                matching_description: matchingDesc,
                meeting_required: meeting,
                meeting_description: meetingDesc,
                region: region,
                district: district,
                data_type_specification: dataTypeSpec,      // Use the new field names
                data_request_frequency: dataRequestFrequency, // Use the new field names
                comments: comments,
                timestamp: timestamp
            };
        }  // ‚úÖ Don't forget the closing brace for the function!

        
        function saveRequest() {
            if (!validateForm()) {
                alert("Cannot save: Please fix all validation errors.");
                return;
            }
            
            const formData = getFormData();
            
            // Double-check request number is saved
            if (!formData.request_number) {
                alert("Error: Request Number is required!");
                return;
            }
            
            // Check for duplicate
            if (isDuplicateRequestNumber(formData.request_number)) {
                alert("Error: Request Number already exists!");
                return;
            }
            
            // Add to storage
            requestsData.push(formData);
            localStorage.setItem('dataRequests', JSON.stringify(requestsData));
            
            // Clear and refresh
            clearForm();
            loadTableData();
            
            alert(`Data request saved successfully!\nRequest Number: ${formData.request_number}`);
        }  // ‚úÖ Closing brace for saveRequest function

        // Load table data for form tab
       function loadTableData() {
        const tbody = document.getElementById('table-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (requestsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No requests saved yet.</td></tr>';
            return;
        }
        
        const sortedData = [...requestsData].sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
        
        sortedData.forEach(data => {
            const row = document.createElement('tr');
            
            const legislativeAuth = data.legislative_authority === 'yes' ? 
                `Yes: ${data.legislative_description.substring(0, 100)}...` : 'No';
            
            const definedPurpose = data.defined_purpose.length > 50 ? 
                data.defined_purpose.substring(0, 50) + '...' : data.defined_purpose;
            
            const location = `${data.region} / ${data.district}`;
            
            // UPDATED: Added request_number column
            row.innerHTML = `
                <td>${data.id}</td>
                <td><strong style="color: #0a3b9c; font-family: 'Courier New', monospace;">${data.request_number}</strong></td>
                <td>${data.organization}</td>
                <td>${legislativeAuth}</td>
                <td>${definedPurpose}</td>
                <td>${data.timestamp}</td>
                <td>${location}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

        // Clear form
        function clearForm() {
            clearValidationErrors();
            
            // Organization
            document.querySelectorAll('.org-checkbox').forEach(cb => cb.checked = false);
            const otherOrgText = document.getElementById('other-org-text');
            if (otherOrgText) otherOrgText.value = '';
            const orgInput = document.getElementById('organization');
            if (orgInput) orgInput.value = '';
            
            // Request details
            const requestNumber = document.getElementById('request-number');
            if (requestNumber) requestNumber.value = '';
            const requestor = document.getElementById('requestor');
            if (requestor) requestor.value = '';
            const classification = document.getElementById('classification');
            if (classification) classification.value = '';
            const recurringDate = document.getElementById('recurring-date');
            if (recurringDate) recurringDate.value = '';
            const firstRadio = document.querySelector('input[name="request-history"][value="first"]');
            if (firstRadio) firstRadio.checked = true;
            
            // Legislative
            document.querySelectorAll('input[name="legislative"]').forEach(r => r.checked = false);
            const legislativeDesc = document.getElementById('legislative-desc');
            if (legislativeDesc) legislativeDesc.value = '';
            
            // Conditions
            document.querySelectorAll('input[name="conditions"]').forEach(r => r.checked = false);
            const conditionsDesc = document.getElementById('conditions-desc');
            if (conditionsDesc) conditionsDesc.value = '';

            // NEW FIELDS - Use correct IDs:
            const dataTypeSpec = document.getElementById('data-type-spec');
            const dataRequestFrequency = document.getElementById('data-request-frequency');
            
            if (dataTypeSpec) dataTypeSpec.value = '';
            if (dataRequestFrequency) dataRequestFrequency.value = '';
            
            // Statutory
            document.querySelectorAll('input[name="statutory"]').forEach(r => r.checked = false);
            document.querySelectorAll('.statutory-option').forEach(cb => cb.checked = false);
            const statutoryOther = document.getElementById('statutory-other');
            if (statutoryOther) statutoryOther.value = '';
            
            // Agreement
            document.querySelectorAll('input[name="agreement"]').forEach(r => r.checked = false);
            const existingAgreement = document.getElementById('existing-agreement');
            if (existingAgreement) existingAgreement.checked = false;
            const agreementDesc = document.getElementById('agreement-desc');
            if (agreementDesc) agreementDesc.value = '';
            
            // Data Matching
            document.querySelectorAll('input[name="matching"]').forEach(r => r.checked = false);
            const matchingDesc = document.getElementById('matching-desc');
            if (matchingDesc) matchingDesc.value = '';
            
            // Meeting
            document.querySelectorAll('input[name="meeting"]').forEach(r => r.checked = false);
            const meetingDesc = document.getElementById('meeting-desc');
            if (meetingDesc) meetingDesc.value = '';
            
            // Location
            const regionSelect = document.getElementById('region');
            const districtSelect = document.getElementById('district');
            if (regionSelect) regionSelect.value = '';
            if (districtSelect) {
                districtSelect.value = '';
                districtSelect.disabled = true;
                districtSelect.innerHTML = '<option value="">Select District</option>';
            }
            
            // Other
            const definedPurpose = document.getElementById('defined-purpose');
            if (definedPurpose) definedPurpose.value = '';
            const comments = document.getElementById('comments');
            if (comments) comments.value = '';
        }
    </script>
</body>

</html>





































